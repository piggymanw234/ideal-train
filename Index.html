<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><title>DEAD WEST</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rye&family=IM+Fell+English:ital@0;1&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;overflow:hidden;font-family:'IM Fell English',serif;cursor:none;}
canvas{display:block;}
#xh{position:fixed;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);width:20px;height:20px;}
#xh::before,#xh::after{content:'';position:absolute;background:rgba(255,215,55,.82);}
#xh::before{width:1px;height:20px;left:9px;top:0;}
#xh::after{width:20px;height:1px;top:9px;left:0;}
#xhd{position:fixed;pointer-events:none;z-index:9999;width:3px;height:3px;border-radius:50%;background:#ffd030;transform:translate(-50%,-50%);}
#vg{position:fixed;inset:0;background:radial-gradient(ellipse at center,transparent 42%,rgba(0,0,0,.74)100%);pointer-events:none;z-index:5;}
#bs{position:fixed;inset:0;pointer-events:none;z-index:6;opacity:0;transition:opacity .07s;background:radial-gradient(ellipse at center,transparent 26%,rgba(100,0,0,.5)100%);}

/* ‚ïê‚ïê‚ïê INTRO ‚ïê‚ïê‚ïê */
#intro{position:fixed;inset:0;z-index:3000;background:#000000;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;}
.i-tag{font-size:8px;letter-spacing:18px;color:#f7b06a;margin-bottom:18px;animation:iUp .8s .2s both;}
.i-logo{font-family:'Rye',serif;font-size:70px;letter-spacing:12px;color:#ebb064;text-shadow:0 0 80px rgba(255, 255, 255, 0.45);animation:iUp .9s .65s both,iGlow 2.8s 1.8s infinite alternate;position:relative;}
.i-sub{font-size:8px;letter-spacing:13px;color:#ffffff;margin-top:9px;animation:iUp .7s 1.2s both;}
.i-line{width:0;height:1px;background:linear-gradient(90deg,transparent,#8a6020,transparent);margin:20px auto;animation:iLine .9s 1.7s forwards;}
.i-skip{position:absolute;bottom:22px;right:22px;font-size:7px;letter-spacing:6px;color:#ffffff;animation:iUp .5s 2.3s both;}
.i-stars{position:absolute;top:22px;left:0;right:0;text-align:center;font-size:8px;letter-spacing:9px;color:#ff5900;animation:iUp .6s 2s both;}
@keyframes iUp{from{opacity:0;transform:translateY(9px)}to{opacity:1;transform:translateY(0)}}
@keyframes iGlow{from{text-shadow:0 0 55px rgba(200,140,28,.38)}to{text-shadow:0 0 115px rgba(235, 169, 38, 0.822),45 55 35px rgba(255, 255, 255, 0.952)}}
@keyframes iLine{to{width:270px}}

/* ‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê */
#menu{position:fixed;inset:0;z-index:800;display:none;align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 55%,rgba(28,13,3,.98),rgba(3,2,1,.99));}
.m-wrap{display:flex;flex-direction:column;align-items:center;}
.m-tag{font-size:11px;letter-spacing:16px;color:#ce5b09;margin-bottom:7px;}
.m-title{font-family:'Rye',serif;font-size:56px;letter-spacing:10px;color:#ffffff;text-shadow:0 0 48px rgba(255, 255, 255, 0.28);margin-bottom:3px;}
.m-sub{font-size:12px;letter-spacing:11px;color:#f5ad40;margin-bottom:28px;}
.m-rule{width:250px;height:1px;background:linear-gradient(90deg,transparent,rgba(218, 135, 27, 0.3),transparent);margin-bottom:26px;}
.lobby{width:310px;border:1px solid rgba(228, 142, 13, 0.18);background:rgba(7,3,1,.96);padding:18px 20px 14px;margin-bottom:20px;}
.l-title{font-size:10px;letter-spacing:9px;color:#321604;text-align:center;margin-bottom:13px;padding-bottom:9px;border-bottom:1px solid rgba(90,52,8,.1);}
.field{margin-bottom:9px;}
.field label{display:block;font-size:10px;letter-spacing:7px;color:#da6811;margin-bottom:4px;}
.field input{width:100%;background:rgba(255, 255, 255, 0.92);border:none;border-bottom:1px solid rgba(0, 0, 0, 0.726);color:#000000;font-family:'IM Fell English',serif;font-size:12px;padding:5px 2px;outline:none;letter-spacing:3px;transition:border-color .2s;}
.field input:focus{border-bottom-color:rgba(170,110,25,.5);}
.field input::placeholder{color:#180c02;font-size:10px;letter-spacing:2px;}
.l-hint{font-size:10px;color:#fdfdfd;letter-spacing:2px;text-align:center;margin-top:3px;}
.l-status{font-size:11px;text-align:center;margin-top:5px;min-height:11px;letter-spacing:2px;}
.btn-row{display:flex;gap:6px;margin-top:12px;}
.btn{flex:1;font-family:'Rye',serif;background:transparent;border:1px solid rgba(255, 255, 255, 0.884);padding:9px 10px;font-size:7px;letter-spacing:6px;cursor:pointer;transition:all .2s;}
.btn-p{color:#ffe9e9;border-color:rgba(255, 255, 255, 0.42);}
.btn-p:hover{background:rgba(255, 255, 255, 0.1);border-color:rgba(195,135,35,.6);}
.btn-s{color:#ffffff;border-color:rgba(255, 255, 255, 0.18);}
.btn-s:hover{color:#ffffff;border-color:rgba(105,62,10,.35);}
.ctrl{display:grid;grid-template-columns:1fr 1fr;gap:3px 28px;}
.ctrl-r{font-size:7px;color:#ffffff;letter-spacing:3px;}
.ctrl-r b{color:#ffffff;font-weight:normal;}

/* ‚ïê‚ïê‚ïê DEATH ‚ïê‚ïê‚ïê */
#dead{position:fixed;inset:0;z-index:800;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.94);}
.d-title{font-family:'Rye',serif;color:#880000;font-size:50px;letter-spacing:8px;text-shadow:0 0 38px rgba(100,0,0,.5);margin-bottom:9px;}
.d-s{font-size:9px;color:#481e05;letter-spacing:4px;margin-bottom:4px;}
.d-p{font-size:8px;color:#941010;letter-spacing:3px;margin-bottom:28px;}

/* ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê */
#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
.pn{background:rgba(4,2,1,.93);border:1px solid rgba(135,90,18,.14);}
#hl{position:absolute;top:12px;left:12px;padding:8px 12px;min-width:162px;}
.hl-r{display:flex;justify-content:space-between;align-items:flex-end;}
.lb{font-size:6px;letter-spacing:5px;color:#381e05;margin-bottom:2px;}
.vl{font-family:'Rye',serif;color:#e8c87a;font-size:14px;}
#xpb{width:100%;height:2px;background:rgba(255,255,255,.04);margin-top:4px;}
#xpf{height:100%;background:linear-gradient(90deg,#783a05,#d2a628);}
#xpt{font-size:5px;color:#2c1804;letter-spacing:2px;margin-top:2px;}
#hm{position:absolute;bottom:12px;left:12px;padding:7px 12px;}
#hmv{font-family:'Rye',serif;color:#dbc838;font-size:16px;}
#hk{position:absolute;bottom:12px;left:125px;padding:7px 10px;}
#hkv{font-family:'Rye',serif;color:#48aa48;font-size:12px;}
#hkl{font-size:5px;color:#245018;letter-spacing:2px;margin-top:1px;}
#hg{position:absolute;top:12px;right:12px;padding:8px 12px;min-width:145px;text-align:right;}
#gn{font-family:'Rye',serif;color:#e8c87a;font-size:10px;letter-spacing:2px;margin-bottom:2px;}
#ga{font-size:6px;color:#583a05;letter-spacing:2px;margin-bottom:4px;font-style:italic;}
#pp{margin-bottom:2px;min-height:12px;}
.pip{display:inline-block;width:5px;height:10px;background:#dbb834;margin:0 1px;border-radius:1px 1px 0 0;vertical-align:middle;}
.pip.e{background:#140902;border:1px solid #200f02;}
.pip.sg{width:7px;background:#a85e0e;}
.pip.sg.e{background:#1c0b02;}
#ar{font-size:6px;color:#382404;letter-spacing:2px;}
#cdb{width:100%;height:1px;background:rgba(255,255,255,.04);margin-top:3px;}
#cdf{height:100%;background:#885618;}
#hh{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);padding:6px 14px;text-align:center;}
#hbt{width:175px;height:4px;background:rgba(255,255,255,.04);border:1px solid rgba(130,38,22,.1);margin-top:3px;}
#hbf{height:100%;background:linear-gradient(90deg,#620000,#b40c12);}
#hw{position:absolute;bottom:12px;right:12px;padding:6px 11px;text-align:right;border-color:rgba(125,22,18,.14);}
#ws{font-size:13px;color:#a81212;letter-spacing:2px;}
#wl{font-size:5px;letter-spacing:5px;color:#381210;margin-bottom:2px;}
#wdb{width:100%;height:1px;background:rgba(255,255,255,.04);margin-top:2px;}
#wdf{height:100%;background:#961010;}
#lc{position:absolute;top:12px;left:50%;transform:translateX(-50%);text-align:center;opacity:0;transition:opacity .5s;pointer-events:none;}
#ln{font-family:'Rye',serif;color:#e8c87a;font-size:13px;letter-spacing:7px;text-shadow:0 0 15px rgba(195,135,38,.5);}
#ls{font-size:6px;color:#583808;letter-spacing:4px;}
#mst{position:absolute;top:38px;left:50%;transform:translateX(-50%);font-size:6px;letter-spacing:3px;color:#263416;pointer-events:none;}
.fl{position:absolute;left:50%;transform:translateX(-50%);font-family:'Rye',serif;letter-spacing:5px;opacity:0;transition:opacity .14s;pointer-events:none;}
#fk{top:44%;color:#c89c12;font-size:11px;}
#fb{top:40%;color:#e8c87a;font-size:15px;}
#fp{top:36%;color:#3a78ee;font-size:12px;}
#ft{top:32%;color:#d08c18;font-size:12px;}
#rlw{position:absolute;bottom:65px;left:50%;transform:translateX(-50%);text-align:center;opacity:0;pointer-events:none;}
#rll{font-size:6px;color:#e8c87a;letter-spacing:6px;margin-bottom:3px;}
#rlt{width:94px;height:2px;background:rgba(255,255,255,.04);margin:0 auto;}
#rlf{height:100%;background:#e8c87a;width:0%;}
#trb{position:absolute;top:25%;left:50%;transform:translateX(-50%);background:rgba(4,2,1,.94);border:1px solid rgba(145,78,14,.34);padding:10px 22px;opacity:0;transition:opacity .3s;pointer-events:none;text-align:center;}
#trt{font-family:'Rye',serif;color:#d08c18;font-size:12px;letter-spacing:5px;margin-bottom:2px;}
#trh{font-size:7px;color:#483005;letter-spacing:3px;}
#tip{position:absolute;bottom:48px;left:50%;transform:translateX(-50%);font-size:6px;color:#201202;letter-spacing:2px;pointer-events:none;white-space:nowrap;}
#mmw{position:absolute;bottom:70px;right:12px;pointer-events:none;}
#mmc{border:1px solid rgba(135,90,18,.2);}
#mml{font-size:5px;color:#201002;letter-spacing:2px;text-align:center;margin-top:2px;}

/* ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê */
#chat{position:fixed;bottom:82px;left:12px;width:245px;z-index:20;pointer-events:none;}
#cmsg{display:flex;flex-direction:column;gap:2px;max-height:108px;overflow:hidden;justify-content:flex-end;}
.cm{background:rgba(3,2,1,.8);border-left:1px solid rgba(115,72,10,.18);padding:2px 6px;font-size:18px;color:#887228;animation:cmf 9s forwards;}
.cm .cn{color:#ffffff;margin-right:4px;}
.cm.sys{color:#2c4220;border-left-color:rgba(35,58,18,.18);}
@keyframes cmf{0%,55%{opacity:1}100%{opacity:0}}
#ci{pointer-events:all;display:none;background:rgba(4,2,1,.94);border:1px solid rgba(135,90,18,.2);padding:4px 8px;align-items:center;gap:5px;}
#ci.on{display:flex;}
#cip{font-size:6px;color:#482a05;letter-spacing:4px;}
#cif{flex:1;background:transparent;border:none;color:#e8c87a;font-family:'IM Fell English',serif;font-size:10px;outline:none;}

/* ‚ïê‚ïê‚ïê GUN SHOP ‚ïê‚ïê‚ïê */
#gso{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:60;pointer-events:all;}
#gsb{background:rgba(4,2,1,.98);border:1px solid rgba(135,90,18,.22);width:800px;max-width:95vw;max-height:88vh;overflow-y:auto;}
.sh{padding:15px 22px 9px;border-bottom:1px solid rgba(95,58,8,.1);text-align:center;}
.sh h2{font-family:'Rye',serif;color:#e8c87a;font-size:15px;letter-spacing:8px;margin-bottom:2px;}
.sh p{font-size:6px;color:#482a05;letter-spacing:6px;}
#gsm{font-family:'Rye',serif;color:#dbc838;font-size:10px;margin-top:4px;}
#gstabs{display:flex;padding:0 22px;border-bottom:1px solid rgba(95,58,8,.1);}
.stab{font-family:'Rye',serif;color:#1c1001;background:transparent;border:none;border-bottom:2px solid transparent;padding:8px 13px;font-size:6px;letter-spacing:6px;cursor:pointer;transition:all .2s;}
.stab:hover,.stab.on{color:#e8c87a;border-bottom-color:#624010;}
#gsgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:11px 22px 15px;}
.gc{background:rgba(6,3,1,.92);border:1px solid rgba(55,35,6,.24);padding:8px 6px;cursor:pointer;transition:border-color .2s;text-align:center;position:relative;}
.gc:hover:not(.lk){border-color:rgba(145,95,18,.36);}
.gc.eq{border-color:rgba(165,110,22,.52);}
.gc.lk{opacity:.34;cursor:not-allowed;}
.gpx{display:block;margin:0 auto 5px;image-rendering:pixelated;background:#040201;}
.gn{font-family:'Rye',serif;color:#e8c87a;font-size:7px;letter-spacing:2px;margin-bottom:2px;}
.gd{font-size:5px;color:#382204;letter-spacing:1px;font-style:italic;margin-bottom:3px;}
.gst{display:grid;grid-template-columns:1fr 1fr;gap:1px 4px;margin-bottom:3px;}
.gst div{font-size:5px;color:#221402;letter-spacing:1px;}
.gst span{color:#644810;}
.gp{font-family:'Rye',serif;font-size:8px;color:#dbc838;}
.gbdg{position:absolute;top:2px;right:2px;font-size:5px;padding:1px 3px;}
.gbdg.o{background:rgba(32,95,32,.13);color:#3e9e3e;border:1px solid rgba(32,95,32,.2);}
.gbdg.e{background:rgba(145,95,18,.13);color:#e8c87a;border:1px solid rgba(145,95,18,.22);}
.scl{font-family:'Rye',serif;color:#382005;border:1px solid rgba(75,45,7,.26);background:transparent;padding:6px 26px;font-size:6px;letter-spacing:6px;cursor:pointer;display:block;margin:0 auto 13px;transition:all .2s;}
.scl:hover{color:#e8c87a;border-color:#624010;}

/* ‚ïê‚ïê‚ïê ADMIN HUD BUTTON ‚ïê‚ïê‚ïê */
#adm-hud-btn{position:fixed;top:50%;right:0;transform:translateY(-50%);z-index:500;pointer-events:all;display:none;flex-direction:column;align-items:center;}
#adm-arrow{background:linear-gradient(135deg,rgba(40,0,80,.95),rgba(20,0,50,.98));border:1px solid rgba(180,50,255,.6);border-right:none;padding:10px 8px 10px 10px;cursor:pointer;transition:all .2s;position:relative;}
#adm-arrow:hover{background:linear-gradient(135deg,rgba(80,0,160,.95),rgba(40,0,100,.98));border-color:#cc66ff;box-shadow:-4px 0 20px rgba(150,50,255,.4);}
#adm-arrow-icon{color:#cc66ff;font-size:16px;text-shadow:0 0 10px rgba(200,100,255,.8);animation:admPulse 1.8s infinite alternate;}
#adm-arrow-label{font-size:5px;color:#8844aa;letter-spacing:2px;text-align:center;margin-top:3px;font-family:'IM Fell English',serif;}
@keyframes admPulse{from{text-shadow:0 0 8px rgba(180,50,255,.5)}to{text-shadow:0 0 20px rgba(220,100,255,1),0 0 40px rgba(180,50,255,.5)}}

/* ‚ïê‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê‚ïê */
#adm{position:fixed;inset:0;background:rgba(0,0,0,.93);display:none;align-items:center;justify-content:center;z-index:900;pointer-events:all;}
#admb{background:rgba(2,1,6,.99);border:1px solid rgba(180,50,255,.3);width:480px;max-width:95vw;padding:0 0 18px;}
.adm-h{padding:14px 22px 10px;border-bottom:1px solid rgba(180,50,255,.18);text-align:center;}
.adm-h h2{font-family:'Rye',serif;color:#cc66ff;font-size:16px;letter-spacing:8px;margin-bottom:2px;text-shadow:0 0 20px rgba(180,50,255,.5);}
.adm-h p{font-size:6px;color:#6a3088;letter-spacing:6px;}
.adm-row{display:flex;align-items:center;justify-content:space-between;padding:8px 22px;border-bottom:1px solid rgba(90,30,120,.1);}
.adm-label{font-size:7px;color:#aa88cc;letter-spacing:4px;}
.adm-val{font-family:'Rye',serif;color:#cc66ff;font-size:10px;}
.adm-btn{font-family:'Rye',serif;background:rgba(120,30,180,.2);border:1px solid rgba(180,50,255,.3);color:#cc66ff;padding:5px 12px;font-size:6px;letter-spacing:4px;cursor:pointer;transition:all .2s;}
.adm-btn:hover{background:rgba(180,50,255,.3);border-color:rgba(220,100,255,.5);}
.adm-btn-row{display:flex;gap:6px;padding:10px 22px 0;flex-wrap:wrap;}
.adm-close{position:absolute;top:10px;right:14px;background:transparent;border:none;color:#6a3088;font-size:12px;cursor:pointer;letter-spacing:2px;font-family:'IM Fell English',serif;}

/* ‚ïê‚ïê‚ïê CLOTHING STORE ‚ïê‚ïê‚ïê */
#clth{position:fixed;inset:0;background:rgba(0,0,0,.93);display:none;align-items:center;justify-content:center;z-index:60;pointer-events:all;}
#clthb{background:linear-gradient(160deg,rgba(12,6,2,.99),rgba(6,2,1,.99));border:1px solid rgba(200,140,50,.3);width:820px;max-width:97vw;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;}
.clth-h{padding:14px 22px 10px;border-bottom:1px solid rgba(180,120,30,.18);text-align:center;background:linear-gradient(180deg,rgba(30,15,3,.6),transparent);}
.clth-h h2{font-family:'Rye',serif;color:#e8c87a;font-size:16px;letter-spacing:8px;margin-bottom:2px;text-shadow:0 0 20px rgba(200,160,50,.5);}
.clth-h p{font-size:6px;color:#6a4808;letter-spacing:6px;}
.clth-money{font-family:'Rye',serif;color:#dbc838;font-size:11px;margin-top:4px;}
.clth-body{display:flex;flex:1;overflow:hidden;gap:0;}
/* Avatar panel */
.clth-avatar-panel{width:220px;min-width:220px;border-right:1px solid rgba(180,120,30,.15);padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;background:rgba(4,2,1,.4);}
.clth-avatar-wrap{position:relative;}
#clth-canvas{border:1px solid rgba(180,120,30,.2);background:rgba(2,1,0,.8);}
.clth-name-tag{font-family:'Rye',serif;color:#e8c87a;font-size:9px;letter-spacing:3px;text-align:center;margin-top:4px;}
.clth-equipped{font-size:6px;color:#5a3808;letter-spacing:2px;text-align:center;margin-top:2px;line-height:1.6;}
/* Shop panel */
.clth-shop-panel{flex:1;overflow-y:auto;padding:12px 16px;}
.clth-tabs{display:flex;border-bottom:1px solid rgba(180,120,30,.15);margin-bottom:10px;}
.clth-tab{font-family:'Rye',serif;color:#3a2004;background:transparent;border:none;border-bottom:2px solid transparent;padding:7px 12px;font-size:6px;letter-spacing:5px;cursor:pointer;transition:all .2s;}
.clth-tab:hover,.clth-tab.on{color:#e8c87a;border-bottom-color:#8a5818;}
.clth-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.clth-item{background:rgba(6,3,1,.9);border:1px solid rgba(80,50,10,.3);padding:8px 7px;cursor:pointer;transition:all .2s;text-align:center;position:relative;}
.clth-item:hover:not(.clth-owned-active){border-color:rgba(180,120,30,.5);background:rgba(12,6,2,.9);}
.clth-item.clth-owned-active{border-color:rgba(200,160,50,.6);box-shadow:0 0 10px rgba(200,160,50,.15);}
.clth-item.clth-locked{opacity:.38;cursor:not-allowed;}
.clth-swatch{width:100%;height:28px;border-radius:2px;margin-bottom:5px;display:flex;align-items:center;justify-content:center;font-size:14px;}
.clth-iname{font-family:'Rye',serif;color:#e8c87a;font-size:6px;letter-spacing:2px;margin-bottom:2px;}
.clth-iprice{font-size:6px;color:#a87830;letter-spacing:2px;}
.clth-iprice.free{color:#3e9e3e;}
.clth-iprice.owned{color:#3e9e3e;}
.clth-badge{position:absolute;top:2px;right:2px;font-size:5px;padding:1px 3px;background:rgba(32,95,32,.2);color:#5ebe5e;border:1px solid rgba(32,95,32,.3);}
.clth-close-btn{font-family:'Rye',serif;background:transparent;border:1px solid rgba(180,120,30,.3);color:#8a6020;padding:7px 24px;font-size:6px;letter-spacing:6px;cursor:pointer;margin:10px auto;display:block;transition:all .2s;}
.clth-close-btn:hover{color:#e8c87a;border-color:#a87830;}

/* ‚ïê‚ïê‚ïê NAVIS CODE PROMPT ‚ïê‚ïê‚ïê */
#ncode{position:fixed;inset:0;background:rgba(0,0,0,.96);display:none;align-items:center;justify-content:center;z-index:200;pointer-events:all;}
#ncodeb{background:rgba(2,0,10,.99);border:1px solid rgba(180,50,255,.5);padding:28px 32px;text-align:center;box-shadow:0 0 60px rgba(140,30,255,.3),inset 0 0 40px rgba(80,0,180,.08);max-width:380px;width:90vw;}
#ncode-title{font-family:'Rye',serif;color:#cc66ff;font-size:18px;letter-spacing:8px;margin-bottom:4px;text-shadow:0 0 30px rgba(200,80,255,.8);}
#ncode-sub{font-size:6px;color:#6a3088;letter-spacing:6px;margin-bottom:20px;}
#ncode-badge{font-size:36px;margin-bottom:12px;animation:nPulse 1.4s infinite alternate;}
@keyframes nPulse{from{text-shadow:0 0 10px #aa44ff}to{text-shadow:0 0 40px #ff44ff,0 0 80px #8800ff}}
#ncode-hint{font-size:7px;color:#9944cc;letter-spacing:4px;margin-bottom:14px;}
#ncode-input{width:100%;background:rgba(30,0,60,.8);border:none;border-bottom:2px solid rgba(180,50,255,.5);color:#cc66ff;font-family:'Rye',serif;font-size:22px;padding:8px 4px;outline:none;letter-spacing:12px;text-align:center;}
#ncode-input:focus{border-bottom-color:#cc66ff;}
#ncode-err{font-size:7px;color:#ff4444;letter-spacing:4px;min-height:14px;margin-top:8px;animation:nShake .3s;}
@keyframes nShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
#ncode-hint2{font-size:6px;color:#3a1060;letter-spacing:3px;margin-top:10px;cursor:pointer;}
#ncode-hint2:hover{color:#6a3088;}

/* ‚ïê‚ïê‚ïê CASINO ‚ïê‚ïê‚ïê */
@keyframes casinoGlow{0%,100%{box-shadow:0 0 40px rgba(212,170,0,.4),0 0 80px rgba(180,50,255,.2),inset 0 0 60px rgba(10,0,30,.6)}50%{box-shadow:0 0 70px rgba(212,170,0,.6),0 0 120px rgba(180,50,255,.35),inset 0 0 60px rgba(10,0,30,.6)}}
@keyframes marquee{0%{background-position:0 0}100%{background-position:60px 0}}
@keyframes cardFlip{from{transform:rotateY(90deg) scale(.8);opacity:0}to{transform:rotateY(0deg) scale(1);opacity:1}}
@keyframes chipBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.18) rotate(-5deg)}}
@keyframes resultPop{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes neonFlicker{0%,100%{opacity:1}92%{opacity:1}93%{opacity:.4}96%{opacity:1}97%{opacity:.6}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
#casino{position:fixed;inset:0;background:radial-gradient(ellipse at 50% 30%,rgba(40,0,80,.98),rgba(0,0,0,.99));display:none;align-items:center;justify-content:center;z-index:60;pointer-events:all;}
#casino::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 28px,rgba(120,0,255,.04) 28px,rgba(120,0,255,.04) 29px),repeating-linear-gradient(90deg,transparent,transparent 28px,rgba(120,0,255,.04) 28px,rgba(120,0,255,.04) 29px);pointer-events:none;}
#casinob{background:linear-gradient(160deg,rgba(8,2,22,.99),rgba(3,0,12,.99));border:2px solid rgba(212,170,0,.5);width:680px;max-width:96vw;padding:0;position:relative;animation:casinoGlow 2.8s ease-in-out infinite;}
#casinob::before{content:'';position:absolute;top:-1px;left:10%;right:10%;height:2px;background:linear-gradient(90deg,transparent,#d4aa00,#ff44ff,#44ffff,#d4aa00,transparent);animation:marquee 2s linear infinite;}
.cas-h{padding:18px 22px 12px;border-bottom:2px solid rgba(212,170,0,.2);text-align:center;background:linear-gradient(180deg,rgba(40,0,80,.5),transparent);position:relative;overflow:hidden;}
.cas-h::after{content:'‚ô† ‚ô• ‚ô¶ ‚ô£ ‚ô† ‚ô• ‚ô¶ ‚ô£ ‚ô† ‚ô• ‚ô¶ ‚ô£';position:absolute;bottom:4px;left:0;right:0;font-size:9px;color:rgba(212,170,0,.15);letter-spacing:8px;text-align:center;}
.cas-title-wrap{position:relative;display:inline-block;}
.cas-h h2{font-family:'Rye',serif;color:#d4aa00;font-size:20px;letter-spacing:10px;margin-bottom:4px;text-shadow:0 0 30px rgba(212,170,0,.9),0 0 60px rgba(212,170,0,.4);animation:neonFlicker 4s infinite;}
.cas-h h2 .suit-r{color:#ff4444;text-shadow:0 0 20px rgba(255,60,60,.8);}
.cas-h p{font-size:7px;color:#8a6820;letter-spacing:7px;}
.cas-money{font-family:'Rye',serif;font-size:13px;margin-top:6px;background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 8px rgba(212,170,0,.6));}
#bj-area{padding:14px 20px 16px;}
#bj-status{font-family:'Rye',serif;color:#e8c87a;font-size:12px;text-align:center;letter-spacing:5px;min-height:22px;margin-bottom:8px;text-shadow:0 0 10px rgba(232,200,122,.4);}
.bj-section{background:rgba(0,20,0,.6);border:1px solid rgba(30,100,30,.3);border-radius:4px;padding:10px 14px;margin-bottom:10px;}
.bj-hand-label{font-size:7px;color:rgba(212,170,0,.7);letter-spacing:6px;margin-bottom:8px;text-align:center;text-transform:uppercase;}
.bj-cards{display:flex;gap:8px;flex-wrap:wrap;min-height:86px;margin-bottom:6px;align-items:center;}
.bj-card{width:56px;height:80px;background:linear-gradient(145deg,#ffffff,#f0f0f0);border-radius:6px;border:1px solid #bbb;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:20px;font-weight:bold;font-family:Georgia,serif;position:relative;box-shadow:3px 3px 12px rgba(0,0,0,.7),0 0 8px rgba(212,170,0,.2);animation:cardFlip .35s ease-out both;}
.bj-card.red{color:#cc0000;}
.bj-card.blk{color:#111;}
.bj-card.back{background:linear-gradient(135deg,#2a006a,#0a0020);border:2px solid rgba(180,80,255,.6);box-shadow:3px 3px 12px rgba(0,0,0,.8),0 0 18px rgba(140,30,255,.4);}
.bj-card.back::before{content:'';position:absolute;inset:4px;border:1px solid rgba(180,80,255,.3);border-radius:3px;}
.bj-card.back::after{content:'‚ô¶';color:rgba(180,80,255,.8);font-size:26px;text-shadow:0 0 12px rgba(180,80,255,.8);}
.bj-corner{position:absolute;font-size:10px;line-height:1;}
.bj-corner.tl{top:4px;left:5px;}
.bj-corner.br{bottom:4px;right:5px;transform:rotate(180deg);}
.bj-center{font-size:26px;}
.bj-score{font-size:8px;letter-spacing:3px;margin-top:2px;text-align:center;}
.bj-score.ok{color:rgba(100,200,100,.8);}
.bj-score.warn{color:rgba(255,200,50,.9);}
.bj-score.bust{color:#ff4444;text-shadow:0 0 8px rgba(255,0,0,.6);}
#bj-bet-row{display:flex;align-items:center;gap:10px;margin-bottom:12px;justify-content:center;flex-wrap:wrap;padding:10px;background:rgba(0,0,0,.3);border:1px solid rgba(212,170,0,.1);border-radius:4px;}
.bet-chip{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-family:'Rye',serif;font-size:9px;font-weight:bold;transition:all .18s;position:relative;border:3px solid;}
.bet-chip::before{content:'';position:absolute;inset:4px;border-radius:50%;border:1px dashed rgba(255,255,255,.3);}
.bet-chip:hover{animation:chipBounce .4s ease;}
.bet-chip:active{transform:scale(.9);}
.bet-chip.c10{background:radial-gradient(circle at 35% 35%,#4a9a3a,#1a5a0a);color:#aaffaa;border-color:#6aff6a;box-shadow:0 0 12px rgba(50,200,50,.4);}
.bet-chip.c50{background:radial-gradient(circle at 35% 35%,#2a4aaa,#0a1a6a);color:#aaccff;border-color:#6699ff;box-shadow:0 0 12px rgba(50,100,255,.4);}
.bet-chip.c100{background:radial-gradient(circle at 35% 35%,#aa2a2a,#6a0a0a);color:#ffaaaa;border-color:#ff6666;box-shadow:0 0 12px rgba(255,50,50,.4);}
.bet-chip.c500{background:radial-gradient(circle at 35% 35%,#8a2a9a,#4a0a6a);color:#ffaaff;border-color:#ff66ff;box-shadow:0 0 15px rgba(255,50,255,.5);}
.bet-divider{width:1px;height:44px;background:linear-gradient(180deg,transparent,rgba(212,170,0,.3),transparent);}
.bet-info{display:flex;flex-direction:column;align-items:center;gap:4px;}
.bet-info-label{font-size:6px;color:#6a5010;letter-spacing:3px;}
#bj-curbetv{font-family:'Rye',serif;font-size:15px;background:linear-gradient(90deg,#b8860b,#ffd700,#b8860b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 6px rgba(212,170,0,.5));}
.bj-btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px;}
.bj-btn{font-family:'Rye',serif;background:linear-gradient(180deg,rgba(40,28,4,.8),rgba(20,12,0,.9));border:1px solid rgba(212,180,50,.5);color:#dbc838;padding:9px 18px;font-size:7px;letter-spacing:5px;cursor:pointer;transition:all .18s;position:relative;overflow:hidden;}
.bj-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,220,80,.08),transparent);pointer-events:none;}
.bj-btn:hover:not(:disabled){background:linear-gradient(180deg,rgba(80,60,8,.9),rgba(40,28,4,.9));border-color:#ffd700;box-shadow:0 0 14px rgba(212,180,50,.3);color:#ffd700;transform:translateY(-1px);}
.bj-btn:active:not(:disabled){transform:translateY(1px);}
.bj-btn:disabled{opacity:.25;cursor:not-allowed;}
.bj-btn.danger{background:linear-gradient(180deg,rgba(40,4,4,.8),rgba(20,0,0,.9));border-color:rgba(200,50,50,.5);color:#e85858;}
.bj-btn.danger:hover:not(:disabled){border-color:#ff4444;box-shadow:0 0 14px rgba(255,50,50,.3);color:#ff6666;}
.bj-btn.highlight{border-color:rgba(50,200,50,.6);color:#88ff88;}
.bj-btn.highlight:hover:not(:disabled){border-color:#44ff44;box-shadow:0 0 14px rgba(50,255,50,.3);}
#bj-result{font-family:'Rye',serif;font-size:16px;text-align:center;min-height:26px;letter-spacing:5px;margin-top:10px;animation:resultPop .4s ease-out both;}
.bj-lights{display:flex;justify-content:center;gap:8px;padding:6px 0 2px;}
.bj-light{width:8px;height:8px;border-radius:50%;animation:blink 1s infinite;}
.bj-light:nth-child(odd){background:#ffd700;box-shadow:0 0 6px #ffd700;animation-delay:.5s;}
.bj-light:nth-child(even){background:#ff44ff;box-shadow:0 0 6px #ff44ff;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* ‚ïê‚ïê‚ïê GENERAL STORE ‚ïê‚ïê‚ïê */
#sto{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:60;pointer-events:all;}
#stob{background:rgba(4,2,1,.98);border:1px solid rgba(38,95,32,.18);width:370px;max-width:95vw;}
.si{background:rgba(5,9,3,.9);border:1px solid rgba(32,80,28,.16);padding:10px 13px;display:flex;align-items:center;gap:10px;margin:0 16px 6px;cursor:pointer;transition:border-color .2s;}
.si:hover:not(.sd){border-color:rgba(46,120,40,.28);}
.si.sd{opacity:.38;cursor:not-allowed;}
.sic{font-size:23px;}
.sin h3{font-family:'Rye',serif;color:#da611b;font-size:9px;letter-spacing:2px;margin-bottom:2px;}
.sin p{font-size:6px;color:#1c3012;letter-spacing:1px;}
.sir{font-size:5px;color:#482805;letter-spacing:2px;margin-top:2px;}
.sip{font-family:'Rye',serif;color:#dbc838;font-size:12px;margin-left:auto;}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="xh"></div><div id="xhd"></div>
<div id="vg"></div><div id="bs"></div>

<!-- INTRO -->
<div id="intro">
  <div class="i-stars">‚ú¶ &nbsp;&nbsp; ‚ú¶ &nbsp;&nbsp; ‚ú¶</div>
  <div class="i-tag">NAVIS GAMES PRESENTS</div>
  <div class="i-logo">DEAD WEST</div>
  <div class="i-sub">OPEN WORLD BOUNTY HUNTER</div>
  <div class="i-line"></div>
  <div class="i-skip">CLICK TO SKIP ‚Üí</div>
</div>

<!-- MENU -->
<div id="menu">
  <div class="m-wrap">
    <div class="m-tag">NAVIS GAMES PRESENTS</div>
    <div class="m-title">DEAD WEST</div>
    <div class="m-sub">OPEN WORLD BOUNTY HUNTER</div>
    <div class="m-rule"></div>
    <div class="lobby">
      <div class="l-title">‚ö° MULTIPLAYER LOBBY</div>
      <div class="field"><label>YOUR NAME</label><input id="mpname" maxlength="14" placeholder="e.g. JESSE OUTLAW" spellcheck="false" autocomplete="off"></div>
      <div class="field"><label>ROOM CODE</label><input id="mproom" maxlength="10" placeholder="e.g. DUSTY1 ‚Äî share with friends" spellcheck="false" autocomplete="off"></div>
      <div class="l-hint">same code = same world</div>
      <div class="l-status" id="mpstat"></div>
      <div class="btn-row">
        <button class="btn btn-p" onclick="joinMP()">JOIN GAME</button>
        <button class="btn btn-s" onclick="soloStart()">SOLO RIDE</button>
      </div>
    </div>
    <div class="ctrl">
      <div class="ctrl-r"><b>WASD</b> MOVE</div><div class="ctrl-r"><b>MOUSE</b> AIM</div>
      <div class="ctrl-r"><b>CLICK</b> SHOOT</div><div class="ctrl-r"><b>R</b> RELOAD</div>
      <div class="ctrl-r"><b>SHIFT</b> DASH</div><div class="ctrl-r"><b>E</b> SHOP</div>
      <div class="ctrl-r"><b>F</b> MEDKIT</div><div class="ctrl-r"><b>T</b> CHAT</div>
      <div class="ctrl-r"><b>G</b> ROB TRAIN</div><div class="ctrl-r"><b>RMB</b> SPECIAL</div>
    </div>
  </div>
</div>

<!-- DEATH -->
<div id="dead">
  <div class="d-title">YOU DIED</div>
  <div class="d-s" id="dsub"></div>
  <div class="d-p" id="dpen"></div>
  <button class="btn btn-p" style="width:175px;pointer-events:all" onclick="restartGame()">RIDE AGAIN</button>
</div>

<!-- HUD -->
<div id="hud">
  <div class="pn" id="hl">
    <div class="hl-r">
      <div><div class="lb">BOUNTY HUNTER</div><div class="vl" id="lvv">LVL 1</div></div>
      <div style="text-align:right"><div class="lb">HP</div><div class="vl" id="hpn">100</div></div>
    </div>
    <div id="xpb"><div id="xpf" style="width:0%"></div></div>
    <div id="xpt">0 / 100 XP</div>
  </div>
  <div id="lc"><div id="ln"></div><div id="ls"></div></div>
  <div id="mst">‚óè SOLO</div>
  <div class="pn" id="hg">
    <div class="lb">EQUIPPED</div><div id="gn">PEACEMAKER</div>
    <div id="ga">Reliable 6-Shot</div>
    <div id="pp"></div><div id="ar"></div>
    <div id="cdb"><div id="cdf" style="width:0%"></div></div>
  </div>
  <div class="pn" id="hm"><div class="lb">EARNINGS</div><div id="hmv">$0</div></div>
  <div class="pn" id="hk"><div class="lb">MEDKITS</div><div id="hkv">‚úö 0</div><div id="hkl">[F]USE</div></div>
  <div class="pn" id="hh"><div class="lb">HEALTH</div><div id="hbt"><div id="hbf" style="width:100%"></div></div></div>
  <div class="pn" id="hw"><div id="wl">WANTED</div><div id="ws">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div><div id="wdb"><div id="wdf" style="width:100%"></div></div></div>
  <div class="fl" id="fk"></div><div class="fl" id="fb"></div><div class="fl" id="fp"></div><div class="fl" id="ft"></div>
  <div id="rlw"><div id="rll">‚Äî RELOADING ‚Äî</div><div id="rlt"><div id="rlf"></div></div></div>
  <div id="trb"><div id="trt">üöÇ TRAIN!</div><div id="trh">[G] TO ROB</div></div>
  <div id="tip">[E]SHOP ¬∑ [F]MEDKIT ¬∑ [G]ROB TRAIN ¬∑ [T]CHAT ¬∑ [SHIFT]DASH ¬∑ [E]THE HARBOUR=ADMIN (if admin)</div>
  <div id="mmw"><canvas id="mmc" width="146" height="146"></canvas><div id="mml">‚óè BOUNTY ¬∑ ‚óè LAW ¬∑ üöÇ TRAIN</div></div>
</div>

<!-- CHAT -->
<div id="chat">
  <div id="cmsg"></div>
  <div id="ci"><span id="cip">SAY:</span><input id="cif" maxlength="80" placeholder="‚Ä¶" spellcheck="false" autocomplete="off"></div>
</div>

<!-- GUN SHOP -->
<div id="gso">
  <div id="gsb">
    <div class="sh"><h2>GUN SHOP</h2><p>FINEST IRON IN THE TERRITORY</p><div id="gsm"></div></div>
    <div id="gstabs">
      <button class="stab on" onclick="setTab('pistols',this)">PISTOLS</button>
      <button class="stab" onclick="setTab('shotguns',this)">SHOTGUNS</button>
      <button class="stab" onclick="setTab('rifles',this)">RIFLES</button>
    </div>
    <div id="gsgrid"></div>
    <button class="scl" onclick="closeShop()">HOLSTER UP</button>
  </div>
</div>

<!-- GENERAL STORE -->
<div id="sto">
  <div id="stob">
    <div class="sh"><h2 style="color:#42b842;font-size:14px">GENERAL STORE</h2><p>FRONTIER SUPPLIES</p><div id="stom" style="font-family:'Rye',serif;color:#dbc838;font-size:10px;margin-top:4px"></div></div>
    <div id="stolist" style="padding:6px 0 2px"></div>
    <button class="scl" onclick="closeGStore()">SADDLE UP</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adm">
  <div id="admb" style="position:relative">
    <div class="adm-h">
      <h2>‚ö° ADMIN PANEL ‚ö°</h2>
      <p>NAVIS DEVELOPER ACCESS</p>
    </div>
    <div class="adm-row"><span class="adm-label">PLAYER MONEY</span><span class="adm-val" id="adm-money">$0</span></div>
    <div class="adm-row"><span class="adm-label">PLAYER LEVEL</span><span class="adm-val" id="adm-level">1</span></div>
    <div class="adm-row"><span class="adm-label">PLAYER HP</span><span class="adm-val" id="adm-hp">100/100</span></div>
    <div class="adm-row"><span class="adm-label">WANTED STARS</span><span class="adm-val" id="adm-wanted">0</span></div>
    <div class="adm-btn-row">
      <button class="adm-btn" onclick="admAddMoney(1000)">+$1,000</button>
      <button class="adm-btn" onclick="admAddMoney(10000)">+$10,000</button>
      <button class="adm-btn" onclick="admAddMoney(100000)">+$100,000</button>
      <button class="adm-btn" onclick="admFullHeal()">FULL HEAL</button>
      <button class="adm-btn" onclick="admClearWanted()">CLEAR WANTED</button>
      <button class="adm-btn" onclick="admAddXP(500)">+500 XP</button>
      <button class="adm-btn" onclick="admUnlockAll()">UNLOCK ALL GUNS</button>
      <button class="adm-btn" onclick="admAddMedkits()">+10 MEDKITS</button>
      <button class="adm-btn" onclick="admGodMode()">GOD MODE</button>
      <button class="adm-btn" onclick="admKillAll()">KILL ALL ENEMIES</button>
      <button class="adm-btn" style="background:linear-gradient(90deg,rgba(255,0,0,.3),rgba(255,165,0,.3),rgba(0,255,0,.3),rgba(0,0,255,.3),rgba(180,0,255,.3));border-color:#fff;color:#fff;text-shadow:0 0 8px #fff" onclick="admGiveRainbowGun()">‚ö° RAINBOW GUN</button>
    </div>
    <button class="adm-close" onclick="closeAdmin()">‚úï CLOSE</button>
  </div>
</div>

<!-- ADMIN HUD ARROW -->
<div id="adm-hud-btn">
  <div id="adm-arrow" onclick="openAdmin()">
    <div id="adm-arrow-icon">‚óÄ ‚ö°</div>
    <div id="adm-arrow-label">ADMIN</div>
  </div>
</div>

<!-- CLOTHING STORE -->
<div id="clth">
  <div id="clthb">
    <div class="clth-h">
      <h2>üëó FRONTIER TAILOR</h2>
      <p>FINEST GARMENTS IN THE TERRITORY</p>
      <div class="clth-money" id="clth-money">$0</div>
    </div>
    <div class="clth-body">
      <div class="clth-avatar-panel">
        <canvas id="clth-canvas" width="140" height="180"></canvas>
        <div class="clth-name-tag" id="clth-pname">OUTLAW</div>
        <div class="clth-equipped" id="clth-equipped-list">Loading...</div>
      </div>
      <div class="clth-shop-panel">
        <div class="clth-tabs">
          <button class="clth-tab on" onclick="clthTab('hat',this)">HATS</button>
          <button class="clth-tab" onclick="clthTab('coat',this)">COATS</button>
          <button class="clth-tab" onclick="clthTab('skin',this)">SKIN</button>
          <button class="clth-tab" onclick="clthTab('belt',this)">BELT</button>
        </div>
        <div class="clth-grid" id="clth-grid"></div>
      </div>
    </div>
    <button class="clth-close-btn" onclick="closeClothing()">RIDE OUT</button>
  </div>
</div>

<!-- NAVIS CODE PROMPT -->
<div id="ncode">
  <div id="ncodeb">
    <div id="ncode-badge">üîê</div>
    <div id="ncode-title">NAVIS MEMBERS ONLY</div>
    <div id="ncode-sub">ENTER YOUR NAVIS CODE</div>
    <div id="ncode-hint">A SHADOWY FIGURE HANDS YOU A SLIP OF PAPER...</div>
    <input id="ncode-input" maxlength="10" placeholder="_ _ _ _ _" spellcheck="false" autocomplete="off" type="password">
    <div id="ncode-err"></div>
    <div id="ncode-hint2" onclick="closeNcode()">[ WALK AWAY ]</div>
  </div>
</div>

<!-- CASINO -->
<div id="casino">
  <div id="casinob">
    <div class="bj-lights" id="cas-lights-top"></div>
    <div class="cas-h">
      <div class="cas-title-wrap">
        <h2><span class="suit-r">‚ô•</span> FRONTIER CASINO <span class="suit-r">‚ô¶</span></h2>
      </div>
      <p>‚ô† BLACKJACK ‚Äî BEAT THE DEALER ‚ô£</p>
      <div class="cas-money" id="cas-money">$0</div>
    </div>
    <div id="bj-area">
      <div id="bj-status">PLACE YOUR BET TO BEGIN</div>

      <div class="bj-section">
        <div class="bj-hand-label">‚ô† DEALER ‚ô†</div>
        <div class="bj-cards" id="dealer-cards"></div>
        <div class="bj-score" id="dealer-score"></div>
      </div>

      <div class="bj-section">
        <div class="bj-hand-label">‚ô• YOUR HAND ‚ô•</div>
        <div class="bj-cards" id="player-cards"></div>
        <div class="bj-score" id="player-score"></div>
      </div>

      <div id="bj-result"></div>

      <div id="bj-bet-row">
        <div class="bet-chip c10" onclick="bjBet(10)">$10</div>
        <div class="bet-chip c50" onclick="bjBet(50)">$50</div>
        <div class="bet-chip c100" onclick="bjBet(100)">$100</div>
        <div class="bet-chip c500" onclick="bjBet(500)">$500</div>
        <div class="bet-divider"></div>
        <div class="bet-info">
          <div class="bet-info-label">CURRENT BET</div>
          <div id="bj-curbetv">$0</div>
        </div>
        <button class="bj-btn" id="btn-clearbet" onclick="bjClearBet()">CLEAR</button>
      </div>

      <div class="bj-btn-row">
        <button class="bj-btn highlight" id="btn-deal" onclick="bjDeal()">DEAL</button>
        <button class="bj-btn" id="btn-hit" onclick="bjHit()" disabled>HIT</button>
        <button class="bj-btn" id="btn-stand" onclick="bjStand()" disabled>STAND</button>
        <button class="bj-btn" id="btn-double" onclick="bjDouble()" disabled>DOUBLE DOWN</button>
        <button class="bj-btn danger" onclick="closeCasino()">LEAVE TABLE</button>
      </div>
    </div>
    <div class="bj-lights" id="cas-lights-bot"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<script>
// Graceful fallback if PeerJS fails to load
if(typeof Peer==='undefined'){
  window.Peer=function(){
    this.id=null;
    this.on=function(){return this;};
    this.connect=function(){return{on:function(){return this;},send:function(){}};};
    this.destroy=function(){};
  };
  console.warn('PeerJS unavailable ‚Äî multiplayer disabled');
}
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEAD WEST ‚Äî ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const C=document.getElementById('c'),X=C.getContext('2d');
const MM=document.getElementById('mmc'),MX=MM.getContext('2d');
let W,H,CX,CY;
function resize(){W=C.width=innerWidth;H=C.height=innerHeight;CX=W>>1;CY=H>>1;}
resize();addEventListener('resize',resize);
const cam={x:0,y:0,shake:0,sx:0,sy:0};
function ws(wx,wy){return[wx-cam.x+CX+cam.sx,wy-cam.y+CY+cam.sy];}

// cursor
const XH=document.getElementById('xh'),XHD=document.getElementById('xhd');
addEventListener('mousemove',e=>{XH.style.left=e.clientX+'px';XH.style.top=e.clientY+'px';XHD.style.left=e.clientX+'px';XHD.style.top=e.clientY+'px';});

// input
const K={},mouse={x:0,y:0,wx:0,wy:0,dn:false};
let chatOpen=false,shopOpen=false,gstOpen=false,casinoOpen=false,adminOpen=false,ncodeOpen=false,clothOpen=false,gameOn=false;
addEventListener('keydown',e=>{
  if(['mpname','mproom','cif'].includes(document.activeElement?.id))return;
  K[e.code]=true;
  if(!gameOn)return;
  if(e.code==='KeyR')startReload();
  if(e.code==='KeyE')tryInteract();
  if(e.code==='KeyF')useMedkit();
  if(e.code==='KeyG')robTrain();
  if(e.code==='KeyT'){e.preventDefault();if(!chatOpen){chatOpen=true;document.getElementById('ci').classList.add('on');document.getElementById('cif').focus();}}
  if(e.code==='Escape'){closeShop();closeGStore();closeCasino();closeAdmin();closeNcode();closeClothing();}
});
addEventListener('keyup',e=>delete K[e.code]);
addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY;});
addEventListener('mousedown',e=>{if(e.button===0)mouse.dn=true;if(e.button===2)onRMB();});
addEventListener('mouseup',e=>{if(e.button===0)mouse.dn=false;});
addEventListener('contextmenu',e=>e.preventDefault());
document.getElementById('cif').addEventListener('keydown',e=>{
  if(e.code==='Enter'){const v=e.target.value.trim();if(v)mpSendChat(v);e.target.value='';chatOpen=false;document.getElementById('ci').classList.remove('on');}
  if(e.code==='Escape'){chatOpen=false;document.getElementById('ci').classList.remove('on');}
});

// ‚îÄ‚îÄ PIXEL ART GUN DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 14√ó8 pixel grids, drawn at 4px scale
const GPX={
  peacemaker:[
    '.......BBBBBBB',
    '....BBBGGGGGGB',
    '...BGGGGGBB...',
    '...BGGGB......',
    '....BBB.......',
    '....B.B.......',
    '....BBB.......',
    '..............',
  ],
  cattleman:[
    '.......BBBBBBB',
    '....BBBYYYYYYB',
    '...BYYYYBB....',
    '...BYYYYB.....',
    '....BBB.......',
    '....B.B.......',
    '....BBB.......',
    '..............',
  ],
  schofield:[
    '........BBBBBB',
    '.....BBBSSSSSSB',
    '....BSSSSSBB..',
    '....BSSSSB....',
    '.....BBB......',
    '.....B.B......',
    '.....BBB......',
    '..............',
  ],
  volcanic:[
    '.......BBBBBBBBB',
    '....BBBVVVVVVVVB',
    '...BVVVVVBB.....',
    '...BVVVVB.......',
    '....BBB.........',
    '....B.B.........',
    '....BBB.........',
    '................',
  ],
  navy:[
    '.........BBBBBBB',
    '......BBBNNNNNNNB',
    '.....BNNNNNBB....',
    '.....BNNNNNB.....',
    '......BBB........',
    '......B.B........',
    '......BBB........',
    '.................',
  ],
  lematt:[
    '.......BBBBBBBB',
    '....BBBLLLLLLLLB',
    '...BLLLLLLBB....',
    '...BLLLLBB......',
    '...BLLBB........',
    '....BBB.........',
    '....B.B.........',
    '....BBB.........',
  ],
  coach:[
    '..CCBBBBBBBBBB',
    '..CCBBBBBBBBBB',
    '..CC..........',
    '..CCBBBBBBBBBB',
    '..CCBBBBBBBBBB',
    '...BB.........',
    '...BB.........',
    '..............',
  ],
  sawnoff:[
    '...CBBBBBB',
    '...CBBBBBB',
    '...C......',
    '...CBBBBBB',
    '...CBBBBBB',
    '....BB....',
    '....BB....',
    '..........',
  ],
  pump:[
    '..........BBBBB',
    '....BBBBBPPPPPPB',
    '....BPPPPPBB....',
    '....BPPPB.......',
    '.....BBB........',
    '.....B.B........',
    '.....BBB........',
    '................',
  ],
  repeaterSg:[
    '...........BBBBBB',
    '....BBBBBBBRRRRRRB',
    '....BRRRRRRBB.....',
    '....BRRRRB........',
    '.....BBB..........',
    '.....B.B..........',
    '.....BBB..........',
    '..................',
  ],
  carbine:[
    '..............BBBBB',
    '....BBBBBBBBBBAAAAAAB',
    '....BAAAAAAAAAABB....',
    '....BAAAAAB..........',
    '.....BBB.............',
    '.....B.B.............',
    '.....BBB.............',
    '.....................',
  ],
  springfield:[
    '................BBBBB',
    '....BBBBBBBBBBBBFFFFFB',
    '....BFFFFFFFFFBB......',
    '....BFFFFFFFB.........',
    '.....BBB..............',
    '.....B.B..............',
    '.....BBB..............',
    '......................',
  ],
  repeater:[
    '..............BBBBB',
    '....BBBBBBBBBBWWWWWB',
    '....BWWWWWWWWWBB....',
    '....BWWWWWB.........',
    '.....BBB............',
    '.....B.B............',
    '.....BBB............',
    '...................',
  ],
};
const GCMAP={
  peacemaker:{B:'#181614',G:'#7a4e2c','.':null},
  cattleman:{B:'#181614',Y:'#684018','.':null},
  schofield:{B:'#1a1c22',S:'#464e58','.':null},
  volcanic:{B:'#161408',V:'#565840','.':null},
  navy:{B:'#100e1c',N:'#363444','.':null},
  lematt:{B:'#0c0a06',L:'#583c1e','.':null},
  coach:{B:'#181210',C:'#5e4830','.':null},
  sawnoff:{B:'#181210',C:'#4a301e','.':null},
  pump:{B:'#121010',P:'#383028','.':null},
  repeaterSg:{B:'#121010',R:'#5e4836','.':null},
  carbine:{B:'#0e0c06',A:'#38301e','.':null},
  springfield:{B:'#0a0804',F:'#2c2810','.':null},
  repeater:{B:'#0e0c08',W:'#464030','.':null},
};
function drawGunPx(ctx,id,ox,oy,sc){
  const rows=GPX[id],cm=GCMAP[id];if(!rows||!cm)return;
  rows.forEach((row,r)=>{for(let c=0;c<row.length;c++){const col=cm[row[c]];if(col){ctx.fillStyle=col;ctx.fillRect(ox+c*sc,oy+r*sc,sc,sc);}}});
}

// ‚îÄ‚îÄ GUNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GUNS={
  pistols:[
    {id:'peacemaker',nm:'PEACEMAKER',price:0,owned:true,ab:'Reliable',desc:'Balanced starter',ammo:6,res:120,dmg:18,fr:.22,rt:2.0,spd:900,spr:.04,rng:1.4},
    {id:'cattleman',nm:"CATTLEMAN'S",price:1200,owned:false,ab:'Burst',desc:'2 rapid shots',ammo:6,res:120,dmg:16,fr:.24,rt:2.1,spd:860,spr:.07,rng:1.2,sp:'burst'},
    {id:'schofield',nm:'SCHOFIELD',price:3500,owned:false,ab:'Fast Reload',desc:'Reloads in 0.9s',ammo:6,res:144,dmg:21,fr:.20,rt:.9,spd:940,spr:.025,rng:1.6},
    {id:'volcanic',nm:'VOLCANIC',price:8000,owned:false,ab:'10 Rounds',desc:'High-capacity lever',ammo:10,res:200,dmg:15,fr:.17,rt:2.6,spd:830,spr:.05,rng:1.3},
    {id:'navy',nm:'NAVY REVOLVER',price:18000,owned:false,ab:'Death Blow',desc:'Massive damage',ammo:6,res:90,dmg:44,fr:.42,rt:2.4,spd:1000,spr:.015,rng:2.0},
    {id:'lematt',nm:'LeMATT',price:45000,owned:false,ab:'Explosive',desc:'RMB = grenade',ammo:9,res:180,dmg:24,fr:.20,rt:3.0,spd:880,spr:.04,rng:1.4,sp:'explosive'},
  ],
  shotguns:[
    {id:'coach',nm:'COACH GUN',price:2500,owned:false,ab:'Double Barrel',desc:'RMB fires both',ammo:2,res:50,dmg:55,fr:.35,rt:1.8,spd:700,spr:.22,rng:.7,sg:true,pc:8},
    {id:'sawnoff',nm:"SAW'D OFF",price:4000,owned:false,ab:'Point Blank',desc:'Brutal close range',ammo:2,res:60,dmg:70,fr:.30,rt:1.4,spd:600,spr:.32,rng:.45,sg:true,pc:10},
    {id:'pump',nm:'PUMP ACTION',price:6500,owned:false,ab:'4 Shells',desc:'Pump reliability',ammo:4,res:40,dmg:45,fr:.55,rt:2.8,spd:720,spr:.18,rng:.75,sg:true,pc:7},
    {id:'repeaterSg',nm:'SHOT REPEATER',price:14000,owned:false,ab:'6-Shell Lever',desc:'Rapid lever shotgun',ammo:6,res:48,dmg:38,fr:.45,rt:3.2,spd:740,spr:.14,rng:.85,sg:true,pc:6},
  ],
  rifles:[
    {id:'carbine',nm:'CARBINE',price:5000,owned:false,ab:'Long Range',desc:'Accurate rifle',ammo:8,res:160,dmg:28,fr:.38,rt:2.8,spd:1100,spr:.018,rng:2.8},
    {id:'springfield',nm:'SPRINGFIELD',price:22000,owned:false,ab:'Marksman',desc:'Extreme range',ammo:5,res:80,dmg:58,fr:.70,rt:3.2,spd:1300,spr:.008,rng:3.5},
    {id:'repeater',nm:'REPEATER',price:11000,owned:false,ab:'Rapid Lever',desc:'15-round lever',ammo:15,res:150,dmg:22,fr:.28,rt:3.5,spd:1050,spr:.025,rng:2.4},
  ],
};
// Admin rainbow gun
const RAINBOW_GUN={id:'rainbow',nm:'‚ö° NAVIS GUN',price:0,owned:false,ab:'Rainbow ‚Äî Never Reload',desc:'Admin only. Infinite ammo.',ammo:999,res:9999,dmg:50,fr:.05,rt:.01,spd:1200,spr:.01,rng:3.5,isAdmin:true};
const ALLG=[...GUNS.pistols,...GUNS.shotguns,...GUNS.rifles,RAINBOW_GUN];

// ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PRAD=14;
const P={
  x:0,y:80,angle:0,hp:100,maxHp:100,money:0,lv:1,xp:0,alive:true,name:'OUTLAW',
  reloading:false,reloadT:0,shootCD:0,dashCD:0,dashT:0,dvx:0,dvy:0,inv:0,
  gunId:'peacemaker',ammo:6,res:120,medkits:0,mkLv:5,
  get gun(){return ALLG.find(g=>g.id===this.gunId);}
};
function xpFor(l){return l*80+(l-1)*40;}
function addXP(a){
  P.xp+=a;const n=xpFor(P.lv);
  if(P.xp>=n){P.xp-=n;P.lv++;P.maxHp=100+(P.lv-1)*15;P.hp=Math.min(P.hp+30,P.maxHp);showFP('LEVEL '+P.lv+'!');spawnPolice();}
  uiLv();
}
function addMoney(a){P.money+=a;document.getElementById('hmv').textContent='$'+P.money.toLocaleString();}
let wanted=0,wDecay=0;const WDM=14;
function addWanted(n){wanted=Math.min(5,wanted+n);wDecay=WDM;uiWanted();}
function uiWanted(){document.getElementById('ws').textContent='‚òÖ'.repeat(wanted)+'‚òÜ'.repeat(5-wanted);}
function uiHp(){document.getElementById('hbf').style.width=(P.hp/P.maxHp*100)+'%';document.getElementById('hpn').textContent=Math.ceil(P.hp);}
function uiLv(){const n=xpFor(P.lv);document.getElementById('lvv').textContent='LVL '+P.lv;document.getElementById('xpf').style.width=(P.xp/n*100)+'%';document.getElementById('xpt').textContent=P.xp+'/'+n+' XP';}
function uiAmmo(){
  const el=document.getElementById('pp');el.innerHTML='';const g=P.gun;
  if(g.isAdmin){el.innerHTML='<span style="font-size:9px;background:linear-gradient(90deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">‚àû RAINBOW</span>';document.getElementById('ar').textContent='INFINITE AMMO';return;}
  for(let i=0;i<Math.min(g.ammo,20);i++){const d=document.createElement('div');d.className=(g.sg?'pip sg':'pip')+(i>=P.ammo?' e':'');el.appendChild(d);}
  document.getElementById('ar').textContent='/ '+P.res+' RESERVE';
}
function uiKits(){document.getElementById('hkv').textContent='‚úö '+P.medkits;document.getElementById('hkl').textContent=P.lv>=P.mkLv?'[F]USE':'LV'+P.mkLv+' REQ';}
let fkT,fbT,fpT,ftT;
function showFK(m){const e=document.getElementById('fk');e.textContent=m;e.style.opacity='1';clearTimeout(fkT);fkT=setTimeout(()=>e.style.opacity='0',1400);}
function showFB(m,c){const e=document.getElementById('fb');e.textContent=m;e.style.color=c||'#e8c87a';e.style.opacity='1';clearTimeout(fbT);fbT=setTimeout(()=>e.style.opacity='0',2200);}
function showFP(m){const e=document.getElementById('fp');e.textContent=m;e.style.opacity='1';clearTimeout(fpT);fpT=setTimeout(()=>e.style.opacity='0',2600);}
function showFT(m){const e=document.getElementById('ft');e.textContent=m;e.style.opacity='1';clearTimeout(ftT);ftT=setTimeout(()=>e.style.opacity='0',2200);}
let bsT=0;
function hitEffect(){bsT=.4;document.getElementById('bs').style.opacity='1';}
function damageP(a){if(P.inv>0||!P.alive)return;P.hp=Math.max(0,P.hp-a);hitEffect();cam.shake=Math.max(cam.shake,10);uiHp();if(P.hp<=0){P.alive=false;gameOn=false;setTimeout(showDead,1200);}}
function showDead(){const pen=~~(P.money*.05);P.money=Math.max(0,P.money-pen);document.getElementById('dsub').textContent='LEVEL '+P.lv+' ‚Äî $'+P.money.toLocaleString()+' REMAINING';document.getElementById('dpen').textContent='LOST $'+pen.toLocaleString()+' (5% PENALTY)';document.getElementById('dead').style.display='flex';}
function useMedkit(){if(!P.alive||!gameOn)return;if(!P.medkits){showFK('NO MEDKITS');return;}if(P.hp>=P.maxHp){showFK('ALREADY FULL');return;}P.medkits--;P.hp=Math.min(P.maxHp,P.hp+50);uiHp();uiKits();showFB('+50 HP','#44aa44');}

// ‚îÄ‚îÄ WORLD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TOWNS=[
  {name:'DUSTY CREEK',sub:'POPULATION: DWINDLING',x:0,y:0,r:460,
   streets:[
     {ax:-400,ay:0,bx:400,by:0,w:18},   // main east-west
     {ax:0,ay:-400,bx:0,by:400,w:18},   // main north-south
     {ax:-400,ay:-250,bx:400,ay:-250,w:12},
     {ax:-400,ay:250,bx:400,ay:250,w:12},
   ],
   lights:[
     {x:-140,y:-250},{x:140,y:-250},{x:-140,y:250},{x:140,y:250},
     {x:-200,y:0},{x:200,y:0},{x:0,y:-320},{x:0,y:320},
   ],
   blds:[
    {x:-280,y:-200,w:130,h:85,lb:'SALOON',c:'#8B5E3C',rf:'#5A3520'},
    {x:170,y:-200,w:120,h:85,lb:'SHERIFF',c:'#7A5030',rf:'#4A3018'},
    {x:320,y:-50,w:110,h:75,lb:'GUN SHOP',c:'#5a4028',rf:'#3a2818',isShop:true},
    {x:-350,y:-50,w:90,h:60,lb:'DOCTOR',c:'#788070',rf:'#485048'},
    {x:-60,y:-310,w:90,h:65,lb:'CHURCH',c:'#9a8870',rf:'#6a5840'},
    {x:-60,y:285,w:110,h:65,lb:'STABLES',c:'#7A5030',rf:'#4A3018'},
    {x:170,y:170,w:130,h:80,lb:'GENERAL\nSTORE',c:'#4a7038',rf:'#2a4820',isGen:true},
    {x:-280,y:170,w:115,h:80,lb:'TAILOR',c:'#6a3858',rf:'#3a1838',isCloth:true},
    {x:320,y:170,w:100,h:70,lb:'BANK',c:'#A07848',rf:'#6A4828'},
   ]},
  {name:'RATTLESNAKE RIDGE',sub:'WHERE LAW ENDS',x:2600,y:500,r:400,biome:'desert',
   streets:[
     {ax:2350,ay:500,bx:2850,by:500,w:18},
     {ax:2600,ay:200,bx:2600,by:800,w:14},
     {ax:2350,ay:360,bx:2850,by:360,w:10},
     {ax:2350,ay:650,bx:2850,by:650,w:10},
   ],
   lights:[
     {x:2450,y:360},{x:2750,y:360},{x:2450,y:650},{x:2750,y:650},
     {x:2600,y:500},
   ],
   blds:[
    {x:2430,y:340,w:125,h:80,lb:"OUTLAW'S\nDEN",c:'#7a4a28',rf:'#5a3010'},
    {x:2770,y:340,w:100,h:75,lb:'ARMORY',c:'#6a5a28',rf:'#4a3818',isShop:true},
    {x:2430,y:650,w:115,h:70,lb:'SALOON',c:'#8a5a28',rf:'#6a3810'},
    {x:2770,y:650,w:118,h:75,lb:'GENERAL\nSTORE',c:'#5a7038',rf:'#3a4820',isGen:true},
    {x:2600,y:190,w:90,h:60,lb:'WATCHTOWER',c:'#7a6030',rf:'#5a4820'},
    {x:2600,y:800,w:100,h:65,lb:'TAILOR',c:'#6a3858',rf:'#3a1838',isCloth:true},
   ]},

  // ‚ïê‚ïê‚ïê SAINT CREOLE ‚Äî Grand swamp metropolis ‚ïê‚ïê‚ïê
  {name:'SAINT CREOLE',sub:'THE GRAND SOUTHERN CITY',x:800,y:2900,r:950,biome:'swamp',
   streets:[
     // ‚îÄ‚îÄ Grand Boulevard (main N-S artery) ‚îÄ‚îÄ
     {ax:800,ay:2000,bx:800,by:3700,w:42},
     // ‚îÄ‚îÄ Major E-W cross boulevards ‚îÄ‚îÄ
     {ax:0,ay:2300,bx:1600,by:2300,w:34},
     {ax:0,ay:2700,bx:1600,by:2700,w:34},
     {ax:0,ay:3100,bx:1600,by:3100,w:34},
     {ax:0,ay:3500,bx:1600,by:3500,w:28},
     // ‚îÄ‚îÄ Secondary N-S avenues ‚îÄ‚îÄ
     {ax:400,ay:2100,bx:400,by:3650,w:22},
     {ax:1200,ay:2100,bx:1200,by:3650,w:22},
     {ax:150,ay:2100,bx:150,by:3650,w:14},
     {ax:1450,ay:2100,bx:1450,by:3650,w:14},
     // ‚îÄ‚îÄ Minor cross streets ‚îÄ‚îÄ
     {ax:0,ay:2500,bx:400,by:2500,w:16},
     {ax:1200,ay:2500,bx:1600,by:2500,w:16},
     {ax:0,ay:2900,bx:400,by:2900,w:16},
     {ax:1200,ay:2900,bx:1600,by:2900,w:16},
     {ax:0,ay:3300,bx:400,by:3300,w:16},
     {ax:1200,ay:3300,bx:1600,by:3300,w:16},
     // ‚îÄ‚îÄ Harbour district roads (SW) ‚îÄ‚îÄ
     {ax:-200,ay:3600,bx:400,by:3600,w:20},
     {ax:-200,ay:2700,bx:-200,by:3700,w:18},
     {ax:-400,ay:3000,bx:0,by:3000,w:14},
     {ax:-400,ay:3300,bx:0,by:3300,w:14},
     // ‚îÄ‚îÄ East quarter roads ‚îÄ‚îÄ
     {ax:1600,ay:2700,bx:1600,by:3600,w:18},
     {ax:1400,ay:2900,bx:1800,by:2900,w:14},
     {ax:1400,ay:3300,bx:1800,by:3300,w:14},
     // ‚îÄ‚îÄ Alley network ‚îÄ‚îÄ
     {ax:580,ay:2200,bx:580,by:2600,w:10},
     {ax:1020,ay:2200,bx:1020,by:2600,w:10},
     {ax:580,ay:2800,bx:580,by:3000,w:10},
     {ax:1020,ay:2800,bx:1020,by:3000,w:10},
     {ax:580,ay:3200,bx:580,by:3400,w:10},
     {ax:1020,ay:3200,bx:1020,by:3400,w:10},
   ],
   lights:[
     // Grand Boulevard ‚Äî dense spacing
     {x:800,y:2100,grand:true},{x:800,y:2250,grand:true},{x:800,y:2400,grand:true},
     {x:800,y:2550,grand:true},{x:800,y:2700,grand:true},{x:800,y:2850,grand:true},
     {x:800,y:3000,grand:true},{x:800,y:3150,grand:true},{x:800,y:3300,grand:true},
     {x:800,y:3450,grand:true},{x:800,y:3600,grand:true},
     // Major E-W boulevard lights
     {x:150,y:2300,grand:true},{x:350,y:2300,grand:true},{x:550,y:2300,grand:true},
     {x:650,y:2300,grand:true},{x:950,y:2300,grand:true},{x:1050,y:2300,grand:true},
     {x:1250,y:2300,grand:true},{x:1450,y:2300,grand:true},
     {x:150,y:2700,grand:true},{x:350,y:2700,grand:true},{x:550,y:2700,grand:true},
     {x:650,y:2700,grand:true},{x:950,y:2700,grand:true},{x:1050,y:2700,grand:true},
     {x:1250,y:2700,grand:true},{x:1450,y:2700,grand:true},
     {x:150,y:3100,grand:true},{x:350,y:3100,grand:true},{x:550,y:3100,grand:true},
     {x:650,y:3100,grand:true},{x:950,y:3100,grand:true},{x:1050,y:3100,grand:true},
     {x:1250,y:3100,grand:true},{x:1450,y:3100,grand:true},
     {x:200,y:3500},{x:450,y:3500},{x:650,y:3500},{x:950,y:3500},{x:1150,y:3500},{x:1400,y:3500},
     // Avenue lights
     {x:400,y:2200},{x:400,y:2400},{x:400,y:2600},{x:400,y:2800},
     {x:400,y:3000},{x:400,y:3200},{x:400,y:3400},{x:400,y:3600},
     {x:1200,y:2200},{x:1200,y:2400},{x:1200,y:2600},{x:1200,y:2800},
     {x:1200,y:3000},{x:1200,y:3200},{x:1200,y:3400},{x:1200,y:3600},
     // Harbour district
     {x:-200,y:2800},{x:-200,y:3000},{x:-200,y:3200},{x:-200,y:3400},{x:-200,y:3600},
     {x:-100,y:3600},{x:100,y:3600},{x:300,y:3600},
     // East quarter
     {x:1600,y:2800},{x:1600,y:3000},{x:1600,y:3200},{x:1600,y:3400},
   ],
   blds:[
    // ‚ïê‚ïê NORTHERN GATE DISTRICT ‚ïê‚ïê
    {x:580,y:2170,w:140,h:80,lb:'NORTH\nGATEHOUSE',c:'#7a6040',rf:'#5a4030',sdStyle:true},
    {x:1020,y:2170,w:140,h:80,lb:'CUSTOMS\nHOUSE',c:'#6a5838',rf:'#4a3818',sdStyle:true},
    {x:300,y:2200,w:120,h:70,lb:'GARRISON',c:'#4a5030',rf:'#2a3018',sdStyle:true},
    {x:1300,y:2200,w:120,h:70,lb:'ARMOURY',c:'#5a5030',rf:'#3a3018',sdStyle:true},

    // ‚ïê‚ïê BLOCK 1 ‚Äî NW (Hotel Quarter) ‚ïê‚ïê
    {x:220,y:2430,w:200,h:120,lb:'GRAND\nHOTEL',c:'#7a6848',rf:'#5a4828',sdStyle:true},
    {x:220,y:2590,w:160,h:100,lb:'RESTAURANT\nROYAL',c:'#7a5838',rf:'#5a3820',sdStyle:true},
    {x:100,y:2500,w:130,h:80,lb:'JEWELLER',c:'#5a4858',rf:'#3a2838',sdStyle:true},

    // ‚ïê‚ïê BLOCK 2 ‚Äî NE (Arts Quarter) ‚ïê‚ïê
    {x:1380,y:2430,w:200,h:120,lb:'OPERA\nHOUSE',c:'#6a5038',rf:'#4a3020',sdStyle:true},
    {x:1380,y:2590,w:160,h:100,lb:'ART\nGALLERY',c:'#584858',rf:'#382838',sdStyle:true},
    {x:1500,y:2500,w:120,h:80,lb:'TELEGRAPH',c:'#584838',rf:'#382818',sdStyle:true},

    // ‚ïê‚ïê BLOCK 3 ‚Äî Central W (Commercial) ‚ïê‚ïê
    {x:220,y:2820,w:160,h:110,lb:'MERCHANTS\nGUILD',c:'#6a5838',rf:'#4a3820',sdStyle:true},
    {x:220,y:2980,w:150,h:90,lb:'GUN SHOP',c:'#5a4028',rf:'#3a2818',isShop:true,sdStyle:true},
    {x:100,y:2900,w:130,h:80,lb:'PAWN\nBROKER',c:'#5a4838',rf:'#3a2818',sdStyle:true},

    // ‚ïê‚ïê HARBOUR CUSTOMS ‚Äî beside City Hall (secret entrance) ‚ïê‚ïê
    {x:975,y:2820,w:160,h:110,lb:'HARBOUR\nCUSTOMS',c:'#6a7858',rf:'#4a5838',sdStyle:true},

    // ‚ïê‚ïê BLOCK 4 ‚Äî Central E (Entertainment) ‚ïê‚ïê
    {x:1380,y:2820,w:170,h:120,lb:'CASINO',c:'#3a1850',rf:'#1a0830',isCasino:true,sdStyle:true},
    {x:1380,y:2990,w:155,h:95,lb:'TAILOR',c:'#6a3858',rf:'#3a1838',isCloth:true,sdStyle:true},
    {x:1500,y:2900,w:120,h:80,lb:'THEATRE',c:'#4a2848',rf:'#2a1028',sdStyle:true},

    // ‚ïê‚ïê HARBOUR ‚Äî Central Landmark (replaces City Hall) ‚Äî Admin entrance inside ‚ïê‚ïê
    {x:800,y:2520,w:280,h:170,lb:'THE\nHARBOUR',c:'#4a5a68',rf:'#2a3a48',sdStyle:true,isHarbour:true},

    // ‚ïê‚ïê BLOCK 5 ‚Äî SW (Market District) ‚ïê‚ïê
    {x:220,y:3200,w:165,h:100,lb:'GENERAL\nSTORE',c:'#4a7038',rf:'#2a4820',isGen:true,sdStyle:true},
    {x:220,y:3360,w:150,h:90,lb:'APOTHECARY',c:'#4a5840',rf:'#2a3820',sdStyle:true},
    {x:100,y:3270,w:140,h:85,lb:'MARKET\nHALL',c:'#6a6038',rf:'#4a4020',sdStyle:true},

    // ‚ïê‚ïê BLOCK 6 ‚Äî SE (Nightlife) ‚ïê‚ïê
    {x:1380,y:3200,w:165,h:100,lb:'SALOON\nROYAL',c:'#8a4828',rf:'#5a2810',sdStyle:true},
    {x:1380,y:3360,w:150,h:90,lb:'BARBER\n& BATH',c:'#583848',rf:'#381828',sdStyle:true},
    {x:1500,y:3280,w:125,h:80,lb:'BROTHEL',c:'#7a3858',rf:'#4a1838',sdStyle:true},

    // ‚ïê‚ïê BOULEVARD BUILDINGS ‚ïê‚ïê
    {x:580,y:2820,w:140,h:90,lb:'BANK\nCREOLE',c:'#8a7050',rf:'#6a5030',sdStyle:true},
    {x:580,y:2980,w:130,h:80,lb:'NOTARY',c:'#6a6048',rf:'#4a4028',sdStyle:true},
    {x:1020,y:2820,w:140,h:90,lb:'POST\nOFFICE',c:'#6a7058',rf:'#4a5038',sdStyle:true},
    {x:1020,y:2980,w:130,h:80,lb:'LIBRARY',c:'#586848',rf:'#384828',sdStyle:true},
    {x:580,y:3200,w:140,h:90,lb:'FIRE\nHOUSE',c:'#8a3028',rf:'#6a1810',sdStyle:true},
    {x:580,y:3360,w:130,h:80,lb:'LAUNDRY',c:'#586068',rf:'#384048',sdStyle:true},
    {x:1020,y:3200,w:140,h:90,lb:'DOCTORS\nROW',c:'#485868',rf:'#283848',sdStyle:true},
    {x:1020,y:3360,w:130,h:80,lb:'SCHOOL\nHOUSE',c:'#7a7050',rf:'#5a5030',sdStyle:true},

    // ‚ïê‚ïê CATHEDRAL DISTRICT (south end) ‚ïê‚ïê
    {x:800,y:3560,w:250,h:150,lb:'CATHEDRAL\nDU SUD',c:'#787060',rf:'#585040',sdStyle:true,cathed:true},
    {x:560,y:3560,w:140,h:95,lb:'RECTORY',c:'#706858',rf:'#504838',sdStyle:true},
    {x:1040,y:3560,w:140,h:95,lb:'CONVENT',c:'#686058',rf:'#484038',sdStyle:true},

    // ‚ïê‚ïê HARBOUR DISTRICT (west waterfront) ‚ïê‚ïê
    {x:-180,y:2820,w:180,h:110,lb:'HARBOUR\nMASTER',c:'#5a6848',rf:'#3a4828',sdStyle:true},
    {x:-180,y:2990,w:160,h:95,lb:'FISHERY',c:'#486058',rf:'#284038',sdStyle:true},
    {x:-180,y:3170,w:170,h:100,lb:'DOCKYARD\nSTORE',c:'#4a5848',rf:'#2a3828',isGen:true,sdStyle:true},
    {x:-180,y:3350,w:160,h:90,lb:'SAILORS\nINN',c:'#7a5838',rf:'#5a3820',sdStyle:true},
    {x:-60,y:3560,w:250,h:100,lb:'GRAND\nWHARF',c:'#5a5840',rf:'#3a3820',sdStyle:true},

    // ‚ïê‚ïê EAST QUARTER ‚ïê‚ïê
    {x:1600,y:2820,w:160,h:100,lb:'EAST\nMARKET',c:'#6a6038',rf:'#4a4018',isGen:true,sdStyle:true},
    {x:1600,y:2990,w:150,h:90,lb:'GUNSMITHS\nEAST',c:'#5a4028',rf:'#3a2818',isShop:true,sdStyle:true},
    {x:1600,y:3170,w:155,h:95,lb:'TAILOR\nEAST',c:'#6a3858',rf:'#3a1838',isCloth:true,sdStyle:true},
    {x:1600,y:3350,w:150,h:90,lb:'EAST\nSALOON',c:'#8a5028',rf:'#5a3010',sdStyle:true},

    // ‚ïê‚ïê SOUTH GATE ‚ïê‚ïê
    {x:580,y:3700,w:130,h:75,lb:'SOUTH\nGATE',c:'#7a6040',rf:'#5a4030',sdStyle:true},
    {x:1020,y:3700,w:130,h:75,lb:'SOUTH\nGARRISON',c:'#4a5030',rf:'#2a3018',sdStyle:true},
   ]},

  // ‚ïê‚ïê‚ïê IRON GULCH ‚Äî mountain mining town NW ‚ïê‚ïê‚ïê
  {name:'IRON GULCH',sub:'DEEP IN THE MOUNTAINS',x:-1400,y:-800,r:320,
   streets:[
     {ax:-1640,ay:-800,bx:-1160,by:-800,w:16},
     {ax:-1400,ay:-1040,bx:-1400,by:-560,w:14},
   ],
   lights:[{x:-1530,y:-930},{x:-1270,y:-930},{x:-1530,y:-670},{x:-1270,y:-670},{x:-1400,y:-800}],
   blds:[
    {x:-1560,y:-920,w:115,h:75,lb:'MINE\nOFFICE',c:'#5a4830',rf:'#3a2818'},
    {x:-1240,y:-920,w:110,h:70,lb:'ARMORY',c:'#6a5030',rf:'#4a3010',isShop:true},
    {x:-1560,y:-640,w:120,h:75,lb:'SALOON',c:'#8a5028',rf:'#5a3010'},
    {x:-1240,y:-640,w:115,h:70,lb:'GENERAL\nSTORE',c:'#4a7038',rf:'#2a4820',isGen:true},
    {x:-1400,y:-1020,w:100,h:60,lb:'SHERIFF',c:'#7a5030',rf:'#4a3018'},
    {x:-1400,y:-540,w:110,h:65,lb:'TAILOR',c:'#6a3858',rf:'#3a1838',isCloth:true},
    {x:-1560,y:-790,w:90,h:55,lb:'ASSAY\nOFFICE',c:'#8a7840',rf:'#5a5020'},
    {x:-1240,y:-790,w:95,h:60,lb:'DYNAMITE\nSTORE',c:'#7a4828',rf:'#5a2810'},
   ]},

  // ‚ïê‚ïê‚ïê CROW HOLLOW ‚Äî outlaw hideout far north ‚ïê‚ïê‚ïê
  {name:'CROW HOLLOW',sub:'NO LAW, NO MERCY',x:-500,y:-2000,r:280,
   streets:[
     {ax:-740,ay:-2000,bx:-260,by:-2000,w:14},
     {ax:-500,ay:-2230,bx:-500,by:-1770,w:12},
   ],
   lights:[{x:-630,y:-2080},{x:-370,y:-2080},{x:-630,y:-1920},{x:-370,y:-1920}],
   blds:[
    {x:-650,y:-2080,w:110,h:70,lb:"OUTLAW'S\nHIDEOUT",c:'#6a3820',rf:'#4a1808'},
    {x:-350,y:-2080,w:105,h:65,lb:'GUN\nRUNNER',c:'#5a4020',rf:'#3a2808',isShop:true},
    {x:-650,y:-1920,w:110,h:65,lb:'BLACK\nMARKET',c:'#3a3028',rf:'#1a1818',isGen:true},
    {x:-350,y:-1920,w:100,h:60,lb:'BOUNTY\nBOARD',c:'#7a3818',rf:'#4a1808'},
    {x:-500,y:-2215,w:90,h:55,lb:'WATCH\nTOWER',c:'#5a4828',rf:'#3a2818'},
    {x:-500,y:-1760,w:105,h:60,lb:'TAILOR',c:'#6a3858',rf:'#3a1838',isCloth:true},
   ]},

  // ‚ïê‚ïê‚ïê SILVERADO FALLS ‚Äî riverside town NE ‚ïê‚ïê‚ïê
  {name:'SILVERADO FALLS',sub:'WHERE THE RIVER RUNS',x:1200,y:-1800,r:340,
   streets:[
     {ax:960,ay:-1800,bx:1440,by:-1800,w:16},
     {ax:1200,ay:-2040,bx:1200,by:-1560,w:14},
     {ax:960,ay:-1930,bx:1440,by:-1930,w:10},
   ],
   lights:[{x:1070,y:-1930},{x:1330,y:-1930},{x:1070,y:-1670},{x:1330,y:-1670},{x:1200,y:-1800}],
   blds:[
    {x:1050,y:-1920,w:120,h:75,lb:'RIVER\nSALOON',c:'#8a5a30',rf:'#6a3818'},
    {x:1350,y:-1920,w:115,h:75,lb:'GUN SHOP',c:'#5a4028',rf:'#3a2818',isShop:true},
    {x:1050,y:-1660,w:120,h:70,lb:'GENERAL\nSTORE',c:'#4a7038',rf:'#2a4820',isGen:true},
    {x:1350,y:-1660,w:110,h:68,lb:'TAILOR',c:'#6a3858',rf:'#3a1838',isCloth:true},
    {x:1200,y:-2028,w:95,h:60,lb:'FERRY\nDOCK',c:'#5a6848',rf:'#3a4828'},
    {x:1200,y:-1548,w:100,h:60,lb:'MILL',c:'#7a6030',rf:'#5a4020'},
    {x:1050,y:-1790,w:85,h:55,lb:'BANK',c:'#a07848',rf:'#6a4828'},
    {x:1350,y:-1790,w:90,h:55,lb:'SHERIFF',c:'#7a5030',rf:'#4a3018'},
   ]},
];

// ‚îÄ‚îÄ BIOMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FOREST={x:-750,y:650,w:1700,h:1500,name:'EMERALD VALLEY',sub:'UNTAMED WILDERNESS'};
const DESERT={x:1800,y:-300,w:2000,h:1500,name:'SCORCHED FLATS',sub:'DRY & DANGEROUS'};
const SWAMP={x:100,y:2000,w:1800,h:1600,name:'BAYOU NOIR',sub:'DARK WATERS'};

// Transition noise seeds for smooth blending
const TNOISE=[];
(()=>{for(let i=0;i<512;i++)TNOISE.push(Math.random());})(  );
function smoothNoise(x,y){
  const xi=~~(x/180)&255,yi=~~(y/180)&255;
  const fx=(x/180)-~~(x/180),fy=(y/180)-~~(y/180);
  const s=t=>t*t*(3-2*t);
  const a=TNOISE[(xi+yi*7)%512],b=TNOISE[(xi+1+yi*7)%512];
  const c=TNOISE[(xi+(yi+1)*7)%512],d=TNOISE[(xi+1+(yi+1)*7)%512];
  return a+(b-a)*s(fx)+(c-a)*s(fy)+(a-b-c+d)*s(fx)*s(fy);
}
// Returns biome blend weights at world pos {forest,desert,swamp,dirt} summing to 1
function biomeAt(wx,wy){
  const n=smoothNoise(wx,wy);
  const fw=FOREST,dw=DESERT,sw=SWAMP;
  const fd=Math.max(0,1-Math.hypot(Math.max(0,fw.x-wx,wx-fw.x-fw.w),Math.max(0,fw.y-wy,wy-fw.y-fw.h))/280);
  const dd=Math.max(0,1-Math.hypot(Math.max(0,dw.x-wx,wx-dw.x-dw.w),Math.max(0,dw.y-wy,wy-dw.y-dw.h))/300);
  const sd=Math.max(0,1-Math.hypot(Math.max(0,sw.x-wx,wx-sw.x-sw.w),Math.max(0,sw.y-wy,wy-sw.y-sw.h))/350);
  const f=Math.min(1,fd*(0.8+n*.4));const d=Math.min(1,dd*(0.8+n*.4));const s=Math.min(1,sd*(0.8+n*.4));
  const tot=f+d+s||1;return{f:f/tot,d:d/tot,s:s/tot,di:(1-(f+d+s)/tot)};
}

// Flora arrays
const FTREES=[],FBUSHES=[],FGRASS=[];
const DCACTUS=[],DROCKS=[],DSAND=[];
const SWTREES=[],SWMOSS=[],SWWATER=[];
const STREETLIGHTS=[];

(()=>{
  const rn=(a,b)=>a+Math.random()*(b-a);
  // Forest
  for(let i=0;i<280;i++){
    const x=FOREST.x+rn(30,FOREST.w-30),y=FOREST.y+rn(30,FOREST.h-30);
    const type=Math.random()<.55?'round':Math.random()<.55?'pine':'dead';
    FTREES.push({x,y,r:rn(18,44),g1:~~rn(85,145),g2:~~rn(155,225),g3:~~rn(118,185),th:rn(22,48),lean:rn(-.14,.14),type});
  }
  // Extra scattered trees at edges and plains
  for(let i=0;i<80;i++){
    const x=FOREST.x+rn(-200,FOREST.w+200),y=FOREST.y+rn(-200,FOREST.h+200);
    const near=x>FOREST.x-180&&x<FOREST.x+FOREST.w+180&&y>FOREST.y-180&&y<FOREST.y+FOREST.h+180;
    if(near){const type=Math.random()<.4?'pine':Math.random()<.5?'round':'dead';FTREES.push({x,y,r:rn(12,30),g1:~~rn(75,130),g2:~~rn(140,210),g3:~~rn(110,175),th:rn(18,38),lean:rn(-.2,.2),type});}
  }
  for(let i=0;i<480;i++)FBUSHES.push({x:FOREST.x+rn(8,FOREST.w-8),y:FOREST.y+rn(8,FOREST.h-8),r:rn(7,22),gv:~~rn(88,192)});
  for(let i=0;i<900;i++)FGRASS.push({x:FOREST.x+rn(0,FOREST.w),y:FOREST.y+rn(0,FOREST.h),len:rn(10,24),ang:rn(-.5,.5),gv:~~rn(88,175)});
  // Transitional edge bushes
  for(let i=0;i<80;i++){
    const x=FOREST.x+rn(-80,FOREST.w+80),y=FOREST.y+rn(-80,FOREST.h+80);
    const near=x>FOREST.x-60&&x<FOREST.x+FOREST.w+60&&y>FOREST.y-60&&y<FOREST.y+FOREST.h+60;
    if(near)FBUSHES.push({x,y,r:rn(5,14),gv:~~rn(70,140)});
  }
  // Desert
  for(let i=0;i<80;i++){
    const x=DESERT.x+rn(60,DESERT.w-60),y=DESERT.y+rn(60,DESERT.h-60);
    DCACTUS.push({x,y,h:rn(26,62),w:rn(5,13),arms:Math.random()>.4,armH:rn(12,30),armSide:Math.random()>.5?1:-1});
  }
  for(let i=0;i<100;i++)DROCKS.push({x:DESERT.x+rn(20,DESERT.w-20),y:DESERT.y+rn(20,DESERT.h-20),w:rn(10,38),h:rn(7,24),c:~~rn(115,175)});
  for(let i=0;i<150;i++)DSAND.push({x:DESERT.x+rn(0,DESERT.w),y:DESERT.y+rn(0,DESERT.h),r:rn(12,55),a:rn(.07,.24)});
  // Sparse desert edge scrub
  for(let i=0;i<60;i++){
    const x=DESERT.x+rn(-100,DESERT.w+100),y=DESERT.y+rn(-100,DESERT.h+100);
    DROCKS.push({x,y,w:rn(4,14),h:rn(3,9),c:~~rn(100,145)});
  }
  // Swamp ‚Äî bigger, denser
  for(let i=0;i<140;i++){
    const x=SWAMP.x+rn(30,SWAMP.w-30),y=SWAMP.y+rn(30,SWAMP.h-30);
    SWTREES.push({x,y,r:rn(14,40),th:rn(28,65),lean:rn(-.35,.35),moss:Math.random()>.35,dead:Math.random()>.75});
  }
  for(let i=0;i<100;i++)SWWATER.push({x:SWAMP.x+rn(25,SWAMP.w-25),y:SWAMP.y+rn(25,SWAMP.h-25),rx:rn(22,95),ry:rn(10,45),anim:Math.random()*Math.PI*2});
  for(let i=0;i<200;i++)SWMOSS.push({x:SWAMP.x+rn(0,SWAMP.w),y:SWAMP.y+rn(0,SWAMP.h),r:rn(5,18),gv:~~rn(55,125)});

  // Street lights for all towns
  TOWNS.forEach(t=>{
    if(!t.lights)return;
    t.lights.forEach(l=>STREETLIGHTS.push({x:l.x+(t.x-TOWNS[0].x)*(t.x!==0?1:1),y:l.y+(t.y-TOWNS[0].y)*(t.y!==0?1:1),tx:t.x,ty:t.y}));
  });
  // Actually street lights are stored with absolute coords already in the town bld coords ‚Äî rebuild
  STREETLIGHTS.length=0;
  TOWNS.forEach(t=>{if(!t.lights)return;t.lights.forEach(l=>STREETLIGHTS.push({x:l.x,y:l.y,grand:t.name==='SAINT CREOLE'}));});
})();
const TRACK=[{x:-1900,y:280},{x:-900,y:220},{x:0,y:80},{x:850,y:300},{x:1750,y:500},{x:2600,y:680},{x:3400,y:900}];
const TRAIN={t:0,spd:.007,x:0,y:0,ang:0,robbable:false,cd:0,ntf:false,ntfT:0};
function trkPos(t){const n=TRACK.length-1,si=Math.min(~~(t*n),n-1),lt=t*n-si,a=TRACK[si],b=TRACK[si+1];return{x:a.x+(b.x-a.x)*lt,y:a.y+(b.y-a.y)*lt,ang:Math.atan2(b.y-a.y,b.x-a.x)};}
const COLS=[];
function buildCols(){COLS.length=0;TOWNS.forEach(t=>t.blds.forEach(b=>COLS.push({x:b.x,y:b.y,w:b.w,h:b.h})));}
function ptRect(px,py,pr,rx,ry,rw,rh){const nx=Math.max(rx-rw/2,Math.min(px,rx+rw/2)),ny=Math.max(ry-rh/2,Math.min(py,ry+rh/2));return(px-nx)**2+(py-ny)**2<pr*pr;}
function resolveP(x,y,r){let nx=x,ny=y;for(const c of COLS){if(ptRect(nx,ny,r,c.x,c.y,c.w,c.h)){const dx=nx-c.x,dy=ny-c.y,ox=c.w/2+r-Math.abs(dx),oy=c.h/2+r-Math.abs(dy);if(ox<oy)nx+=ox*(Math.sign(dx)||1);else ny+=oy*(Math.sign(dy)||1);}}return[nx,ny];}
function bWall(bx,by){for(const c of COLS)if(Math.abs(bx-c.x)<c.w/2+3&&Math.abs(by-c.y)<c.h/2+3)return true;return false;}

// ‚îÄ‚îÄ NPCs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NMS=['Jesse','Cole','Frank','Mae','Dutch','Arthur','Bill','Sadie','Hosea','Micah','Javier','Elias','Hank','Ned','Buck','Pete','Lena','Silas','Rufus','Ada','Colt','Ida','Amos','Vera','Clem','Beau','Etta','Wes','Dot','Cruz'];
const RLS=['Outlaw','Drifter','Gambler','Rustler','Gunslinger','Fugitive','Bandit','Renegade','Desperado','Highwayman','Poacher','Smuggler','Fence','Cutthroat','Scalphunter'];
const NCL=['#8B5E3C','#6B4020','#7A5030','#5A3518','#9a6838','#4a3018','#6a4820','#3a2810','#a07040','#504028'];
const NHT=['#1a0d05','#2a1808','#0d0808','#201408','#0a0a0a','#181006'];
const NSK=['#c8a878','#b89060','#d0aa80','#c09060','#e0b888','#a87850','#d4b090','#b0886a'];
const NCOATS=['#5A3518','#3a2010','#6a2010','#1a2a4a','#2a3a1a','#4a1810','#7a5030','#282018'];
// NPC hat styles: 0=cowboy, 1=derby, 2=bandana, 3=cap, 4=none
const CVN=['Mary','Tom','Grace','Sam','Clara','Ned','Rose','Jack','Edna','Eli','Nora','Cal'];
const CVR=['Widow','Farmer','Preacher','Doctor','Banker','Merchant','Laundress','Barkeep','Clerk','Drifter'];
const GNM=['BLOOD CANYON','DEADWOOD RIDERS','IRON SKULL','SNAKE RIVER'];
const GCL=['#8a1010','#1a4a1a','#1a1a6a','#6a3a1a'];
const GHT=['#1a0404','#041a04','#04041a','#1a0e04'];
let deadWestNPC=null;
const npcs=[],police=[],riders=[],respawnQ=[];
function bRange(){if(P.lv>=10)return[500,1000];if(P.lv>=5)return[200,600];return[1,500];}
function mkBounty(ti){
  const[mn,mx2]=bRange(),bounty=~~(Math.random()*(mx2-mn))+mn;
  const isG=Math.random()<.2,gi=~~(Math.random()*GNM.length);
  const t=TOWNS[ti],a=Math.random()*Math.PI*2,d=80+Math.random()*320;
  const hatStyle=~~(Math.random()*5);
  return{bounty,name:NMS[~~(Math.random()*NMS.length)]+' '+RLS[~~(Math.random()*RLS.length)],
    hp:Math.max(2,~~(bounty/28)),maxHp:Math.max(2,~~(bounty/28)),
    spd:55+bounty/9,dmg:4+~~(bounty/65),sr:Math.max(.65,2.4-bounty/240),
    isG,gi,gN:isG?GNM[gi]:null,gC:isG?GCL[gi]:null,gH:isG?GHT[gi]:null,
    x:t.x+Math.cos(a)*d,y:t.y+Math.sin(a)*d,ang:0,
    col:isG?GCL[gi]:NCL[~~(Math.random()*NCL.length)],
    coat:NCOATS[~~(Math.random()*NCOATS.length)],
    hat:isG?GHT[gi]:NHT[~~(Math.random()*NHT.length)],
    hatStyle,
    skn:NSK[~~(Math.random()*NSK.length)],
    sz:12+~~(bounty/95),alive:true,hostile:false,hf:0,
    st:Math.random()*2,wt:2+Math.random()*4,wtx:t.x,wty:t.y,
    isBounty:true,isCiv:false,isDeadWest:false,ti};}
function mkCiv(ti){
  const t=TOWNS[ti],a=Math.random()*Math.PI*2,d=30+Math.random()*160;
  const cols=['#d4607a','#404880','#808878','#1a1a2a','#887040','#4a6840','#887058','#506040'];
  return{name:CVN[~~(Math.random()*CVN.length)]+' the '+CVR[~~(Math.random()*CVR.length)],
    hp:2,maxHp:2,spd:78,dmg:3,sr:3.2,
    x:t.x+Math.cos(a)*d,y:t.y+Math.sin(a)*d,ang:0,
    col:cols[~~(Math.random()*cols.length)],
    coat:cols[~~(Math.random()*cols.length)],
    hat:NHT[~~(Math.random()*NHT.length)],
    hatStyle:~~(Math.random()*5),
    skn:NSK[~~(Math.random()*NSK.length)],
    sz:11,alive:true,hostile:false,hf:0,
    st:Math.random()*3,wt:3+Math.random()*4,wtx:t.x,wty:t.y,
    isBounty:false,isCiv:true,isG:false,isDeadWest:false,ti};}
function mkDeadWest(){
  // Spawns near Saint Creole (town index 2)
  const t=TOWNS[2],a=Math.random()*Math.PI*2,d=200+Math.random()*300;
  return{bounty:9999,name:'DEAD WEST',
    hp:500,maxHp:500,spd:90,dmg:35,sr:0.9,
    x:t.x+Math.cos(a)*d,y:t.y+Math.sin(a)*d,ang:0,
    col:'#1a1a1a',coat:'#8a0000',hat:'#111111',hatStyle:0,skn:'#c8c8c8',
    sz:20,alive:true,hostile:false,hf:0,
    st:2,wt:3,wtx:t.x,wty:t.y,
    isBounty:true,isCiv:false,isG:false,isDeadWest:true,ti:2};}
function buildNPCs(){
  npcs.length=0;deadWestNPC=null;
  TOWNS.forEach((_,ti)=>{
    for(let i=0;i<12;i++)npcs.push(mkBounty(ti));
    for(let i=0;i<8;i++)npcs.push(mkCiv(ti));
  });
  // Dead West always spawns at game start in Saint Creole
  deadWestNPC=mkDeadWest();
  npcs.push(deadWestNPC);
  // Despawn after 2 minutes if not killed
  setTimeout(()=>{
    if(deadWestNPC&&deadWestNPC.alive){
      deadWestNPC.alive=false;
      const idx=npcs.indexOf(deadWestNPC);if(idx>=0)npcs.splice(idx,1);
      deadWestNPC=null;
      showFB('üíÄ DEAD WEST HAS VANISHED...','#880000');
    }
  },120000);
}
function spawnPolice(){const n=3+P.lv;for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,d=480+Math.random()*200;police.push({x:P.x+Math.cos(a)*d,y:P.y+Math.sin(a)*d,ang:0,hp:8+P.lv*2,maxHp:8+P.lv*2,spd:100+P.lv*5,dmg:10+P.lv*2,sr:1.4,st:Math.random()*1.5,alive:true,hf:0,sz:13});}showFP('DEPUTIES INCOMING!');}
function spawnRiders(npc){const cnt=Math.min(10,5+~~(npc.bounty/100));showFP((npc.gN||'GANG')+' RIDES OUT!');for(let i=0;i<cnt;i++){const a=Math.random()*Math.PI*2,d=500+Math.random()*260;riders.push({x:P.x+Math.cos(a)*d,y:P.y+Math.sin(a)*d,ang:0,hp:3+~~(npc.bounty/80),maxHp:3+~~(npc.bounty/80),spd:165+npc.bounty/6,dmg:8+~~(npc.bounty/60),sr:Math.max(.8,1.8-npc.bounty/600),st:Math.random()*2,alive:true,hf:0,sz:18,col:npc.gC||'#5a1010',hat:npc.gH||'#1a0404',gN:npc.gN});}}

// ‚îÄ‚îÄ TRAIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updTrain(dt){
  if(TRAIN.cd>0){TRAIN.cd-=dt;return;}
  TRAIN.t=(TRAIN.t+TRAIN.spd*dt)%1;const p=trkPos(TRAIN.t);TRAIN.x=p.x;TRAIN.y=p.y;TRAIN.ang=p.ang;
  const d=Math.hypot(P.x-TRAIN.x,P.y-TRAIN.y);
  TRAIN.robbable=d<130;
  if(d<420&&!TRAIN.ntf&&!TRAIN.robbable){TRAIN.ntf=true;showTrn('üöÇ TRAIN NEARBY!','Move to intercept');TRAIN.ntfT=4;}
  if(TRAIN.robbable&&!TRAIN.ntf){TRAIN.ntf=true;showTrn('üöÇ IN RANGE!','[ G ] ROB THE TRAIN');TRAIN.ntfT=5;}
  if(d>560)TRAIN.ntf=false;
  if(TRAIN.ntfT>0){TRAIN.ntfT-=dt;if(TRAIN.ntfT<=0)document.getElementById('trb').style.opacity='0';}
}
function showTrn(t,h){document.getElementById('trt').textContent=t;document.getElementById('trh').textContent=h;document.getElementById('trb').style.opacity='1';TRAIN.ntfT=5;}
function robTrain(){if(!TRAIN.robbable||!P.alive||!gameOn)return;const loot=~~(Math.random()*2000)+1;addMoney(loot);addXP(~~(loot/8)+10);addWanted(2);showFB('üöÇ ROBBED! +$'+loot,'#d08c18');showFT('DEPUTIES ALERTED!');document.getElementById('trb').style.opacity='0';TRAIN.cd=55+Math.random()*20;TRAIN.t=0;TRAIN.ntf=false;spawnPolice();}

// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PARTS=[];
function pBlood(x,y,n){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=40+Math.random()*160;PARTS.push({t:0,x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:2+Math.random()*4,life:1,c:`hsl(${~~(Math.random()*18)},90%,${18+~~(Math.random()*12)}%)`});}}
function pDust(x,y){for(let i=0;i<4;i++){const a=Math.random()*Math.PI*2,s=15+Math.random()*45;PARTS.push({t:1,x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:2+Math.random()*5,life:1});}}
function pMuzz(x,y,a){for(let i=0;i<4;i++){const aa=a+(Math.random()-.5)*.5,s=80+Math.random()*175;PARTS.push({t:2,x,y,vx:Math.cos(aa)*s,vy:Math.sin(aa)*s,r:2+Math.random()*4,life:.28});}}
function pCasing(x,y,a){PARTS.push({t:3,x,y,vx:Math.cos(a+Math.PI/2)*(25+Math.random()*60),vy:Math.sin(a+Math.PI/2)*(25+Math.random()*60),r:3,life:.65,ag:Math.random()*Math.PI*2,sp:(Math.random()-.5)*11});}
function pPool(x,y){PARTS.push({t:4,x,y,r:0,mr:8+Math.random()*18,life:28});}
function pExp(x,y){for(let i=0;i<24;i++){const a=Math.random()*Math.PI*2,s=80+Math.random()*230;PARTS.push({t:5,x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:3+Math.random()*6,life:.55});}PARTS.push({t:6,x,y,r:5,mr:80,life:.38});}
function pHoof(x,y){for(let i=0;i<3;i++){const a=Math.random()*Math.PI*2,s=20+Math.random()*38;PARTS.push({t:1,x:x+(Math.random()-.5)*8,y:y+(Math.random()-.5)*8,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:2+Math.random()*5,life:.65});}}

// ‚îÄ‚îÄ SHOOTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const bullets=[],eBullets=[];
let autoT=0,flashT=0;
function doShoot(){
  if(!P.alive||P.reloading||!gameOn)return;const g=P.gun;
  if(!g.isAdmin&&P.ammo<=0){startReload();return;}
  if(P.shootCD>0)return;
  if(!g.isAdmin)P.ammo--;
  P.shootCD=g.fr;uiAmmo();
  const bx=P.x+Math.cos(P.angle)*22,by=P.y+Math.sin(P.angle)*22;
  const isRainbow=g.isAdmin;
  if(g.sg){const pc=g.pc||8;for(let i=0;i<pc;i++){const sp=(Math.random()-.5)*g.spr;bullets.push({x:bx,y:by,vx:Math.cos(P.angle+sp)*g.spd,vy:Math.sin(P.angle+sp)*g.spd,life:g.rng,tr:[],dmg:~~(g.dmg/pc)+2,sg:true,rainbow:isRainbow});}mpShoot({sg:true,x:~~bx,y:~~by,a:P.angle,spd:g.spd,spr:g.spr,dmg:~~(g.dmg/pc)+2,pc});}
  else{const sp=(Math.random()-.5)*g.spr,vx=Math.cos(P.angle+sp)*g.spd,vy=Math.sin(P.angle+sp)*g.spd;bullets.push({x:bx,y:by,vx,vy,life:g.rng,tr:[],dmg:g.dmg,sp:g.sp||null,rainbow:isRainbow});mpShoot({sg:false,x:~~bx,y:~~by,vx:~~vx,vy:~~vy,life:g.rng,dmg:g.dmg});if(g.sp==='burst')setTimeout(()=>{if(!P.alive)return;const s2=(Math.random()-.5)*g.spr;bullets.push({x:bx,y:by,vx:Math.cos(P.angle+s2)*g.spd,vy:Math.sin(P.angle+s2)*g.spd,life:g.rng,tr:[],dmg:g.dmg,rainbow:isRainbow});},80);}
  pMuzz(bx,by,P.angle);pCasing(P.x,P.y,P.angle);cam.shake=Math.max(cam.shake,g.sg?9:5);flashT=.07;
  if(!g.isAdmin&&P.ammo===0)setTimeout(startReload,350);
}
function onRMB(){if(!P.alive||!gameOn)return;const g=P.gun;if(g.sp==='explosive'){const bx=P.x+Math.cos(P.angle)*22,by=P.y+Math.sin(P.angle)*22;bullets.push({x:bx,y:by,vx:Math.cos(P.angle)*375,vy:Math.sin(P.angle)*375,life:.9,tr:[],dmg:0,sp:'explode'});cam.shake=9;flashT=.1;}else if(g.sg){if(P.ammo>=2){doShoot();setTimeout(doShoot,50);}else if(P.ammo>=1)doShoot();}else startReload();}
function startReload(){const g=P.gun;if(P.reloading||P.res<=0||P.ammo===g.ammo)return;P.reloading=true;P.reloadT=g.rt;document.getElementById('rlw').style.opacity='1';const rf=document.getElementById('rlf');rf.style.transition='width '+g.rt+'s linear';rf.style.width='100%';}
function finishReload(){P.reloading=false;document.getElementById('rlw').style.opacity='0';const rf=document.getElementById('rlf');rf.style.transition='none';rf.style.width='0%';const g=P.gun,n=g.ammo-P.ammo,l=Math.min(n,P.res);P.ammo+=l;P.res-=l;uiAmmo();}
function equipGun(id){const g=ALLG.find(g=>g.id===id);if(!g)return;P.gunId=id;P.ammo=g.ammo;P.res=g.res;P.reloading=false;document.getElementById('gn').textContent=g.nm;document.getElementById('ga').textContent=g.ab;uiAmmo();}

// ‚îÄ‚îÄ SHOPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let shopTab='pistols';
function tryInteract(){
  if(!P.alive||shopOpen||gstOpen||casinoOpen||adminOpen||ncodeOpen||clothOpen)return;
  // Secret zone: behind the HARBOUR CUSTOMS in Saint Creole
  if(Math.abs(P.x-975)<80&&P.y>2875&&P.y<3010){openNcode();return;}
  for(const t of TOWNS)for(const b of t.blds){
    if(Math.abs(P.x-b.x)<b.w/2+65&&Math.abs(P.y-b.y)<b.h/2+65){
      if(b.isHarbour){if(P.isAdmin)openAdmin();else openNcode();return;}
      if(b.isShop){openShop();return;}
      if(b.isGen){openGStore();return;}
      if(b.isCasino){openCasino();return;}
      if(b.isCloth){openClothing();return;}
    }
  }
}
function setTab(t,el){shopTab=t;document.querySelectorAll('.stab').forEach(e=>e.classList.remove('on'));el.classList.add('on');renderShop();}
function openShop(){shopOpen=true;document.getElementById('gso').style.display='flex';document.getElementById('gsm').textContent='MONEY: $'+P.money.toLocaleString();renderShop();}
function renderShop(){
  const guns=GUNS[shopTab],grid=document.getElementById('gsgrid');grid.innerHTML='';
  guns.forEach(g=>{
    const owned=g.owned,eq=P.gunId===g.id,can=P.money>=g.price;
    const card=document.createElement('div');card.className='gc'+(eq?' eq':'')+(owned||can?'':' lk');
    const cv=document.createElement('canvas');cv.className='gpx';cv.width=72;cv.height=44;
    const cx=cv.getContext('2d');cx.fillStyle='#040201';cx.fillRect(0,0,72,44);
    const grd=cx.createRadialGradient(36,26,0,36,26,24);grd.addColorStop(0,eq?'rgba(175,115,18,.16)':owned?'rgba(45,110,45,.12)':'rgba(25,15,4,.07)');grd.addColorStop(1,'rgba(0,0,0,0)');cx.fillStyle=grd;cx.fillRect(0,0,72,44);
    const rows=GPX[g.id],pw=rows?rows[0].length:14;drawGunPx(cx,g.id,Math.max(1,~~((72-pw*4)/2)),6,4);
    if(eq){cx.strokeStyle='rgba(175,115,18,.42)';cx.lineWidth=1.5;cx.strokeRect(.5,.5,71,43);}
    card.appendChild(cv);
    const pr=g.price===0?'FREE':can||owned?'$'+g.price.toLocaleString():`<span style="color:#783018">$${g.price.toLocaleString()}</span>`;
    card.innerHTML+=`<div class="gn">${g.nm}</div><div class="gd">${g.desc}</div><div class="gst"><div>DMG<span>${g.dmg}</span></div><div>AMO<span>${g.ammo}</span></div><div>SPD<span>${g.fr>.5?'SLW':g.fr>.3?'MED':'FST'}</span></div><div>RNG<span>${g.rng>2.5?'LNG':g.rng>1.2?'MED':'SHT'}</span></div></div>${owned?`<div class="gp" style="color:#3e983e">OWNED</div>`:`<div class="gp">${pr}</div>`}`;
    if(eq)card.innerHTML+=`<div class="gbdg e">EQ</div>`;else if(owned)card.innerHTML+=`<div class="gbdg o">OWN</div>`;
    if(!card.classList.contains('lk'))card.addEventListener('click',()=>{if(eq)return;if(owned){equipGun(g.id);openShop();return;}if(!can){showFB('NOT ENOUGH $','#c83018');return;}P.money-=g.price;g.owned=true;equipGun(g.id);document.getElementById('hmv').textContent='$'+P.money.toLocaleString();showFB('NEW GUN: '+g.nm);openShop();});
    grid.appendChild(card);
  });
}
function closeShop(){shopOpen=false;document.getElementById('gso').style.display='none';}
function openGStore(){gstOpen=true;document.getElementById('sto').style.display='flex';document.getElementById('stom').textContent='MONEY: $'+P.money.toLocaleString()+' | KITS: '+P.medkits;const con=document.getElementById('stolist');con.innerHTML='';const items=[{ok:P.lv>=P.mkLv,icon:'üè•',nm:'MEDKIT',desc:'+50 HP instantly',req:P.lv>=P.mkLv?'Available':'Level '+P.mkLv+' req',price:2500,fn(){if(P.money<2500){showFB('NOT ENOUGH $','#c83018');return;}P.money-=2500;P.medkits++;P.mkLv=P.lv+2;document.getElementById('hmv').textContent='$'+P.money.toLocaleString();uiKits();showFB('‚úö MEDKIT','#44aa44');openGStore();}},{ok:true,icon:'ü•É',nm:'WHISKEY',desc:'+15 HP now',req:'Always available',price:150,fn(){if(P.money<150){showFB('NOT ENOUGH $','#c83018');return;}P.money-=150;P.hp=Math.min(P.maxHp,P.hp+15);uiHp();document.getElementById('hmv').textContent='$'+P.money.toLocaleString();showFB('+15 HP','#988018');closeGStore();}},{ok:true,icon:'üî´',nm:'AMMO PACK',desc:'Refills reserve',req:'Always available',price:500,fn(){if(P.money<500){showFB('NOT ENOUGH $','#c83018');return;}P.money-=500;P.res=P.gun.res;uiAmmo();document.getElementById('hmv').textContent='$'+P.money.toLocaleString();showFB('AMMO FULL','#c8a018');closeGStore();}}];items.forEach(it=>{const d=document.createElement('div');d.className='si'+(it.ok?'':' sd');d.innerHTML=`<div class="sic">${it.icon}</div><div class="sin"><h3>${it.nm}</h3><p>${it.desc}</p><div class="sir">${it.req}</div></div><div class="sip">$${it.price.toLocaleString()}</div>`;if(it.ok)d.addEventListener('click',it.fn);con.appendChild(d);});}
function closeGStore(){gstOpen=false;document.getElementById('sto').style.display='none';}

// ‚îÄ‚îÄ TIME OF DAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tod=0.38;
function lm(){const t=tod;if(t<.2||t>.82)return{r:.25,g:.2,b:.34};if(t<.3)return{r:.78,g:.48,b:.28};if(t<.62)return{r:1,g:.87,b:.64};return{r:.84,g:.44,b:.19};}

// ‚îÄ‚îÄ RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSky(){
  const t=tod;let top,bot;
  if(t<.2||t>.82){top='#030208';bot='#070310';}else if(t<.27){top='#1e0810';bot='#5c1825';}else if(t<.36){top='#4e1e0e';bot='#be5425';}else if(t<.62){top='#283e5e';bot='#885418';}else if(t<.72){top='#381608';bot='#9e3518';}else{top='#090408';bot='#160508';}
  const g=X.createLinearGradient(0,0,0,H);g.addColorStop(0,top);g.addColorStop(1,bot);X.fillStyle=g;X.fillRect(0,0,W,H);
  // Sun
  const sa=tod*Math.PI*2-Math.PI/2,sh=Math.max(0,Math.min(1,1-Math.abs(tod-.3)*3.4));
  if(sh>.04){const[sx2,sy2]=ws(Math.cos(sa)*560,Math.sin(sa)*420);X.fillStyle=`rgba(255,238,155,${sh})`;X.shadowColor='rgba(255,195,70,.7)';X.shadowBlur=26;X.beginPath();X.arc(sx2,sy2,17,0,Math.PI*2);X.fill();X.shadowBlur=0;}
  // Moon
  const ma=sa+Math.PI,mh=Math.max(0,Math.min(1,(-Math.cos(ma+Math.PI)*.5+.5)));
  if(mh>.1){const[mx2,my2]=ws(Math.cos(ma)*560,Math.sin(ma)*420);X.fillStyle=`rgba(208,218,238,${mh*.72})`;X.beginPath();X.arc(mx2,my2,11,0,Math.PI*2);X.fill();}
}

function drawGround(){
  const L=lm(),tile=90;
  const ox=((cam.x%tile)+tile)%tile,oy=((cam.y%tile)+tile)%tile;
  const cols=Math.ceil(W/tile)+2,rows2=Math.ceil(H/tile)+2;

  // ‚îÄ‚îÄ Biome-blended ground tiles ‚îÄ‚îÄ
  for(let r=0;r<rows2;r++)for(let c=0;c<cols;c++){
    const wx=cam.x-ox+c*tile,wy=cam.y-oy+r*tile;
    const bm=biomeAt(wx,wy);
    const hv=((c*7+r*13)^c*3)%10;const jitter=hv%3===0?.96:hv%3===1?.88:1.04;
    // Blend colors: dirt, forest, desert, swamp
    const dr=0.42*jitter,dg=0.26*jitter,db=0.09*jitter;
    const fr=0.14,fg=0.52,fb=0.12;
    const er=0.78,eg=0.60,eb=0.22;
    const sr=0.18,sg=0.30,sb=0.16;
    const rr=dr*bm.di+fr*bm.f+er*bm.d+sr*bm.s;
    const rg=dg*bm.di+fg*bm.f+eg*bm.d+sg*bm.s;
    const rb=db*bm.di+fb*bm.f+eb*bm.d+sb*bm.s;
    X.fillStyle=`rgb(${~~(rr*255*L.r)},${~~(rg*255*L.g)},${~~(rb*255*L.b)})`;
    X.fillRect(-ox+cam.sx+c*tile,-oy+cam.sy+r*tile,tile,tile);
  }
  // Subtle grid
  X.strokeStyle='rgba(0,0,0,.032)';X.lineWidth=1;
  for(let r=0;r<=rows2;r++){X.beginPath();X.moveTo(0,-oy+cam.sy+r*tile);X.lineTo(W,-oy+cam.sy+r*tile);X.stroke();}
  for(let c=0;c<=cols;c++){X.beginPath();X.moveTo(-ox+cam.sx+c*tile,0);X.lineTo(-ox+cam.sx+c*tile,H);X.stroke();}

  // ‚îÄ‚îÄ Town streets ‚îÄ‚îÄ
  TOWNS.forEach(t=>{
    if(!t.streets)return;
    const isSC=t.name==='SAINT CREOLE';
    t.streets.forEach(s=>{
      const[ax,ay]=ws(s.ax,s.ay),[bx,by]=ws(s.bx,s.by);
      const len=Math.hypot(bx-ax,by-ay);if(len<1)return;
      const dx=(bx-ax)/len,dy=(by-ay)/len,nx=-dy,ny=dx;

      if(isSC){
        // ‚îÄ‚îÄ Saint Creole grand cobblestone roads ‚îÄ‚îÄ
        // Outer kerb / sidewalk
        const sw=s.w+18;
        X.strokeStyle=`rgba(${~~(85*L.r)},${~~(78*L.g)},${~~(65*L.b)},.95)`;
        X.lineWidth=sw;X.lineCap='square';X.setLineDash([]);
        X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();
        // Sidewalk inner edge lines
        X.strokeStyle=`rgba(${~~(110*L.r)},${~~(100*L.g)},${~~(85*L.b)},.6)`;
        X.lineWidth=1.5;
        [-1,1].forEach(side=>{
          X.beginPath();
          X.moveTo(ax+nx*(s.w/2+2)*side,ay+ny*(s.w/2+2)*side);
          X.lineTo(bx+nx*(s.w/2+2)*side,by+ny*(s.w/2+2)*side);
          X.stroke();
        });
        // Road surface (cobblestone base)
        X.strokeStyle=`rgba(${~~(68*L.r)},${~~(62*L.g)},${~~(52*L.b)},.98)`;
        X.lineWidth=s.w;X.lineCap='round';
        X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();
        // Cobblestone grid lines (cross-hatch perpendicular)
        const steps=~~(len/16);
        X.strokeStyle=`rgba(${~~(48*L.r)},${~~(44*L.g)},${~~(36*L.b)},.45)`;X.lineWidth=1;
        for(let i=0;i<=steps;i++){
          const px=ax+dx*i*16,py=ay+dy*i*16;
          X.beginPath();X.moveTo(px-nx*s.w*.5,py-ny*s.w*.5);X.lineTo(px+nx*s.w*.5,py+ny*s.w*.5);X.stroke();
        }
        // Parallel cobble grooves
        const grooveSteps=~~(len/12);
        X.strokeStyle=`rgba(${~~(42*L.r)},${~~(38*L.g)},${~~(30*L.b)},.3)`;X.lineWidth=0.8;
        for(let i=0;i<=grooveSteps;i++){
          const px=ax+dx*i*12,py=ay+dy*i*12;
          [-s.w*.25,0,s.w*.25].forEach(offset=>{
            X.beginPath();X.moveTo(px+nx*offset-dx*4,py+ny*offset-dy*4);X.lineTo(px+nx*offset+dx*4,py+ny*offset+dy*4);X.stroke();
          });
        }
        // Centre divider line (double for big roads)
        if(s.w>=28){
          X.strokeStyle=`rgba(${~~(130*L.r)},${~~(118*L.g)},${~~(95*L.b)},.45)`;
          X.lineWidth=1.5;X.setLineDash([18,14]);
          X.beginPath();X.moveTo(ax+nx*4,ay+ny*4);X.lineTo(bx+nx*4,by+ny*4);X.stroke();
          X.beginPath();X.moveTo(ax-nx*4,ay-ny*4);X.lineTo(bx-nx*4,by-ny*4);X.stroke();
          X.setLineDash([]);
        } else {
          X.strokeStyle=`rgba(${~~(120*L.r)},${~~(108*L.g)},${~~(88*L.b)},.35)`;
          X.lineWidth=1.2;X.setLineDash([12,14]);
          X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();X.setLineDash([]);
        }
      } else {
        // ‚îÄ‚îÄ Dusty Western dirt roads ‚îÄ‚îÄ
        // Shoulder/verge
        X.strokeStyle=`rgba(${~~(85*L.r)},${~~(52*L.g)},${~~(18*L.b)},.55)`;
        X.lineWidth=s.w+10;X.lineCap='round';X.setLineDash([]);
        X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();
        // Road surface
        X.strokeStyle=`rgba(${~~(102*L.r)},${~~(60*L.g)},${~~(18*L.b)},.92)`;
        X.lineWidth=s.w;
        X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();
        // Wheel ruts
        [-1,1].forEach(side=>{
          X.strokeStyle=`rgba(${~~(70*L.r)},${~~(40*L.g)},${~~(10*L.b)},.4)`;
          X.lineWidth=2.5;
          X.beginPath();X.moveTo(ax+nx*s.w*.22*side,ay+ny*s.w*.22*side);X.lineTo(bx+nx*s.w*.22*side,by+ny*s.w*.22*side);X.stroke();
        });
        // Road edge lines
        [-1,1].forEach(side=>{
          X.strokeStyle=`rgba(${~~(120*L.r)},${~~(70*L.g)},${~~(20*L.b)},.35)`;
          X.lineWidth=1.2;
          X.beginPath();X.moveTo(ax+nx*s.w*.48*side,ay+ny*s.w*.48*side);X.lineTo(bx+nx*s.w*.48*side,by+ny*s.w*.48*side);X.stroke();
        });
        // Centre dash
        X.strokeStyle=`rgba(${~~(.35*255*L.r)},${~~(.17*200*L.g)},${~~(.05*200*L.b)},.4)`;
        X.lineWidth=1.2;X.setLineDash([10,12]);
        X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();X.setLineDash([]);
      }
    });
  });

  // ‚îÄ‚îÄ Inter-town roads ‚îÄ‚îÄ
  [[TOWNS[0],TOWNS[1]],[TOWNS[0],TOWNS[2]]].forEach(([a,b])=>{
    const[ax,ay]=ws(a.x,a.y),[bx,by]=ws(b.x,b.y);
    const len=Math.hypot(bx-ax,by-ay);if(len<1)return;
    const dx=(bx-ax)/len,dy=(by-ay)/len,nx=-dy,ny=dx;
    // Wide shoulder
    X.strokeStyle=`rgba(${~~(.38*255*L.r)},${~~(.20*180*L.g)},${~~(.05*180*L.b)},.55)`;
    X.lineWidth=32;X.lineCap='butt';X.setLineDash([]);X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();
    // Road surface
    X.strokeStyle=`rgba(${~~(.4*255*L.r)},${~~(.22*200*L.g)},${~~(.06*200*L.b)},.92)`;
    X.lineWidth=22;X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();
    // Edge lines
    [-1,1].forEach(side=>{
      X.strokeStyle=`rgba(${~~(.5*255*L.r)},${~~(.28*200*L.g)},${~~(.08*200*L.b)},.4)`;
      X.lineWidth=1.5;
      X.beginPath();X.moveTo(ax+nx*10*side,ay+ny*10*side);X.lineTo(bx+nx*10*side,by+ny*10*side);X.stroke();
    });
    // Wheel ruts
    [-1,1].forEach(side=>{
      X.strokeStyle=`rgba(${~~(.28*255*L.r)},${~~(.13*200*L.g)},${~~(.03*200*L.b)},.45)`;
      X.lineWidth=3;
      X.beginPath();X.moveTo(ax+nx*6*side,ay+ny*6*side);X.lineTo(bx+nx*6*side,by+ny*6*side);X.stroke();
    });
    // Centre dash
    X.strokeStyle=`rgba(${~~(.3*255*L.r)},${~~(.14*200*L.g)},${~~(.04*200*L.b)},.38)`;
    X.lineWidth=1.5;X.setLineDash([16,18]);X.beginPath();X.moveTo(ax,ay);X.lineTo(bx,by);X.stroke();X.setLineDash([]);
  });

  // ‚îÄ‚îÄ Swamp water ‚îÄ‚îÄ
  const t2=Date.now()/2200;
  SWWATER.forEach(w=>{const[sx,sy]=ws(w.x,w.y);if(sx<-130||sx>W+130||sy<-130||sy>H+130)return;
    const wg=Math.sin(t2+w.anim)*.06;
    X.fillStyle=`rgba(${~~(14*L.r)},${~~(38*L.g)},${~~(32*L.b)},.78)`;X.beginPath();X.ellipse(sx,sy,w.rx*(1+wg),w.ry,0,0,Math.PI*2);X.fill();
    X.strokeStyle=`rgba(${~~(24*L.r)},${~~(58*L.g)},${~~(48*L.b)},.45)`;X.lineWidth=1.8;X.stroke();
    X.strokeStyle=`rgba(${~~(35*L.r)},${~~(70*L.g)},${~~(58*L.b)},.2)`;X.lineWidth=1;X.beginPath();X.ellipse(sx,sy,w.rx*.65,w.ry*.65,0,0,Math.PI*2);X.stroke();
    X.strokeStyle=`rgba(${~~(50*L.r)},${~~(90*L.g)},${~~(75*L.b)},.12)`;X.lineWidth=1;X.beginPath();X.ellipse(sx+Math.sin(t2)*3,sy,w.rx*.35,w.ry*.35,0,0,Math.PI*2);X.stroke();
  });

  // ‚îÄ‚îÄ Desert sand dunes ‚îÄ‚îÄ
  DSAND.forEach(s=>{const[sx,sy]=ws(s.x,s.y);if(sx<-90||sx>W+90||sy<-90||sy>H+90)return;
    X.fillStyle=`rgba(${~~(195*L.r)},${~~(155*L.g)},${~~(75*L.b)},${s.a})`;X.beginPath();X.arc(sx,sy,s.r,0,Math.PI*2);X.fill();
  });

  // ‚îÄ‚îÄ Forest grass ‚îÄ‚îÄ
  FGRASS.forEach(g=>{const[sx,sy]=ws(g.x,g.y);if(sx<-6||sx>W+6||sy<-6||sy>H+6)return;
    const gv2=g.gv;const bw=biomeAt(g.x,g.y).f;if(bw<.05)return;
    const gc=`rgb(${~~(gv2*.24*L.r)},${~~(gv2*L.g)},${~~(gv2*.16*L.b)})`;
    const gc2=`rgb(${~~((gv2+40)*.26*L.r)},${~~((gv2+40)*L.g)},${~~((gv2+40)*.19*L.b)})`;
    // 3 blades per grass tuft
    for(let i=0;i<3;i++){
      X.strokeStyle=i===1?gc2:gc;X.lineWidth=1.2+i*.2;
      X.beginPath();X.moveTo(sx+i*3-3,sy);X.lineTo(sx+i*3-3+Math.sin(g.ang+i*.7)*g.len*.5,sy-g.len*(0.8+i*.1));X.stroke();
    }
  });
  // Forest bushes ‚Äî layered cluster style like sprite
  FBUSHES.forEach(b=>{const[sx,sy]=ws(b.x,b.y);if(sx<-44||sx>W+44||sy<-44||sy>H+44)return;
    const gv2=b.gv;const bw=biomeAt(b.x,b.y).f;if(bw<.04)return;
    const c1=`rgba(${~~(gv2*.24*L.r)},${~~(gv2*L.g)},${~~(gv2*.16*L.b)},${.65+bw*.3})`;
    const c2=`rgba(${~~((gv2+28)*.26*L.r)},${~~((gv2+28)*L.g)},${~~((gv2+28)*.19*L.b)},${.55+bw*.25})`;
    const c3=`rgba(${~~((gv2+55)*.29*L.r)},${~~((gv2+55)*L.g)},${~~((gv2+55)*.23*L.b)},${.42+bw*.2})`;
    // Base wide bush
    X.fillStyle=c1;X.beginPath();X.ellipse(sx,sy,b.r*1.15,b.r*.7,0,0,Math.PI*2);X.fill();
    // Left cluster
    X.fillStyle=c1;X.beginPath();X.arc(sx-b.r*.55,sy+b.r*.1,b.r*.65,0,Math.PI*2);X.fill();
    // Right cluster
    X.beginPath();X.arc(sx+b.r*.55,sy+b.r*.1,b.r*.6,0,Math.PI*2);X.fill();
    // Mid highlights
    X.fillStyle=c2;X.beginPath();X.arc(sx-b.r*.28,sy-b.r*.25,b.r*.52,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(sx+b.r*.22,sy-b.r*.18,b.r*.44,0,Math.PI*2);X.fill();
    // Top bright spot
    X.fillStyle=c3;X.beginPath();X.arc(sx-b.r*.1,sy-b.r*.44,b.r*.3,0,Math.PI*2);X.fill();
  });
  // Swamp moss
  SWMOSS.forEach(m=>{const[sx,sy]=ws(m.x,m.y);if(sx<-32||sx>W+32||sy<-32||sy>H+32)return;
    const sw=biomeAt(m.x,m.y).s;if(sw<.04)return;
    X.fillStyle=`rgba(${~~(m.gv*.18*L.r)},${~~(m.gv*.75*L.g)},${~~(m.gv*.15*L.b)},${.45+sw*.35})`;X.beginPath();X.ellipse(sx,sy,m.r*1.7,m.r*.65,0,0,Math.PI*2);X.fill();
  });

  // ‚îÄ‚îÄ Detailed Forest Trees ‚îÄ‚îÄ
  FTREES.forEach(tr=>{const[sx,sy]=ws(tr.x,tr.y);if(sx<-110||sx>W+110||sy<-110||sy>H+110)return;
    const bw=biomeAt(tr.x,tr.y).f;if(bw<.06)return;
    const tkw=4+tr.r*.13;
    // Trunk
    X.fillStyle=`rgb(${~~(82*L.r)},${~~(54*L.g)},${~~(24*L.b)})`;X.fillRect(sx-tkw/2,sy,tkw,tr.th);
    X.fillStyle='rgba(0,0,0,.22)';X.fillRect(sx-tkw/2,sy,tkw*.33,tr.th);
    X.strokeStyle='rgba(0,0,0,.16)';X.lineWidth=.75;
    for(let i=0;i<3;i++){X.beginPath();X.moveTo(sx-tkw/2+i*tkw*.38,sy+tr.th*.18);X.lineTo(sx-tkw/2+i*tkw*.38+.8,sy+tr.th*.82);X.stroke();}
    // Ground shadow
    X.fillStyle='rgba(0,0,0,.15)';X.beginPath();X.ellipse(sx+3,sy+tr.th*.45,tr.r*.88,tr.r*.3,0,0,Math.PI*2);X.fill();

    const g1=tr.g1,g2=tr.g2,g3=tr.g3,a=bw;
    if(tr.type==='pine'){
      // Layered pine/fir ‚Äî 3 stacked triangular tiers like the sprite
      const tiers=3,ph=tr.r*1.1;
      for(let t2=0;t2<tiers;t2++){
        const ty2=sy-tr.r*.2-t2*ph*.72,tw2=tr.r*(1.1-.3*t2);
        const cv=t2===0?g1:t2===1?g2:g3;
        const c1=`rgba(${~~(cv*.26*L.r)},${~~(cv*L.g)},${~~(cv*.18*L.b)},${a})`;
        const c2=`rgba(${~~((cv+35)*.28*L.r)},${~~((cv+35)*L.g)},${~~((cv+35)*.22*L.b)},${a*.8})`;
        X.fillStyle=c1;X.beginPath();X.moveTo(sx,ty2-ph*.55);X.lineTo(sx+tw2,ty2);X.lineTo(sx-tw2,ty2);X.closePath();X.fill();
        // Light patch top-left
        X.fillStyle=c2;X.beginPath();X.moveTo(sx,ty2-ph*.55);X.lineTo(sx+tw2*.35,ty2);X.lineTo(sx-tw2*.2,ty2);X.closePath();X.fill();
        // Dark right edge
        X.fillStyle=`rgba(${~~(cv*.17*L.r)},${~~(cv*.65*L.g)},${~~(cv*.12*L.b)},${a*.65})`;
        X.beginPath();X.moveTo(sx+tw2*.5,ty2-ph*.28);X.lineTo(sx+tw2,ty2);X.lineTo(sx+tw2*.2,ty2);X.closePath();X.fill();
      }
    } else if(tr.type==='dead'){
      // Bare/dead tree ‚Äî just trunk with jagged branches, no canopy
      X.strokeStyle=`rgb(${~~(62*L.r)},${~~(44*L.g)},${~~(22*L.b)})`;
      X.lineWidth=tkw*.7;X.beginPath();X.moveTo(sx,sy);X.lineTo(sx+tr.lean*10,sy-tr.th*1.4);X.stroke();
      // Branches
      X.lineWidth=tkw*.35;
      const brs=[[-1,-.55,.48],[-1,-.35,.38],[1,-.65,.5],[1,-.42,.4],[0,-.8,.32]];
      brs.forEach(([side,ht,len])=>{
        const bx2=sx+tr.lean*10*(-ht),by2=sy-tr.th*1.4*(-ht);
        X.beginPath();X.moveTo(bx2,by2);
        X.lineTo(bx2+side*tr.r*len,by2-tr.r*len*.45);X.stroke();
      });
    } else {
      // Round canopy ‚Äî original multi-circle style (like leafy/willow in sprite)
      X.fillStyle=`rgba(${~~(g1*.26*L.r)},${~~(g1*L.g)},${~~(g1*.18*L.b)},${a})`;X.beginPath();X.arc(sx+tr.lean*18,sy-tr.r*.12,tr.r,0,Math.PI*2);X.fill();
      X.fillStyle=`rgba(${~~(g2*.28*L.r)},${~~(g2*L.g)},${~~(g2*.20*L.b)},${a})`;X.beginPath();X.arc(sx+tr.lean*9-tr.r*.2,sy-tr.r*.56,tr.r*.77,0,Math.PI*2);X.fill();
      X.beginPath();X.arc(sx+tr.lean*9+tr.r*.24,sy-tr.r*.48,tr.r*.66,0,Math.PI*2);X.fill();
      X.fillStyle=`rgba(${~~(g3*.3*L.r)},${~~(g3*L.g)},${~~(g3*.22*L.b)},${a})`;X.beginPath();X.arc(sx+tr.lean*4,sy-tr.r*.92,tr.r*.53,0,Math.PI*2);X.fill();
      // Bright highlight blob
      X.fillStyle=`rgba(${~~(g3*.36*L.r)},${~~(Math.min(255,g3*1.08)*L.g)},${~~(g3*.26*L.b)},${a*.72})`;X.beginPath();X.arc(sx+tr.lean*4-tr.r*.17,sy-tr.r*.97,tr.r*.3,0,Math.PI*2);X.fill();
    }
  });

  // ‚îÄ‚îÄ Swamp Trees ‚îÄ‚îÄ
  SWTREES.forEach(tr=>{const[sx,sy]=ws(tr.x,tr.y);if(sx<-110||sx>W+110||sy<-110||sy>H+110)return;
    const sw=biomeAt(tr.x,tr.y).s;if(sw<.04)return;
    const lean=tr.lean;const dead=tr.dead;
    X.strokeStyle=dead?`rgba(${~~(55*L.r)},${~~(42*L.g)},${~~(30*L.b)},.85)`:`rgba(${~~(38*L.r)},${~~(34*L.g)},${~~(22*L.b)},.9)`;
    X.lineWidth=tr.r*.25;X.beginPath();X.moveTo(sx,sy+tr.r*.5);X.lineTo(sx+lean*tr.th,sy-tr.th*.72);X.stroke();
    X.strokeStyle=`rgba(${~~(30*L.r)},${~~(24*L.g)},${~~(15*L.b)},.65)`;X.lineWidth=1.8;
    for(let i=-2;i<=2;i++){X.beginPath();X.moveTo(sx+i*4,sy+tr.r*.4);X.lineTo(sx+i*9,sy+tr.r*.95);X.stroke();}
    if(!dead){
      X.fillStyle=`rgba(${~~(34*L.r)},${~~(62*L.g)},${~~(24*L.b)},${.7+sw*.25})`;X.beginPath();X.arc(sx+lean*tr.th*.72,sy-tr.th*.52,tr.r,0,Math.PI*2);X.fill();
      X.fillStyle=`rgba(${~~(28*L.r)},${~~(54*L.g)},${~~(18*L.b)},${.65+sw*.2})`;X.beginPath();X.arc(sx+lean*tr.th*.5-tr.r*.3,sy-tr.th*.67,tr.r*.68,0,Math.PI*2);X.fill();
      if(tr.moss){
        X.strokeStyle=`rgba(${~~(42*L.r)},${~~(82*L.g)},${~~(32*L.b)},.6)`;X.lineWidth=1.6;
        for(let i=0;i<6;i++){const mx=sx+lean*tr.th*.65+(i-2.5)*tr.r*.4,my=sy-tr.th*.42;
          X.beginPath();X.moveTo(mx,my);X.lineTo(mx+Math.sin(i*1.2)*7,my+10+i%3*4);X.stroke();}
      }
    }else{
      // Dead branch stubs
      X.strokeStyle=`rgba(${~~(55*L.r)},${~~(42*L.g)},${~~(30*L.b)},.5)`;X.lineWidth=1.5;
      for(let i=0;i<4;i++){const ba=lean+(i-2)*.4;X.beginPath();X.moveTo(sx+lean*tr.th*.5,sy-tr.th*.4);X.lineTo(sx+lean*tr.th*.5+Math.cos(ba)*12,sy-tr.th*.4+Math.sin(ba)*8);X.stroke();}
    }
  });

  // ‚îÄ‚îÄ Desert Cacti ‚îÄ‚îÄ
  DCACTUS.forEach(c=>{const[sx,sy]=ws(c.x,c.y);if(sx<-90||sx>W+90||sy<-90||sy>H+90)return;
    const dw=biomeAt(c.x,c.y).d;if(dw<.05)return;
    const cg=`rgba(${~~(52*L.r)},${~~(112*L.g)},${~~(42*L.b)},${.8+dw*.18})`;
    const cl=`rgba(${~~(36*L.r)},${~~(80*L.g)},${~~(28*L.b)},${.8+dw*.18})`;
    X.fillStyle='rgba(0,0,0,.16)';X.beginPath();X.ellipse(sx+5,sy+4,c.w*.75,c.w*.28,0,0,Math.PI*2);X.fill();
    X.fillStyle=cg;X.fillRect(sx-c.w/2,sy-c.h,c.w,c.h);
    X.fillStyle=cl;X.fillRect(sx-c.w/2,sy-c.h,c.w*.32,c.h);
    X.strokeStyle='rgba(0,0,0,.13)';X.lineWidth=.9;
    for(let i=0;i<3;i++){X.beginPath();X.moveTo(sx-c.w/2+i*c.w*.38,sy-c.h*.88);X.lineTo(sx-c.w/2+i*c.w*.38,sy-.5);X.stroke();}
    if(c.arms){
      const axp=sx+c.armSide*c.w*.45,ayp=sy-c.h*.58;X.fillStyle=cg;
      if(c.armSide>0){X.fillRect(axp,ayp,c.armH*.52,c.w*.82);X.fillRect(axp+c.armH*.42,ayp-c.armH*.38,c.w*.82,c.armH*.42);}
      else{X.fillRect(axp-c.armH*.52,ayp,c.armH*.52,c.w*.82);X.fillRect(axp-c.armH*.42-c.w*.82,ayp-c.armH*.38,c.w*.82,c.armH*.42);}
    }
    X.strokeStyle='rgba(255,242,200,.55)';X.lineWidth=.75;
    for(let i=0;i<6;i++){const sa=i*Math.PI/3,sr=c.w*.52+2;X.beginPath();X.moveTo(sx+Math.cos(sa)*sr,sy-c.h*.38+Math.sin(sa)*sr);X.lineTo(sx+Math.cos(sa)*(sr+4),sy-c.h*.38+Math.sin(sa)*(sr+4));X.stroke();}
  });
  // Desert rocks
  DROCKS.forEach(r=>{const[sx,sy]=ws(r.x,r.y);if(sx<-65||sx>W+65||sy<-65||sy>H+65)return;
    const rv2=r.c;X.fillStyle=`rgba(${~~(rv2*.8*L.r)},${~~(rv2*.66*L.g)},${~~(rv2*.50*L.b)},.88)`;X.beginPath();X.ellipse(sx,sy,r.w,r.h*.68,-.18,0,Math.PI*2);X.fill();
    X.fillStyle='rgba(0,0,0,.18)';X.beginPath();X.ellipse(sx,sy,r.w*.52,r.h*.33,-.18,0,Math.PI*2);X.fill();
  });

  // ‚îÄ‚îÄ Street Lights (poles only ‚Äî glow drawn in drawStreetLights) ‚îÄ‚îÄ
  drawStreetLightPoles();
}

function drawStreetLightPoles(){
  const L=lm();
  STREETLIGHTS.forEach(sl=>{
    const[sx,sy]=ws(sl.x,sl.y);if(sx<-20||sx>W+20||sy<-20||sy>H+20)return;
    const ph=sl.grand?32:24;const pw=sl.grand?2.5:2;
    // Pole
    X.fillStyle=`rgb(${~~(70*L.r)},${~~(60*L.g)},${~~(45*L.b)})`;X.fillRect(sx-pw/2,sy-ph,pw,ph);
    // Arm
    X.strokeStyle=`rgb(${~~(70*L.r)},${~~(60*L.g)},${~~(45*L.b)})`;X.lineWidth=1.5;
    X.beginPath();X.moveTo(sx,sy-ph+4);X.lineTo(sx+(sl.grand?10:7),sy-ph+4);X.lineTo(sx+(sl.grand?10:7),sy-ph+8);X.stroke();
    // Lamp housing
    X.fillStyle=`rgb(${~~(60*L.r)},${~~(52*L.g)},${~~(38*L.b)})`;X.fillRect(sx+(sl.grand?4:2),sy-ph+7,sl.grand?12:8,4);
  });
}

function drawStreetLightGlow(){
  const L=lm();const nightT=Math.max(0,Math.min(1,(tod<.25?1-tod/.25:tod>.78?(tod-.78)/.22:0)));
  if(nightT<.04)return;
  STREETLIGHTS.forEach(sl=>{
    const[sx,sy]=ws(sl.x,sl.y);if(sx<-150||sx>W+150||sy<-150||sy>H+150)return;
    const ph=sl.grand?32:24;const lx=sx+(sl.grand?10:6);const ly=sy-ph+9;
    const flicker=0.94+Math.sin(Date.now()/220+sl.x*.013)*.06;
    const gIntensity=nightT*flicker;
    const radius=sl.grand?140:90;

    // Wide ambient ground pool
    const poolGrd=X.createRadialGradient(lx,ly+8,0,lx,ly+8,radius*1.4);
    poolGrd.addColorStop(0,`rgba(255,210,100,${.18*gIntensity})`);
    poolGrd.addColorStop(0.5,`rgba(210,165,60,${.08*gIntensity})`);
    poolGrd.addColorStop(1,'rgba(0,0,0,0)');
    X.fillStyle=poolGrd;X.beginPath();X.ellipse(lx,ly+radius*.5,radius,radius*1.1,0,0,Math.PI*2);X.fill();

    // Main glow cone (large)
    const grd=X.createRadialGradient(lx,ly,0,lx,ly,radius);
    grd.addColorStop(0,`rgba(255,235,160,${.85*gIntensity})`);
    grd.addColorStop(0.15,`rgba(255,220,120,${.55*gIntensity})`);
    grd.addColorStop(0.4,`rgba(230,190,80,${.28*gIntensity})`);
    grd.addColorStop(0.7,`rgba(200,160,50,${.10*gIntensity})`);
    grd.addColorStop(1,'rgba(0,0,0,0)');
    X.fillStyle=grd;X.beginPath();X.arc(lx,ly,radius,0,Math.PI*2);X.fill();

    // Secondary bloom halo
    const bloom=X.createRadialGradient(lx,ly,0,lx,ly,radius*.45);
    bloom.addColorStop(0,`rgba(255,248,210,${.7*gIntensity})`);
    bloom.addColorStop(0.5,`rgba(255,235,150,${.3*gIntensity})`);
    bloom.addColorStop(1,'rgba(0,0,0,0)');
    X.fillStyle=bloom;X.beginPath();X.arc(lx,ly,radius*.45,0,Math.PI*2);X.fill();

    // Bright bulb core
    X.shadowColor=`rgba(255,235,140,${gIntensity})`;
    X.shadowBlur=sl.grand?40:28;
    X.fillStyle=`rgba(255,252,220,${gIntensity})`;
    X.beginPath();X.arc(lx,ly,sl.grand?4.5:3,0,Math.PI*2);X.fill();
    // Inner hot spot
    X.fillStyle=`rgba(255,255,255,${.95*gIntensity})`;
    X.beginPath();X.arc(lx,ly,sl.grand?2:1.5,0,Math.PI*2);X.fill();
    X.shadowBlur=0;
  });
}

function drawTracks(){
  const L=lm();
  X.strokeStyle=`rgba(${~~(88*L.r)},${~~(60*L.g)},${~~(30*L.b)},.63)`;X.lineWidth=5;X.setLineDash([20,10]);
  X.beginPath();TRACK.forEach((p,i)=>{const[sx,sy]=ws(p.x,p.y);i===0?X.moveTo(sx,sy):X.lineTo(sx,sy);});X.stroke();X.setLineDash([]);
  TRACK.forEach((p,i)=>{if(i===TRACK.length-1)return;const np=TRACK[i+1],dx=np.x-p.x,dy=np.y-p.y,l=Math.hypot(dx,dy),nx=dy/l*5,ny=-dx/l*5;const[sx,sy]=ws(p.x,p.y),[ex,ey]=ws(np.x,np.y);[-1,1].forEach(s=>{X.strokeStyle=`rgba(${~~(102*L.r)},${~~(80*L.g)},${~~(53*L.b)},.78)`;X.lineWidth=1.8;X.setLineDash([]);X.beginPath();X.moveTo(sx+nx*s,sy+ny*s);X.lineTo(ex+nx*s,ey+ny*s);X.stroke();});});
}

function drawTrain(){
  const L=lm(),[tsx,tsy]=ws(TRAIN.x,TRAIN.y);if(tsx<-200||tsx>W+200||tsy<-200||tsy>H+200)return;
  X.save();X.translate(tsx,tsy);X.rotate(TRAIN.ang);
  const nc=5,cl=37,cw=20,gap=6;
  for(let i=0;i<nc;i++){const cx=-(cl+gap)*(nc-1)/2+(cl+gap)*i;X.fillStyle='rgba(0,0,0,.2)';X.fillRect(cx-cl/2+3,-cw/2+3,cl,cw);X.fillStyle=i===0?`rgb(${~~(92*L.r)},${~~(26*L.g)},${~~(11*L.b)})`:`rgb(${~~(50*L.r)},${~~(37*L.g)},${~~(27*L.b)})`;X.fillRect(cx-cl/2,-cw/2,cl,cw);X.fillStyle='rgba(0,0,0,.27)';X.fillRect(cx-cl/2,-cw/2,cl,4);if(i>0){X.fillStyle='rgba(175,210,238,.3)';X.fillRect(cx-cl*.29,-4,cl*.23,8);X.fillRect(cx+cl*.06,-4,cl*.23,8);}for(const wy of[-1,1])for(const wx of[-.32,.32]){X.fillStyle=`rgb(${~~(53*L.r)},${~~(39*L.g)},${~~(24*L.b)})`;X.beginPath();X.arc(cx+wx*cl,wy*(cw/2+2),5,0,Math.PI*2);X.fill();}if(i===0){X.fillStyle=`rgb(${~~(118*L.r)},${~~(72*L.g)},${~~(17*L.b)})`;X.fillRect(cx+cl*.22,-4,7,8);}}
  for(let i=0;i<3;i++){const pf=Math.sin(Date.now()/175+i)*.4;X.fillStyle=`rgba(215,215,215,${.21-i*.06})`;X.beginPath();X.arc(-(cl+gap)*(nc-1)/2-cl*.4,-(cw/2+7+i*6+pf*3),3.5+i*3,0,Math.PI*2);X.fill();}
  X.restore();
  if(TRAIN.robbable){X.fillStyle='rgba(4,2,1,.88)';X.fillRect(tsx-44,tsy-34,88,16);X.fillStyle='#c88c18';X.font='bold 9px Georgia';X.textAlign='center';X.textBaseline='middle';X.fillText('[ G ] ROB',tsx,tsy-26);}
}

function drawBuilding(b){
  const L=lm(),[sx,sy]=ws(b.x,b.y),hw=b.w/2,hh=b.h/2;if(sx+hw<-10||sx-hw>W+10||sy+hh<-10||sy-hh>H+10)return;
  const sh=col=>{const r=parseInt(col.slice(1,3),16),g=parseInt(col.slice(3,5),16),bl=parseInt(col.slice(5,7),16);return`rgb(${~~(r*L.r)},${~~(g*L.g)},${~~(bl*L.b)})`;};
  X.fillStyle='rgba(0,0,0,.2)';X.fillRect(sx-hw+6,sy-hh+8,b.w,b.h);
  X.fillStyle=sh(b.c);X.fillRect(sx-hw,sy-hh,b.w,b.h);
  if(b.sdStyle){
    // Ornate Saint Denis style: columns, arches, decorative facade
    // Columns
    const nc=Math.max(2,~~(b.w/30));
    for(let i=0;i<=nc;i++){const cx=sx-hw+i*(b.w/nc);X.fillStyle=sh('#c8b888');X.fillRect(cx-2,sy-hh,4,b.h);}
    // Horizontal decorative bands
    X.fillStyle=sh('#c8b888');X.fillRect(sx-hw,sy-hh,b.w,6);X.fillRect(sx-hw,sy-hh+b.h*.35,b.w,4);X.fillRect(sx-hw,sy-hh+b.h*.65,b.w,3);
    // Arched windows
    const nw=Math.max(1,~~(b.w/42));
    for(let i=0;i<nw;i++){const wsx=sx-hw+22+i*(b.w-30)/Math.max(1,nw-1),wsy=sy-hh+b.h*.2;
      X.fillStyle='rgba(120,160,200,.38)';X.beginPath();X.arc(wsx,wsy+10,9,Math.PI,0);X.fillRect(wsx-9,wsy+10,18,14);X.fill();
      X.strokeStyle=sh('#c8b888');X.lineWidth=1.5;X.beginPath();X.arc(wsx,wsy+10,9,Math.PI,0);X.moveTo(wsx-9,wsy+10);X.lineTo(wsx-9,wsy+24);X.moveTo(wsx+9,wsy+10);X.lineTo(wsx+9,wsy+24);X.stroke();}
    // Grand entrance
    X.fillStyle='rgba(0,0,0,.55)';X.fillRect(sx-10,sy+hh-28,20,28);X.strokeStyle=sh('#c8b888');X.lineWidth=2;X.beginPath();X.arc(sx,sy+hh-28,10,Math.PI,0);X.stroke();
    // Roof ornament
    X.fillStyle=sh(b.rf);X.fillRect(sx-hw-6,sy-hh,b.w+12,10);
    X.fillStyle=sh('#d4c090');X.fillRect(sx-hw-4,sy-hh-8,b.w+8,9);
    // Corner turrets for large buildings
    if(b.w>130){[-hw,hw-8].forEach(cx=>{X.fillStyle=sh(b.rf);X.fillRect(sx+cx,sy-hh-18,8,18);X.fillStyle=sh('#d4c090');X.beginPath();X.moveTo(sx+cx,sy-hh-18);X.lineTo(sx+cx+4,sy-hh-28);X.lineTo(sx+cx+8,sy-hh-18);X.fill();});}
    // Cathedral: extra spires + rose window
    if(b.cathed){
      [-hw+10,0,hw-10].forEach((cx,ci)=>{
        const spH=ci===1?38:28;
        X.fillStyle=sh(b.rf);X.fillRect(sx+cx-4,sy-hh-spH,8,spH);
        X.fillStyle=sh('#d4c090');X.beginPath();X.moveTo(sx+cx-5,sy-hh-spH);X.lineTo(sx+cx,sy-hh-spH-14);X.lineTo(sx+cx+5,sy-hh-spH);X.fill();
      });
      // Rose window
      X.strokeStyle=sh('#d4c090');X.lineWidth=1.5;X.beginPath();X.arc(sx,sy-hh+b.h*.28,10,0,Math.PI*2);X.stroke();
      for(let i=0;i<8;i++){const ra=i*Math.PI/4;X.beginPath();X.moveTo(sx,sy-hh+b.h*.28);X.lineTo(sx+Math.cos(ra)*10,sy-hh+b.h*.28+Math.sin(ra)*10);X.stroke();}
    }
  }else{
    for(let i=1;i<4;i++){X.strokeStyle='rgba(0,0,0,.065)';X.lineWidth=1;X.beginPath();X.moveTo(sx-hw,sy-hh+i*b.h/4);X.lineTo(sx+hw,sy-hh+i*b.h/4);X.stroke();}
    X.fillStyle=sh(b.rf);X.fillRect(sx-hw-5,sy-hh,b.w+10,12);
    [[sx-hw+17,sy-hh+27],[sx+hw-27,sy-hh+27]].forEach(([wx,wy])=>{if(Math.abs(wx-sx)<hw-5){X.fillStyle='rgba(195,175,78,.13)';X.fillRect(wx-9,wy-8,18,16);X.strokeStyle='rgba(145,118,48,.3)';X.lineWidth=1;X.strokeRect(wx-9,wy-8,18,16);}});
  }
  X.fillStyle='rgba(4,2,1,.67)';X.fillRect(sx-b.w*.34,sy-hh+13,b.w*.68,12);
  X.fillStyle=b.isShop?'#ffce50':b.isGen?'#56be56':b.isCasino?'#dd88ff':b.isCloth?'#ff88cc':b.isHarbour?'#88ddff':'#e8c87a';
  X.font='bold 9px Georgia';X.textAlign='center';X.textBaseline='middle';
  b.lb.split('\n').forEach((ln,i)=>X.fillText(ln,sx,sy-hh+18+i*8));
  const near=Math.abs(P.x-b.x)<b.w/2+68&&Math.abs(P.y-b.y)<b.h/2+68;
  if(near&&(b.isShop||b.isGen||b.isCasino||b.isCloth)){
    X.fillStyle='rgba(252,200,42,.8)';X.font='6px Georgia';X.textAlign='center';
    X.fillText(b.isShop?'[ E ] GUN SHOP':b.isGen?'[ E ] GENERAL STORE':b.isCasino?'[ E ] CASINO':'[ E ] TAILOR',sx,sy+hh+15);
  }
  // Casino glow
  if(b.isCasino){X.strokeStyle=`rgba(180,80,255,${.3+Math.sin(Date.now()/400)*.2})`;X.lineWidth=2;X.strokeRect(sx-hw,sy-hh,b.w,b.h);}
  // Harbour glow
  if(b.isHarbour){X.strokeStyle=`rgba(80,160,255,${.25+Math.sin(Date.now()/600)*.15})`;X.lineWidth=2.5;X.strokeRect(sx-hw,sy-hh,b.w,b.h);}
}

function drawNPC(n){
  if(!n.alive)return;
  const[sx,sy]=ws(n.x,n.y);
  if(sx<-140||sx>W+140||sy<-140||sy>H+140)return;
  const L=lm();
  const t=Date.now()/1000;

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     Shared pixel-block helper.  f(gridX, gridY, w, h, color)
     draws a solid rectangle of (w x h) PS-sized pixel blocks
     offset from the NPC screen position (sx, sy).
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  const drawSprite=(PS,OX,OY,blocks)=>{
    for(const[gx,gy,w,h,c]of blocks){
      X.fillStyle=c;
      X.fillRect(sx+(OX+gx)*PS, sy+(OY+gy)*PS, w*PS, h*PS);
    }
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DEAD WEST  ‚Äî  skeleton cowboy, Papyrus-inspired
     White/bone body, big skull, wide shoulders, red cape,
     cowboy hat, dual leather holsters, two revolvers.
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  if(n.isDeadWest){
    const PS=5;                       // pixel-block size (px)
    const OX=-8, OY=-25;              // grid origin offset  (centres sprite on sx,sy)
    const f=(gx,gy,w,h,c)=>{X.fillStyle=c;X.fillRect(sx+(OX+gx)*PS,sy+(OY+gy)*PS,w*PS,h*PS);};

    const hit = n.hf>0;
    // Palette
    const W2  = hit?'#ff5050':`rgb(${~~(235*L.r)},${~~(232*L.g)},${~~(222*L.b)})`;// bone white
    const WD  = hit?'#cc2020':`rgb(${~~(175*L.r)},${~~(171*L.g)},${~~(163*L.b)})`;// bone shadow
    const BLK = '#111';                 // outline
    const CPE = '#8b0000';              // cape red
    const CPL = '#b30000';              // cape lighter
    const CPD = '#4a0000';              // cape dark edge
    const HAT = `rgb(${~~(14*L.r)},${~~(10*L.g)},${~~(7*L.b)})`;   // hat near-black
    const HATD= `rgb(${~~(7*L.r)},${~~(5*L.g)},${~~(3*L.b)})`;     // hat underside
    const BND = '#8a0000';              // hat band
    const GLD = `rgb(${~~(210*L.r)},${~~(175*L.g)},${~~(15*L.b)})`; // gold
    const HST = '#2e1a08';              // holster dark
    const HSL = '#52300f';              // holster face
    const GUN = '#1a1208';              // gun metal dark
    const GNH = '#3a2a18';              // gun metal highlight
    const EYE = `rgba(255,${~~(15+Math.sin(t*3.8)*15)},0,${.9+Math.sin(t*4.5)*.1})`; // red glow

    // Animation
    const walk = (Math.sin(t*4.2)*1)|0;   // leg alternation  (-1,0,+1)
    const bob  = (Math.sin(t*2.6)*.9)|0;  // head/hat bob
    const arm  = (Math.sin(t*3.0)*.8)|0;  // arm swing
    const cw   = (Math.sin(t*1.9)*.8)|0;  // cape wave (left/right shift)

    // ‚îÄ‚îÄ Hellfire aura (behind everything) ‚îÄ‚îÄ
    const ag=X.createRadialGradient(sx,sy,0,sx,sy,n.sz*4.5);
    ag.addColorStop(0,`rgba(200,0,0,${.16+Math.sin(t*2.2)*.07})`);
    ag.addColorStop(.55,'rgba(90,0,0,.05)');
    ag.addColorStop(1,'rgba(0,0,0,0)');
    X.fillStyle=ag;X.beginPath();X.arc(sx,sy,n.sz*4.5,0,Math.PI*2);X.fill();

    // ‚îÄ‚îÄ CAPE (drawn first ‚Äî behind body) ‚îÄ‚îÄ
    // Shadow/dark edge
    f(1+cw, 9,13,13,CPD);
    // Main cape body
    f(2+cw, 9,11,12,CPE);
    // Left lighter fold
    f(2+cw, 9, 4,10,CPL);
    // Bottom split tabs
    f(2+cw,21, 4, 3,CPE);
    f(10+cw,21, 4, 3,CPE);
    // Bottom tab shadows
    f(6+cw,21, 4, 1,CPD);
    // Cape top collar dark trim
    f(5,  9, 6, 2,CPD);
    // Gold clasp
    f(7,  8, 2, 2,GLD);
    f(7,  8, 2, 2,BLK); // clasp centre shadow (overdraws centre)
    X.fillStyle=GLD;X.fillRect(sx+(OX+7.3)*PS,sy+(OY+8.3)*PS,.4*PS,.4*PS);

    // ‚îÄ‚îÄ BOOTS ‚îÄ‚îÄ
    f(2,22+walk, 4,3,WD);     // left boot
    f(9,22-walk, 4,3,WD);     // right boot
    f(2,22+walk, 3,2,W2);     // left face
    f(9,22-walk, 3,2,W2);     // right face
    f(1,24+walk, 1,1,GLD);    // left spur
    f(13,24-walk,1,1,GLD);    // right spur

    // ‚îÄ‚îÄ LEGS (bone) ‚îÄ‚îÄ
    f(3,17+walk, 3,5,W2);     // left
    f(9,17-walk, 3,5,W2);     // right
    f(3,17+walk, 1,5,WD);     // left shading
    f(11,17-walk,1,5,WD);     // right shading
    f(3,19,      3,1,WD);     // left knee
    f(9,19,      3,1,WD);     // right knee

    // ‚îÄ‚îÄ DUAL HOLSTERS ‚îÄ‚îÄ
    // Left
    f(0,14, 3,1,GLD);          // trim top
    f(0,15, 3,5,HST);          // pouch dark
    f(0,15, 2,4,HSL);          // pouch face
    f(0,19, 3,1,GLD);          // trim bottom
    // Right
    f(12,14,3,1,GLD);
    f(12,15,3,5,HST);
    f(12,15,2,4,HSL);
    f(12,19,3,1,GLD);
    // Belt connecting them
    f(0,13,15,2,HST);
    f(7,12, 2,3,GLD);          // buckle
    f(7,13, 2,1,BLK);          // buckle hole

    // ‚îÄ‚îÄ TORSO (skeleton ribcage) ‚îÄ‚îÄ
    // Outline
    f(2, 7,11,8,BLK);
    // Body fill
    f(3, 7, 9,7,W2);
    // Left/right side shading
    f(3, 7, 1,7,WD);
    f(11,7, 1,7,WD);
    // Rib lines (horizontal bone detail)
    f(3, 8,9,1,WD);
    f(3,10,9,1,WD);
    f(3,12,9,1,WD);
    // Spine (vertical centre shadow)
    f(7, 7,2,7,'rgba(0,0,0,.22)');
    // Pelvis bottom bar
    f(2,14,11,1,WD);

    // ‚îÄ‚îÄ WIDE SHOULDERS (signature Papyrus look) ‚îÄ‚îÄ
    // Left pad outline + fill
    f(-1,5, 5,5,BLK);
    f( 0,5, 4,4,W2);
    f( 0,5, 4,1,'rgba(255,255,255,.22)'); // top shine
    f( 3,5, 1,4,WD);                      // right edge shadow
    f( 0,8, 4,1,WD);                      // bottom shadow
    // Right pad
    f(11,5, 5,5,BLK);
    f(11,5, 4,4,W2);
    f(11,5, 4,1,'rgba(255,255,255,.22)');
    f(14,5, 1,4,WD);
    f(11,8, 4,1,WD);

    // ‚îÄ‚îÄ ARMS (bone) ‚îÄ‚îÄ
    // Outline boxes
    f(-2, 8,3,11,BLK);
    f(14, 8,3,11,BLK);
    // Upper arm
    f(-1, 8+arm,2,5,W2);
    f(14, 8-arm,2,5,W2);
    // Elbow knob
    f(-1,12+arm,2,1,WD);
    f(14,12-arm,2,1,WD);
    // Forearm
    f(-1,13+arm,2,4,W2);
    f(14,13-arm,2,4,W2);
    // Bony hand
    f(-2,17+arm,3,3,W2);
    f(14,17-arm,3,3,W2);
    f(-1,19+arm,2,1,WD);  // finger shadow
    f(14,19-arm,2,1,WD);

    // ‚îÄ‚îÄ DUAL REVOLVERS ‚îÄ‚îÄ
    // Left (barrel points left)
    f(-5,17+arm,3,1,GUN);  // barrel
    f(-4,18+arm,2,2,GUN);  // grip
    f(-5,17+arm,1,1,GNH);  // muzzle glint
    f(-3,18+arm,1,1,GNH);  // frame glint
    // Right (barrel points right)
    f(17,17-arm,3,1,GUN);
    f(17,18-arm,2,2,GUN);
    f(19,17-arm,1,1,GNH);
    f(17,18-arm,1,1,GNH);

    // ‚îÄ‚îÄ NECK ‚îÄ‚îÄ
    f(6, 5,4,3,W2);
    f(6, 6,4,1,WD);

    // ‚îÄ‚îÄ SKULL ‚îÄ‚îÄ
    // Skull overall outline
    f(3,-3+bob,10,12,BLK);
    // Cranium dome top
    f(4,-2+bob, 8, 2,W2);
    // Cranium main body
    f(3, 0+bob,10, 5,W2);
    // Cranium shading
    f(3, 0+bob, 1, 5,WD);    // left
    f(12,0+bob, 1, 5,WD);    // right
    f(4,-2+bob, 1, 1,WD);    // top-left corner
    f(11,-2+bob,1, 1,WD);    // top-right corner
    // Brow ridge (dark strip)
    f(3, 1+bob,10, 1,WD);
    // ‚îÄ‚îÄ Eye sockets (BLACK) ‚îÄ‚îÄ
    f(4, 2+bob, 3, 3,BLK);
    f(9, 2+bob, 3, 3,BLK);
    // ‚îÄ‚îÄ Glowing red eyes inside sockets ‚îÄ‚îÄ
    X.fillStyle=EYE;
    X.fillRect(sx+(OX+4.35)*PS,sy+(OY+2.35+bob)*PS,2.3*PS,2.3*PS);
    X.fillRect(sx+(OX+9.35)*PS,sy+(OY+2.35+bob)*PS,2.3*PS,2.3*PS);
    // Eye spark centre
    X.fillStyle=`rgba(255,220,60,${.55+Math.sin(t*6)*.45})`;
    X.fillRect(sx+(OX+5.2)*PS,sy+(OY+3.1+bob)*PS,.8*PS,.8*PS);
    X.fillRect(sx+(OX+10.2)*PS,sy+(OY+3.1+bob)*PS,.8*PS,.8*PS);
    // Nasal cavity
    f(7, 4+bob, 2, 1,BLK);
    // Jaw + teeth
    f(4, 5+bob, 8, 3,W2);     // jaw block
    f(4, 5+bob, 8, 1,WD);     // top shadow
    // Tooth gap lines
    f(4, 5+bob, 1, 2,BLK);
    f(6, 5+bob, 1, 2,BLK);
    f(8, 5+bob, 1, 2,BLK);
    f(10,5+bob, 1, 2,BLK);
    // Jaw bottom
    f(4, 7+bob, 8, 1,WD);

    // ‚îÄ‚îÄ COWBOY HAT ‚îÄ‚îÄ
    // Wide brim outline
    f(-3,-8+bob,22,3,BLK);
    // Brim face
    f(-2,-8+bob,20,2,HAT);
    f(-2,-8+bob,20,1,'rgba(255,255,255,.05)'); // top sheen
    // Brim underside (darker)
    f(-2,-7+bob,20,1,HATD);
    // Crown outline
    f( 2,-15+bob,12,8,BLK);
    // Crown face
    f( 3,-14+bob,10,6,HAT);
    f( 3,-14+bob,10,1,'rgba(255,255,255,.07)'); // shine
    // Crown pinch dent
    f( 6,-14+bob, 4, 1,'rgba(0,0,0,.35)');
    // Red hat band
    f( 3, -9+bob,10, 1,BND);
    // Gold skull-and-crossbones pin
    f( 7, -9+bob, 2, 1,GLD);

    // HP bar
    if(n.hp<n.maxHp){
      const bw=84,bh=8,bx=sx-bw/2,by=sy+(OY-17+bob)*PS-14;
      X.fillStyle='rgba(0,0,0,.85)';X.fillRect(bx,by,bw,bh);
      const pct=n.hp/n.maxHp;
      X.fillStyle=`hsl(${~~(pct*48)},90%,38%)`;X.fillRect(bx,by,bw*pct,bh);
      X.strokeStyle='rgba(160,0,0,.8)';X.lineWidth=1;X.strokeRect(bx,by,bw,bh);
    }
    // Name plate
    const npW=104,npH=17,npX=sx-npW/2,npY=sy+(OY-20+bob)*PS-16;
    X.fillStyle='rgba(50,0,0,.94)';X.fillRect(npX,npY,npW,npH);
    X.strokeStyle=`rgba(200,0,0,${.5+Math.sin(t*3)*.5})`;X.lineWidth=1.5;X.strokeRect(npX,npY,npW,npH);
    X.fillStyle=`rgba(255,${15+~~(Math.sin(t*5)*18)},0,1)`;
    X.font='bold 9px Georgia';X.textAlign='center';X.textBaseline='middle';
    X.fillText('\u{1F480} DEAD WEST',sx,npY+8.5);
    if(!n.hostile){
      X.fillStyle='rgba(215,195,55,.9)';X.font='bold 9px Georgia';X.textAlign='center';
      X.fillText('DO NOT PROVOKE',sx,sy+(OY+27)*PS+6);
    }
    return;
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STANDARD NPC  ‚Äî  circle model matching player style
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  {
    const OX=0, OY=0; // kept for HP bar / bounty tag offsets below

    // ‚îÄ‚îÄ circle-based model matching player style ‚îÄ‚îÄ
    X.save();X.translate(sx,sy);X.rotate(n.ang+Math.PI/2);
    if(n.hf>0){X.shadowColor='#ff2c2c';X.shadowBlur=14;}
    // Ground shadow
    X.fillStyle='rgba(0,0,0,.18)';X.beginPath();X.ellipse(2,4,n.sz,n.sz*.4,0,0,Math.PI*2);X.fill();
    // Body (coat colour)
    const CR=parseInt(n.coat.slice(1,3),16),CG=parseInt(n.coat.slice(3,5),16),CB=parseInt(n.coat.slice(5,7),16);
    X.fillStyle=n.hf>0?'#c82020':`rgb(${~~(CR*L.r)},${~~(CG*L.g)},${~~(CB*L.b)})`;
    X.beginPath();X.arc(0,0,n.sz,0,Math.PI*2);X.fill();
    X.fillStyle='rgba(0,0,0,.22)';X.beginPath();X.arc(0,0,n.sz,Math.PI*.25,Math.PI*1.75);X.closePath();X.fill();
    // Face (skin)
    const SR=parseInt(n.skn.slice(1,3),16),SG=parseInt(n.skn.slice(3,5),16),SB=parseInt(n.skn.slice(5,7),16);
    X.fillStyle=`rgb(${~~(SR*L.r)},${~~(SG*L.g)},${~~(SB*L.b)})`;
    X.beginPath();X.arc(0,-n.sz*.1,n.sz*.54,0,Math.PI*2);X.fill();
    // Eyes
    X.fillStyle='rgba(0,0,0,.7)';
    X.beginPath();X.arc(-n.sz*.2,-n.sz*.12,n.sz*.11,0,Math.PI*2);X.fill();
    X.beginPath();X.arc(n.sz*.2,-n.sz*.12,n.sz*.11,0,Math.PI*2);X.fill();
    // Hat
    const HR=parseInt(n.hat.slice(1,3),16),HG=parseInt(n.hat.slice(3,5),16),HB=parseInt(n.hat.slice(5,7),16);
    X.fillStyle=`rgb(${~~(HR*L.r)},${~~(HG*L.g)},${~~(HB*L.b)})`;
    if(n.hatStyle===2){
      // bandana
      X.beginPath();X.arc(0,-n.sz*.1,n.sz*.62,Math.PI,0);X.fill();
      X.fillStyle=`rgb(${~~(HR*.7*L.r)},${~~(HG*.7*L.g)},${~~(HB*.7*L.b)})`;
      X.fillRect(-n.sz*.5,-n.sz*.25,n.sz,6);
    } else {
      // cowboy hat brim
      X.beginPath();X.ellipse(0,-n.sz*.65,n.sz*.78,n.sz*.22,0,0,Math.PI*2);X.fill();
      // crown
      X.fillRect(-n.sz*.42,-n.sz*1.08,n.sz*.84,n.sz*.67);
    }
    // Gun barrel
    X.fillStyle='#1c1816';X.fillRect(n.sz*.54,-3,n.sz*.85,4);
    // Gang bandana
    if(n.isG&&n.gC){
      const GCR=parseInt(n.gC.slice(1,3),16),GCG=parseInt(n.gC.slice(3,5),16),GCB=parseInt(n.gC.slice(5,7),16);
      X.fillStyle=`rgba(${~~(Math.min(255,GCR+65)*L.r)},${~~(Math.min(255,GCG+65)*L.g)},${~~(Math.min(255,GCB+65)*L.b)},.88)`;
      X.beginPath();X.arc(0,-n.sz*.1,n.sz*.62,Math.PI,0);X.fill();
    }
    X.shadowBlur=0;X.restore();

    // HP bar
    if(n.hp<n.maxHp){
      const bw=n.sz*2.2,bh=4,bx=sx-bw/2,by=sy-n.sz-14;
      X.fillStyle='rgba(0,0,0,.72)';X.fillRect(bx,by,bw,bh);
      X.fillStyle=`hsl(${~~(n.hp/n.maxHp*110)},85%,38%)`;X.fillRect(bx,by,bw*(n.hp/n.maxHp),bh);
    }

    // Bounty tag
    if(n.isBounty){
      const cl2=Math.hypot(P.x-n.x,P.y-n.y)<300,tw=70,th=14;
      const tbx=sx-tw/2, tby=sy-n.sz-28;
      X.save();X.globalAlpha=cl2?1:.5;
      X.fillStyle='rgba(6,3,1,.93)';X.fillRect(tbx,tby,tw,th);
      X.strokeStyle=n.hostile?'rgba(210,30,15,.8)':n.isG?'rgba(165,65,65,.55)':'rgba(165,118,30,.55)';
      X.lineWidth=1;X.strokeRect(tbx,tby,tw,th);
      X.fillStyle=n.bounty>=300?'#ff7412':n.bounty>=150?'#e4b814':'#c29c35';
      X.font='bold 9px Georgia';X.textAlign='center';X.textBaseline='middle';
      X.fillText('$'+n.bounty,sx,tby+7);
      X.globalAlpha=1;X.restore();
    }
  }
}

function drawPolice(p){
  if(!p.alive)return;const[sx,sy]=ws(p.x,p.y);if(sx<-80||sx>W+80||sy<-80||sy>H+80)return;
  const L=lm();X.save();X.translate(sx,sy);X.rotate(p.ang+Math.PI/2);
  if(p.hf>0){X.shadowColor='#3a74e8';X.shadowBlur=13;}
  X.fillStyle='rgba(0,0,0,.17)';X.beginPath();X.ellipse(2,4,p.sz,p.sz*.4,0,0,Math.PI*2);X.fill();
  X.fillStyle=p.hf>0?'hsl(220,78%,48%)':`rgb(${~~(50*L.r)},${~~(80*L.g)},${~~(118*L.b)})`;X.beginPath();X.arc(0,0,p.sz,0,Math.PI*2);X.fill();
  X.fillStyle='#bc8e6c';X.beginPath();X.arc(0,-p.sz*.1,p.sz*.54,0,Math.PI*2);X.fill();
  X.fillStyle=`rgb(${~~(25*L.r)},${~~(43*L.g)},${~~(72*L.b)})`;X.beginPath();X.ellipse(0,-p.sz*.65,p.sz*.71,p.sz*.2,0,0,Math.PI*2);X.fill();X.fillRect(-p.sz*.41,-p.sz-2,p.sz*.82,p.sz*.64);
  X.fillStyle='#e6cc58';X.shadowColor='#ffd700';X.shadowBlur=5;X.beginPath();for(let i=0;i<5;i++){const a=i*Math.PI*.4-Math.PI/2;X.lineTo(Math.cos(a)*5,Math.sin(a)*5+2);X.lineTo(Math.cos(a+Math.PI*.2)*2,Math.sin(a+Math.PI*.2)*2+2);}X.closePath();X.fill();X.shadowBlur=0;
  X.fillStyle='#1c1816';X.fillRect(p.sz*.54,-3,p.sz*.83,5);
  if(p.hp<p.maxHp){X.fillStyle='rgba(0,0,0,.5)';X.fillRect(-p.sz,-p.sz-10,p.sz*2,4);X.fillStyle='#3674e8';X.fillRect(-p.sz,-p.sz-10,p.sz*2*(p.hp/p.maxHp),4);}
  X.restore();
  X.fillStyle='rgba(4,2,1,.72)';X.fillRect(sx-21,sy-p.sz-22,42,12);X.fillStyle='#3674e8';X.font='6px Georgia';X.textAlign='center';X.textBaseline='middle';X.fillText('DEPUTY',sx,sy-p.sz-16);
}

function drawRider(r){
  if(!r.alive)return;const[sx,sy]=ws(r.x,r.y);if(sx<-120||sx>W+120||sy<-120||sy>H+120)return;
  const L=lm();X.save();X.translate(sx,sy);X.rotate(r.ang+Math.PI/2);
  if(r.hf>0){X.shadowColor='#ff2c2c';X.shadowBlur=17;}
  X.fillStyle=`rgb(${~~(83*L.r)},${~~(53*L.g)},${~~(23*L.b)})`;X.beginPath();X.ellipse(0,6,r.sz*.83,r.sz*.54,0,0,Math.PI*2);X.fill();
  X.fillStyle=`rgb(${~~(73*L.r)},${~~(46*L.g)},${~~(19*L.b)})`;X.beginPath();X.ellipse(0,-r.sz*.4,r.sz*.34,r.sz*.54,0,0,Math.PI*2);X.fill();
  X.strokeStyle=`rgb(${~~(63*L.r)},${~~(39*L.g)},${~~(14*L.b)})`;X.lineWidth=3;const lp=Date.now()/100;[[-7,0],[7,0],[-5,0],[5,0]].forEach(([ox],i)=>{const la=Math.sin(lp+i*1.5)*.3;X.beginPath();X.moveTo(ox,10);X.lineTo(ox+Math.sin(la)*8,10+Math.cos(la)*8);X.stroke();});
  const rc=parseInt(r.col.slice(1,3),16),rcg=parseInt(r.col.slice(3,5),16),rcb=parseInt(r.col.slice(5,7),16);
  X.fillStyle=r.hf>0?'hsl(0,78%,31%)':`rgb(${~~(rc*L.r)},${~~(rcg*L.g)},${~~(rcb*L.b)})`;X.beginPath();X.arc(0,-r.sz*.2,r.sz*.44,0,Math.PI*2);X.fill();
  X.fillStyle=r.hat;X.beginPath();X.ellipse(0,-r.sz*.74,r.sz*.49,r.sz*.14,0,0,Math.PI*2);X.fill();X.fillRect(-r.sz*.27,-r.sz-.4,r.sz*.54,r.sz*.49);
  X.fillStyle='#1c1816';X.fillRect(r.sz*.39,-4,r.sz*.69,5);X.shadowBlur=0;
  if(r.hp<r.maxHp){X.fillStyle='rgba(0,0,0,.5)';X.fillRect(-r.sz,-r.sz-10,r.sz*2,4);X.fillStyle='#c83418';X.fillRect(-r.sz,-r.sz-10,r.sz*2*(r.hp/r.maxHp),4);}
  X.restore();
}

function drawPlayer(){
  const[sx,sy]=ws(P.x,P.y),L=lm();X.save();X.translate(sx,sy);X.rotate(P.angle+Math.PI/2);
  if(P.dashT>0){X.globalAlpha=.27;X.fillStyle='#e8c87a';X.beginPath();X.arc(0,0,PRAD*2.2,0,Math.PI*2);X.fill();X.globalAlpha=1;}
  X.fillStyle='rgba(0,0,0,.19)';X.beginPath();X.ellipse(2,4,PRAD,PRAD*.4,0,0,Math.PI*2);X.fill();
  // Body (coat color)
  const cc=PA.coat.color;const cr2=parseInt(cc.slice(1,3)||'5A',16),cg2=parseInt(cc.slice(3,5)||'35',16),cb2=parseInt(cc.slice(5,7)||'18',16);
  X.fillStyle=`rgb(${~~(cr2*L.r)},${~~(cg2*L.g)},${~~(cb2*L.b)})`;X.beginPath();X.arc(0,0,PRAD,0,Math.PI*2);X.fill();
  X.fillStyle=`rgba(0,0,0,.22)`;X.beginPath();X.arc(0,0,PRAD,Math.PI*.25,Math.PI*1.75);X.closePath();X.fill();
  // Skin
  const sc=PA.skin.color;const sr2=parseInt(sc.slice(1,3),16),sg2=parseInt(sc.slice(3,5),16),sb2=parseInt(sc.slice(5,7),16);
  X.fillStyle=`rgb(${~~(sr2*L.r)},${~~(sg2*L.g)},${~~(sb2*L.b)})`;X.beginPath();X.arc(0,-PRAD*.1,PRAD*.54,0,Math.PI*2);X.fill();
  // Hat
  const hc=PA.hat.color;
  if(PA.hat.id!=='none'&&hc!=='transparent'){const hr=parseInt(hc.slice(1,3),16),hg2=parseInt(hc.slice(3,5),16),hbl=parseInt(hc.slice(5,7),16);X.fillStyle=`rgb(${~~(hr*L.r)},${~~(hg2*L.g)},${~~(hbl*L.b)})`;}
  else X.fillStyle='#0e0805';
  X.beginPath();X.ellipse(0,-PRAD*.64,PRAD*.75,PRAD*.21,0,0,Math.PI*2);X.fill();X.fillRect(-PRAD*.42,-PRAD-2,PRAD*.84,PRAD*.67);
  if(flashT>0){X.fillStyle=`rgba(255,${122+~~(Math.random()*76)},0,${flashT/.07})`;X.shadowColor='#ff8a00';X.shadowBlur=13;X.beginPath();X.arc(PRAD*1.5,0,Math.random()*5+4,0,Math.PI*2);X.fill();X.shadowBlur=0;}
  X.restore();
}

function drawBullet(b,enemy){
  const[sx,sy]=ws(b.x,b.y);X.save();
  if(!b.sg&&b.tr.length>1){X.globalAlpha=.27;X.strokeStyle=b.isBlue?'#00cfff':b.rainbow?`hsl(${Date.now()/4%360},100%,60%)`:enemy?'#ff3c1c':'#ffdc76';X.lineWidth=b.isBlue?3:enemy?2:b.rainbow?3:2.5;X.beginPath();const[tx,ty]=ws(b.tr[0][0],b.tr[0][1]);X.moveTo(tx,ty);b.tr.slice(1).forEach(t=>{const[x2,y2]=ws(t[0],t[1]);X.lineTo(x2,y2);});X.stroke();X.globalAlpha=1;}
  const exp=b.sp==='explode';
  if(b.isBlue){
    // Blue plasma burst ‚Äî cyan core, blue outer glow, aura rings
    const pulse=Math.sin(Date.now()/80)*0.15;
    X.shadowColor='#00aaff';X.shadowBlur=22+pulse*8;
    X.fillStyle='#00eeff';X.beginPath();X.arc(sx,sy,5,0,Math.PI*2);X.fill();
    X.fillStyle='#0066ff';X.globalAlpha=.5;X.beginPath();X.arc(sx,sy,9,0,Math.PI*2);X.fill();
    X.globalAlpha=.22+pulse;X.strokeStyle='#44aaff';X.lineWidth=1.5;X.beginPath();X.arc(sx,sy,13,0,Math.PI*2);X.stroke();
    X.globalAlpha=1;
  }else if(b.rainbow){
    const hue=(Date.now()/3+b.x+b.y)%360;
    X.fillStyle=`hsl(${hue},100%,60%)`;X.shadowColor=`hsl(${hue},100%,70%)`;X.shadowBlur=18;
    X.beginPath();X.arc(sx,sy,5,0,Math.PI*2);X.fill();
    X.globalAlpha=.4;X.strokeStyle=`hsl(${(hue+120)%360},100%,70%)`;X.lineWidth=1.5;X.beginPath();X.arc(sx,sy,8,0,Math.PI*2);X.stroke();X.globalAlpha=1;
  }else{
    X.fillStyle=exp?'#ff7c14':enemy?'#ff3c1c':'#ffdb58';X.shadowColor=exp?'#ff8800':enemy?'#ff1600':'#ffca00';X.shadowBlur=exp?13:6;X.beginPath();X.arc(sx,sy,exp?7:enemy?3.5:3.8,0,Math.PI*2);X.fill();
  }
  X.restore();
}

function drawParts(){
  for(const p of PARTS){const[sx,sy]=ws(p.x,p.y);X.save();switch(p.t){case 0:X.fillStyle=p.c;X.globalAlpha=Math.min(1,p.life*2);X.beginPath();X.arc(sx,sy,p.r*Math.min(1,p.life*2),0,Math.PI*2);X.fill();break;case 1:X.globalAlpha=p.life*.36;X.fillStyle=`rgba(175,125,52,${p.life*.3})`;X.beginPath();X.arc(sx,sy,p.r,0,Math.PI*2);X.fill();break;case 2:X.globalAlpha=p.life/.28;X.fillStyle='#ffac14';X.shadowColor='#ff9400';X.shadowBlur=7;X.beginPath();X.arc(sx,sy,p.r*Math.max(.1,p.life/.28),0,Math.PI*2);X.fill();break;case 3:X.globalAlpha=Math.min(1,p.life/.65*2);X.fillStyle='#c49614';X.save();X.translate(sx,sy);X.rotate(p.ag);X.fillRect(-4,-2,8,4);X.restore();break;case 4:{const tr=p.r/p.mr;X.globalAlpha=Math.min(.5,tr*(p.life/28)*1.5);X.fillStyle='#4c0000';X.beginPath();X.ellipse(sx,sy,p.r,p.r*.5,0,0,Math.PI*2);X.fill();}break;case 5:X.fillStyle=`hsl(${16+Math.random()*26},100%,${46+Math.random()*27}%)`;X.globalAlpha=p.life/.55;X.shadowColor='#ff7400';X.shadowBlur=8;X.beginPath();X.arc(sx,sy,p.r,0,Math.PI*2);X.fill();break;case 6:X.strokeStyle=`rgba(252,142,16,${1-p.r/p.mr})`;X.lineWidth=4*(1-p.r/p.mr);X.beginPath();X.arc(sx,sy,p.r,0,Math.PI*2);X.stroke();break;}X.restore();}
}

// remote MP players
const REMOTES={};
function drawRemotes(){
  const L=lm();
  Object.values(REMOTES).forEach(r=>{
    if(!r.alive)return;
    const[sx,sy]=ws(r.x,r.y);
    if(sx<-80||sx>W+80||sy<-80||sy>H+80)return;

    // Parse appearance colours (fallback to defaults)
    const cc=r.coat||'#5A3518';
    const sc=r.skin||'#c8a878';
    const hc=r.hat||'#1a0d05';
    const cr2=parseInt(cc.slice(1,3)||'5A',16),cg2=parseInt(cc.slice(3,5)||'35',16),cb2=parseInt(cc.slice(5,7)||'18',16);
    const sr2=parseInt(sc.slice(1,3),16),sg2=parseInt(sc.slice(3,5),16),sb2=parseInt(sc.slice(5,7),16);
    const hr=parseInt(hc.slice(1,3)||'1a',16),hg2=parseInt(hc.slice(3,5)||'0d',16),hbl=parseInt(hc.slice(5,7)||'05',16);

    X.save();X.translate(sx,sy);X.rotate((r.angle||0)+Math.PI/2);

    // Shadow
    X.fillStyle='rgba(0,0,0,.19)';X.beginPath();X.ellipse(2,4,PRAD,PRAD*.4,0,0,Math.PI*2);X.fill();

    // Body (coat)
    X.fillStyle=`rgb(${~~(cr2*L.r)},${~~(cg2*L.g)},${~~(cb2*L.b)})`;
    X.beginPath();X.arc(0,0,PRAD,0,Math.PI*2);X.fill();
    X.fillStyle='rgba(0,0,0,.22)';X.beginPath();X.arc(0,0,PRAD,Math.PI*.25,Math.PI*1.75);X.closePath();X.fill();

    // Skin face
    X.fillStyle=`rgb(${~~(sr2*L.r)},${~~(sg2*L.g)},${~~(sb2*L.b)})`;
    X.beginPath();X.arc(0,-PRAD*.1,PRAD*.54,0,Math.PI*2);X.fill();

    // Hat
    const noHat=r.hatId==='none'||hc==='transparent';
    if(!noHat){
      X.fillStyle=`rgb(${~~(hr*L.r)},${~~(hg2*L.g)},${~~(hbl*L.b)})`;
      X.beginPath();X.ellipse(0,-PRAD*.64,PRAD*.75,PRAD*.21,0,0,Math.PI*2);X.fill();
      X.fillRect(-PRAD*.42,-PRAD-2,PRAD*.84,PRAD*.67);
    }

    // Gun barrel
    X.fillStyle='#1c1816';X.fillRect(PRAD*.54,-2,PRAD*.88,4);

    X.restore();

    // Yellow outline ring to distinguish from NPCs
    X.strokeStyle='rgba(220,195,50,.6)';X.lineWidth=1.5;
    X.beginPath();X.arc(sx,sy,PRAD+3,0,Math.PI*2);X.stroke();

    // Name tag
    const nm=r.name||'?';
    X.font='bold 14px Georgia';X.textAlign='center';X.textBaseline='middle';
    const tw=X.measureText(nm).width+12;
    X.fillStyle='rgba(4,2,1,.88)';X.fillRect(sx-tw/2,sy-PRAD-28,tw,18);
    X.strokeStyle='rgba(220,185,40,.5)';X.lineWidth=1;X.strokeRect(sx-tw/2,sy-PRAD-28,tw,18);
    X.fillStyle='#ffd84a';X.fillText(nm,sx,sy-PRAD-19);

    // HP bar
    if(r.hp!=null&&r.hp<100){
      const bw=PRAD*2.4,bh=4,bx=sx-bw/2,by=sy-PRAD-32;
      X.fillStyle='rgba(0,0,0,.6)';X.fillRect(bx,by,bw,bh);
      X.fillStyle=`hsl(${~~(r.hp/100*110)},85%,42%)`;X.fillRect(bx,by,bw*(r.hp/100),bh);
    }

    // Level badge
    X.font='bold 9px Georgia';X.fillStyle='rgba(4,2,1,.8)';
    X.fillRect(sx+PRAD-1,sy-PRAD-1,18,14);
    X.fillStyle='#e8c060';X.fillText(''+r.lv,sx+PRAD+8,sy-PRAD+6);
  });
}

// minimap
function drawMinimap(){
  const S=.018,mw=146,mh=146;MX.fillStyle='rgba(4,2,1,.88)';MX.fillRect(0,0,mw,mh);
  // Biome regions
  MX.fillStyle='rgba(22,50,10,.55)';MX.fillRect(mw/2+(FOREST.x-cam.x)*S,mh/2+(FOREST.y-cam.y)*S,FOREST.w*S,FOREST.h*S);
  MX.fillStyle='rgba(100,75,20,.45)';MX.fillRect(mw/2+(DESERT.x-cam.x)*S,mh/2+(DESERT.y-cam.y)*S,DESERT.w*S,DESERT.h*S);
  MX.fillStyle='rgba(10,38,28,.5)';MX.fillRect(mw/2+(SWAMP.x-cam.x)*S,mh/2+(SWAMP.y-cam.y)*S,SWAMP.w*S,SWAMP.h*S);
  TOWNS.forEach(t=>{const tx=mw/2+(t.x-cam.x)*S,ty=mh/2+(t.y-cam.y)*S;MX.fillStyle='rgba(165,115,28,.28)';MX.beginPath();MX.arc(tx,ty,t.r*S,0,Math.PI*2);MX.fill();});
  MX.strokeStyle='rgba(108,86,48,.43)';MX.lineWidth=1;MX.setLineDash([3,4]);MX.beginPath();TRACK.forEach((p,i)=>{const tx=mw/2+(p.x-cam.x)*S,ty=mh/2+(p.y-cam.y)*S;i===0?MX.moveTo(tx,ty):MX.lineTo(tx,ty);});MX.stroke();MX.setLineDash([]);
  npcs.forEach(n=>{if(!n.alive)return;const nx=mw/2+(n.x-cam.x)*S,ny=mh/2+(n.y-cam.y)*S;MX.fillStyle=n.isBounty?'#be2614':'#384ebe';MX.beginPath();MX.arc(nx,ny,2.3,0,Math.PI*2);MX.fill();});
  police.forEach(p=>{if(!p.alive)return;const nx=mw/2+(p.x-cam.x)*S,ny=mh/2+(p.y-cam.y)*S;MX.fillStyle='#3674e8';MX.beginPath();MX.arc(nx,ny,2.3,0,Math.PI*2);MX.fill();});
  MX.font='12px serif';MX.fillText('üöÇ',mw/2+(TRAIN.x-cam.x)*S-4,mh/2+(TRAIN.y-cam.y)*S+4);
  Object.values(REMOTES).forEach(r=>{const rx=mw/2+(r.x-cam.x)*S,ry=mh/2+(r.y-cam.y)*S;MX.fillStyle='#d8c038';MX.beginPath();MX.arc(rx,ry,2.8,0,Math.PI*2);MX.fill();});
  MX.fillStyle='#e8c87a';MX.beginPath();MX.arc(mw/2,mh/2,4,0,Math.PI*2);MX.fill();
  MX.strokeStyle='rgba(135,88,16,.23)';MX.lineWidth=1;MX.strokeRect(0,0,mw,mh);
}

let lastLoc='';
function checkLoc(){
  let loc=null;TOWNS.forEach(t=>{if(Math.hypot(P.x-t.x,P.y-t.y)<t.r)loc=t;});
  const bm=biomeAt(P.x,P.y);
  let nm,sub;
  if(loc){nm=loc.name;sub=loc.sub;}
  else if(bm.f>0.55){nm=FOREST.name;sub=FOREST.sub;}
  else if(bm.d>0.55){nm='SCORCHED FLATS';sub='DRY & DANGEROUS';}
  else if(bm.s>0.55){nm='BAYOU NOIR';sub='DARK WATERS';}
  else if(bm.f>0.25&&bm.s>0.15){nm='MISTY BORDERLANDS';sub='FOREST MEETS SWAMP';}
  else if(bm.f>0.25&&bm.d>0.15){nm='DUSTY TIMBERLINE';sub='FOREST EDGE';}
  else{nm='THE FRONTIER';sub='DANGEROUS OPEN LAND';}
  if(nm!==lastLoc){lastLoc=nm;document.getElementById('ln').textContent=nm;document.getElementById('ls').textContent=sub;const el=document.getElementById('lc');el.style.opacity='1';setTimeout(()=>el.style.opacity='0',3200);}
}

// ‚îÄ‚îÄ AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aiMove(e,dt){
  if(!e.alive)return;if(e.hf>0)e.hf-=dt;
  const dx=P.x-e.x,dy=P.y-e.y,d=Math.hypot(dx,dy);e.ang=Math.atan2(dy,dx);
  if(d>((e.sz||12)*2.5)){const s=(e.spd||80)*dt/d;e.x+=dx*s;e.y+=dy*s;const[rx,ry]=resolveP(e.x,e.y,e.sz||12);e.x=rx;e.y=ry;}
  e.st-=dt;if(e.st<=0&&d<490){e.st=(e.sr||2)*(Math.random()*.5+.75);const err=(Math.random()-.5)*.16;eBullets.push({x:e.x+Math.cos(e.ang)*(e.sz||12),y:e.y+Math.sin(e.ang)*(e.sz||12),vx:Math.cos(e.ang+err)*365,vy:Math.sin(e.ang+err)*365,life:1.5,tr:[],dmg:e.dmg||8});}
}
function killNPC(n){
  if(!n.alive)return;n.alive=false;pBlood(n.x,n.y,24);pPool(n.x,n.y);cam.shake=Math.max(cam.shake,6);
  if(n.isDeadWest){
    addMoney(9999);addXP(500);cam.shake=25;
    showFB('üíÄ DEAD WEST DEFEATED! +$9999','#ff4400');showFK('+$9999 | +500XP | LEGEND');
    deadWestNPC=null;mpKill(n.x,n.y);return;
  }
  if(n.isBounty){addMoney(n.bounty);const xpG=~~(n.bounty/4)+15;addXP(xpG);showFB('‚ò† +$'+n.bounty,'#dcc018');showFK('+$'+n.bounty+' | +'+xpG+'XP');if(n.isG)setTimeout(()=>spawnRiders(n),1500);addWanted(1);mpKill(n.x,n.y);const ti=n.ti;respawnQ.push({t:28+Math.random()*14,fn:()=>mkBounty(ti)});}
  else if(n.isCiv){addWanted(2);showFK('INNOCENT KILLED');addXP(2);const ti=n.ti;respawnQ.push({t:14,fn:()=>mkCiv(ti)});}
}

// ‚îÄ‚îÄ MAIN UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(dt){
  if(!gameOn||!P.alive||shopOpen||gstOpen||chatOpen||casinoOpen||adminOpen||ncodeOpen||clothOpen)return;
  tod=(tod+dt*.004)%1;
  mouse.wx=(mouse.x-CX)+cam.x;mouse.wy=(mouse.y-CY)+cam.y;P.angle=Math.atan2(mouse.wy-P.y,mouse.wx-P.x);
  autoT-=dt;if(mouse.dn&&autoT<=0&&!P.reloading){doShoot();autoT=P.gun.fr;}
  if(P.shootCD>0){P.shootCD-=dt;document.getElementById('cdf').style.width=((1-P.shootCD/P.gun.fr)*100)+'%';}else document.getElementById('cdf').style.width='100%';
  if(P.inv>0)P.inv-=dt;if(flashT>0)flashT-=dt;
  if(P.reloading){P.reloadT-=dt;if(P.reloadT<=0)finishReload();}
  if((K['ShiftLeft']||K['ShiftRight'])&&P.dashCD<=0&&P.dashT<=0){const dx=(K['KeyD']?1:0)-(K['KeyA']?1:0),dy=(K['KeyS']?1:0)-(K['KeyW']?1:0);if(dx||dy){const l=Math.hypot(dx,dy);P.dvx=dx/l*555;P.dvy=dy/l*555;P.dashT=.15;P.dashCD=.7;P.inv=.2;cam.shake=Math.max(cam.shake,4);}}
  if(P.dashCD>0)P.dashCD-=dt;
  let mx=0,my=0;
  if(P.dashT>0){P.dashT-=dt;mx=P.dvx;my=P.dvy;}
  else{if(K['KeyW']||K['ArrowUp'])my-=1;if(K['KeyS']||K['ArrowDown'])my+=1;if(K['KeyA']||K['ArrowLeft'])mx-=1;if(K['KeyD']||K['ArrowRight'])mx+=1;const ml=Math.hypot(mx,my)||1;if(mx||my){mx=mx/ml*200;my=my/ml*200;}}
  P.x+=mx*dt;P.y+=my*dt;[P.x,P.y]=resolveP(P.x,P.y,PRAD);
  cam.x+=(P.x-cam.x)*10*dt;cam.y+=(P.y-cam.y)*10*dt;
  if(cam.shake>0){cam.shake*=.7;if(cam.shake<.1)cam.shake=0;cam.sx=(Math.random()-.5)*cam.shake;cam.sy=(Math.random()-.5)*cam.shake;}else{cam.sx=0;cam.sy=0;}
  if(bsT>0){bsT-=dt;if(bsT<=0)document.getElementById('bs').style.opacity='0';}
  if(wanted>0){wDecay-=dt;document.getElementById('wdf').style.width=(wDecay/WDM*100)+'%';if(wDecay<=0){wanted--;wDecay=WDM;uiWanted();}}
  for(let i=respawnQ.length-1;i>=0;i--){respawnQ[i].t-=dt;if(respawnQ[i].t<=0){npcs.push(respawnQ[i].fn());respawnQ.splice(i,1);}}
  updTrain(dt);
  npcs.forEach(n=>{
    if(!n.alive)return;if(n.hf>0)n.hf-=dt;
    if(n.isDeadWest){
      // Dead West: only hostile if player has shot him; never delivers killing blow
      if(n.hostile){
        const dx2=P.x-n.x,dy2=P.y-n.y,d2=Math.hypot(dx2,dy2);
        n.ang=Math.atan2(dy2,dx2);
        if(d2>n.sz*2.5){const s=(n.spd)*dt/d2;n.x+=dx2*s;n.y+=dy2*s;[n.x,n.y]=resolveP(n.x,n.y,n.sz);}
        n.st-=dt;
        if(n.st<=0&&d2<550){
          n.st=n.sr*(Math.random()*.5+.75);
          // Dead West fires 3-burst blue rainbow gun, 10x damage
          for(let _b=0;_b<3;_b++){
            setTimeout(()=>{
              if(!n.alive)return;
              const err=(Math.random()-.5)*.10;
              eBullets.push({x:n.x+Math.cos(n.ang)*n.sz,y:n.y+Math.sin(n.ang)*n.sz,
                vx:Math.cos(n.ang+err)*500,vy:Math.sin(n.ang+err)*500,
                life:1.6,tr:[],dmg:n.dmg*10,isDeadWest:true,isBlue:true});
            },_b*55);
          }
        }
      } else {
        // Passive wander
        n.wt-=dt;
        if(n.wt<=0){n.wt=3+Math.random()*4;const t=TOWNS[n.ti];n.wtx=t.x+(Math.random()-.5)*400;n.wty=t.y+(Math.random()-.5)*400;}
        const wdx=n.wtx-n.x,wdy=n.wty-n.y,wd=Math.hypot(wdx,wdy);
        if(wd>20){const s=n.spd*.4*dt/wd;n.x+=wdx*s;n.y+=wdy*s;[n.x,n.y]=resolveP(n.x,n.y,n.sz);n.ang=Math.atan2(wdy,wdx);}
      }
      return;
    }
    if(n.hostile)aiMove(n,dt);
    else{n.wt-=dt;if(n.wt<=0){n.wt=3+Math.random()*4;const t=TOWNS[n.ti];n.wtx=t.x+(Math.random()-.5)*290;n.wty=t.y+(Math.random()-.5)*290;}const wdx=n.wtx-n.x,wdy=n.wty-n.y,wd=Math.hypot(wdx,wdy);if(wd>15){const s=n.spd*.35*dt/wd;n.x+=wdx*s;n.y+=wdy*s;[n.x,n.y]=resolveP(n.x,n.y,n.sz);n.ang=Math.atan2(wdy,wdx);}}
  });
  police.forEach(p=>{if(p.alive)aiMove(p,dt);});riders.forEach(r=>{if(r.alive){aiMove(r,dt);if(Math.random()<.28)pHoof(r.x,r.y);}});
  // player bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];if(!b.sg){b.tr.push([b.x,b.y]);if(b.tr.length>6)b.tr.shift();}b.x+=b.vx*dt;b.y+=b.vy*dt;b.life-=dt;let hit=false;
    if(b.sp==='explode'){const near=npcs.some(n=>n.alive&&Math.hypot(b.x-n.x,b.y-n.y)<92)||police.some(p=>p.alive&&Math.hypot(b.x-p.x,b.y-p.y)<92)||riders.some(r=>r.alive&&Math.hypot(b.x-r.x,b.y-r.y)<92);if(near||bWall(b.x,b.y)||b.life<=0){pExp(b.x,b.y);cam.shake=Math.max(cam.shake,14);npcs.forEach(n=>{if(!n.alive)return;if(Math.hypot(b.x-n.x,b.y-n.y)<76){n.hp-=3;n.hf=.12;n.hostile=true;if(n.hp<=0)killNPC(n);}});police.forEach(p=>{if(!p.alive)return;if(Math.hypot(b.x-p.x,b.y-p.y)<76){p.hp-=4;p.hf=.12;if(p.hp<=0)p.alive=false;}});riders.forEach(r=>{if(!r.alive)return;if(Math.hypot(b.x-r.x,b.y-r.y)<76){r.hp-=4;r.hf=.12;if(r.hp<=0){r.alive=false;addXP(12);}}});bullets.splice(i,1);continue;}}
    for(let j=0;j<npcs.length&&!hit;j++){const n=npcs[j];if(!n.alive)continue;if(Math.hypot(b.x-n.x,b.y-n.y)<n.sz+5){n.hp-=b.dmg;n.hf=.13;pBlood(n.x,n.y,b.sg?4:8);cam.shake=Math.max(cam.shake,3);if(n.isDeadWest&&!n.hostile){n.hostile=true;showFB('üíÄ DEAD WEST RISES!','#cc0000');cam.shake=20;}n.hostile=true;if(n.hp<=0)killNPC(n);hit=true;}}
    for(let j=0;j<police.length&&!hit;j++){const p=police[j];if(!p.alive)continue;if(Math.hypot(b.x-p.x,b.y-p.y)<p.sz+5){p.hp-=b.dmg;p.hf=.13;pBlood(p.x,p.y,5);cam.shake=Math.max(cam.shake,3);if(p.hp<=0){p.alive=false;addXP(15);showFK('DEPUTY DOWN');}hit=true;}}
    for(let j=0;j<riders.length&&!hit;j++){const r=riders[j];if(!r.alive)continue;if(Math.hypot(b.x-r.x,b.y-r.y)<r.sz+5){r.hp-=b.dmg;r.hf=.13;pBlood(r.x,r.y,5);cam.shake=Math.max(cam.shake,3);if(r.hp<=0){r.alive=false;addXP(12);showFK('RIDER DOWN');}hit=true;}}
    if(!hit&&bWall(b.x,b.y)){pDust(b.x,b.y);hit=true;}
    if(hit||b.life<=0)bullets.splice(i,1);
  }
  // enemy bullets
  for(let i=eBullets.length-1;i>=0;i--){const b=eBullets[i];b.tr.push([b.x,b.y]);if(b.tr.length>4)b.tr.shift();b.x+=b.vx*dt;b.y+=b.vy*dt;b.life-=dt;if(Math.hypot(b.x-P.x,b.y-P.y)<PRAD+4&&P.inv<=0){const dmg=b.isDeadWest?Math.min(b.dmg||8,Math.max(0,P.hp-1)):b.dmg||8;damageP(dmg);eBullets.splice(i,1);continue;}if(bWall(b.x,b.y)||b.life<=0){eBullets.splice(i,1);continue;}}
  // particles
  for(let i=PARTS.length-1;i>=0;i--){const p=PARTS[i];if(p.t===4){p.r=Math.min(p.mr,p.r+(p.mr-p.r)*3*dt);p.life-=dt*.022;if(p.life<=0)PARTS.splice(i,1);continue;}if(p.t===6){p.r=Math.min(p.mr,p.r+p.mr*dt*3);p.life-=dt*2.3;if(p.life<=0)PARTS.splice(i,1);continue;}const drag=p.t===2?.73:p.t===5?.57:.85;p.vx*=(1-drag*dt*3);p.vy*=(1-drag*dt*3);if(p.t===0||p.t===3)p.vy+=292*dt;p.x+=p.vx*dt;p.y+=p.vy*dt;if(p.t===3)p.ag+=p.sp*dt;const dr=p.t===1?1.1:p.t===2?3.5:p.t===5?1.62:1.5;p.life-=dt*dr;if(p.life<=0)PARTS.splice(i,1);}
  // stale remote cleanup
  const now=Date.now();Object.keys(REMOTES).forEach(k=>{if(now-REMOTES[k].lastSeen>8000)delete REMOTES[k];});
  uiHp();checkLoc();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  drawSky();drawGround();drawTracks();
  drawStreetLightGlow();
  for(const p of PARTS)if(p.t===4){const[sx,sy]=ws(p.x,p.y);X.save();X.globalAlpha=Math.min(.48,(p.r/p.mr)*(p.life/28)*1.5);X.fillStyle='#4c0000';X.beginPath();X.ellipse(sx,sy,p.r,p.r*.5,0,0,Math.PI*2);X.fill();X.restore();}
  TOWNS.forEach(t=>t.blds.forEach(drawBuilding));
  drawTrain();drawParts();
  eBullets.forEach(b=>drawBullet(b,true));bullets.forEach(b=>drawBullet(b,false));
  npcs.filter(n=>n.alive).forEach(drawNPC);police.forEach(p=>p.alive&&drawPolice(p));riders.forEach(r=>r.alive&&drawRider(r));
  drawRemotes();drawPlayer();drawMinimap();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLOTHING STORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Player appearance state
const PA={
  hat:{id:'cowboy',name:'COWBOY HAT',color:'#1a0d05'},
  coat:{id:'duster',name:'DUSTER',color:'#5A3518'},
  skin:{id:'tan',name:'TAN',color:'#c8a878'},
  belt:{id:'plain',name:'PLAIN BELT',color:'#3a2008'},
};
const CLTH_ITEMS={
  hat:[
    {id:'cowboy',name:'COWBOY HAT',color:'#1a0d05',price:0,owned:true,icon:'ü§†'},
    {id:'derby',name:'DERBY HAT',color:'#181010',price:800,owned:false,icon:'üé©'},
    {id:'straw',name:'STRAW HAT',color:'#c8a060',price:350,owned:false,icon:'üéì'},
    {id:'military',name:'MILITARY CAP',color:'#2a3a18',price:1200,owned:false,icon:'‚õë'},
    {id:'bandana',name:'BANDANA',color:'#8a1010',price:200,owned:false,icon:'üß£'},
    {id:'none',name:'NO HAT',color:'transparent',price:0,owned:true,icon:'¬∑'},
  ],
  coat:[
    {id:'duster',name:'DUSTER COAT',color:'#5A3518',price:0,owned:true,icon:'üß•'},
    {id:'dark',name:'BLACK COAT',color:'#18100a',price:1500,owned:false,icon:'üï¥'},
    {id:'red',name:'RED JACKET',color:'#7a1818',price:2000,owned:false,icon:'üéΩ'},
    {id:'blue',name:'BLUE VEST',color:'#1a2a5a',price:1200,owned:false,icon:'üëï'},
    {id:'green',name:'RANGER COAT',color:'#2a4a1a',price:1800,owned:false,icon:'üåø'},
    {id:'white',name:'WHITE SHIRT',color:'#d8c8a8',price:600,owned:false,icon:'üëî'},
  ],
  skin:[
    {id:'tan',name:'TAN',color:'#c8a878',price:0,owned:true,icon:'ü§é'},
    {id:'light',name:'LIGHT',color:'#e0c898',price:0,owned:true,icon:'üíõ'},
    {id:'dark',name:'DARK',color:'#a07040',price:0,owned:true,icon:'üü§'},
    {id:'very_dark',name:'DEEP',color:'#6a4828',price:0,owned:true,icon:'‚¨õ'},
    {id:'olive',name:'OLIVE',color:'#b89858',price:0,owned:true,icon:'ü´í'},
  ],
  belt:[
    {id:'plain',name:'PLAIN BELT',color:'#3a2008',price:0,owned:true,icon:'‚¨õ'},
    {id:'silver',name:'SILVER BUCKLE',color:'#585860',price:500,owned:false,icon:'‚ö°'},
    {id:'gold',name:'GOLD BUCKLE',color:'#7a6020',price:2500,owned:false,icon:'‚òÖ'},
    {id:'fancy',name:'STUDDED',color:'#4a1808',price:1500,owned:false,icon:'üíé'},
  ],
};
let clthActiveTab='hat';
function openClothing(){
  clothOpen=true;
  document.getElementById('clth').style.display='flex';
  document.getElementById('clth-money').textContent='FUNDS: $'+P.money.toLocaleString();
  document.getElementById('clth-pname').textContent=P.name||'OUTLAW';
  renderClthGrid();drawClthAvatar();updateClthEquipped();
}
function closeClothing(){clothOpen=false;document.getElementById('clth').style.display='none';}
function clthTab(tab,el){clthActiveTab=tab;document.querySelectorAll('.clth-tab').forEach(e=>e.classList.remove('on'));el.classList.add('on');renderClthGrid();}
function renderClthGrid(){
  const grid=document.getElementById('clth-grid');grid.innerHTML='';
  const items=CLTH_ITEMS[clthActiveTab];
  items.forEach(it=>{
    const equipped=PA[clthActiveTab].id===it.id;
    const can=P.money>=it.price||it.owned;
    const card=document.createElement('div');
    card.className='clth-item'+(equipped?' clth-owned-active':'')+((!can&&!it.owned)?' clth-locked':'');
    const pr=it.price===0?'FREE':it.owned?'OWNED':'$'+it.price.toLocaleString();
    const prClass=it.price===0?'free':it.owned?'owned':'';
    card.innerHTML=`<div class="clth-swatch" style="background:${it.color==='transparent'?'rgba(255,255,255,.05)':it.color};border:1px solid rgba(255,255,255,.08)">${it.icon}</div><div class="clth-iname">${it.name}</div><div class="clth-iprice ${prClass}">${pr}</div>${equipped?'<div class="clth-badge">WORN</div>':''}`;
    if(!card.classList.contains('clth-locked')){
      card.addEventListener('click',()=>{
        if(!it.owned){
          if(P.money<it.price){showFB('NOT ENOUGH $','#c83018');return;}
          P.money-=it.price;it.owned=true;document.getElementById('hmv').textContent='$'+P.money.toLocaleString();
        }
        PA[clthActiveTab]={id:it.id,name:it.name,color:it.color};
        drawClthAvatar();updateClthEquipped();
        document.getElementById('clth-money').textContent='FUNDS: $'+P.money.toLocaleString();
        renderClthGrid();
        showFB('WEARING: '+it.name,'#e8c87a');
      });
    }
    grid.appendChild(card);
  });
}
function updateClthEquipped(){
  const el=document.getElementById('clth-equipped-list');
  el.innerHTML=`HAT: ${PA.hat.name}<br>COAT: ${PA.coat.name}<br>SKIN: ${PA.skin.name}<br>BELT: ${PA.belt.name}`;
}
function drawClthAvatar(){
  const cv=document.getElementById('clth-canvas');const cx=cv.getContext('2d');
  const cw=cv.width,ch=cv.height;cx.clearRect(0,0,cw,ch);
  // Background
  const bg=cx.createRadialGradient(cw/2,ch/2,0,cw/2,ch/2,80);
  bg.addColorStop(0,'rgba(20,10,3,.9)');bg.addColorStop(1,'rgba(5,2,1,.95)');
  cx.fillStyle=bg;cx.fillRect(0,0,cw,ch);
  // Ground shadow
  cx.fillStyle='rgba(0,0,0,.35)';cx.beginPath();cx.ellipse(cw/2+2,ch*.78,22,7,0,0,Math.PI*2);cx.fill();

  const px=cw/2,py=ch*.58,r=26;
  // Body (coat color)
  const cc=PA.coat.color;
  cx.fillStyle=cc==='transparent'?'#5A3518':cc;cx.beginPath();cx.arc(px,py,r,0,Math.PI*2);cx.fill();
  // Body shading
  cx.fillStyle='rgba(0,0,0,.28)';cx.beginPath();cx.arc(px,py,r,Math.PI*.25,Math.PI*1.75);cx.closePath();cx.fill();
  // Belt strip
  if(PA.belt.id!=='plain'){
    const bc=PA.belt.color;cx.fillStyle=bc;cx.fillRect(px-r*.65,py+r*.25,r*1.3,5);
    if(PA.belt.id==='gold'){cx.fillStyle='#d4aa00';cx.fillRect(px-5,py+r*.22,10,7);}
    if(PA.belt.id==='silver'){cx.fillStyle='#c0c0c8';cx.fillRect(px-4,py+r*.22,8,6);}
    if(PA.belt.id==='fancy'){cx.fillStyle='rgba(255,255,255,.3)';for(let i=-3;i<=3;i++){cx.beginPath();cx.arc(px+i*8,py+r*.3,2,0,Math.PI*2);cx.fill();}}
  }else{cx.fillStyle='#3a2008';cx.fillRect(px-r*.6,py+r*.28,r*1.2,4);}
  // Skin / face
  const sc=PA.skin.color;
  cx.fillStyle=sc;cx.beginPath();cx.arc(px,py-r*.1,r*.56,0,Math.PI*2);cx.fill();
  // Face details
  cx.fillStyle='rgba(0,0,0,.35)';cx.beginPath();cx.arc(px-7,py-r*.12,3,0,Math.PI*2);cx.fill();cx.beginPath();cx.arc(px+7,py-r*.12,3,0,Math.PI*2);cx.fill();
  cx.strokeStyle='rgba(0,0,0,.4)';cx.lineWidth=1.5;cx.beginPath();cx.arc(px,py-r*.04,6,0.2,Math.PI-.2);cx.stroke();
  // Hat
  const hc=PA.hat.color;
  if(PA.hat.id!=='none'&&PA.hat.id!=='bandana'){
    if(hc!=='transparent'){cx.fillStyle=hc;}
    if(PA.hat.id==='cowboy'){
      cx.beginPath();cx.ellipse(px,py-r*.67,r*.78,r*.22,0,0,Math.PI*2);cx.fill();
      cx.fillRect(px-r*.44,py-r*1.08,r*.88,r*.67);
      cx.fillStyle='rgba(255,255,255,.1)';cx.fillRect(px-r*.44,py-r*1.08,r*.88,5);
    }else if(PA.hat.id==='derby'){
      cx.beginPath();cx.ellipse(px,py-r*.67,r*.58,r*.18,0,0,Math.PI*2);cx.fill();
      cx.beginPath();cx.ellipse(px,py-r*.7,r*.44,r*.52,0,Math.PI,0);cx.fill();
    }else if(PA.hat.id==='straw'){
      cx.beginPath();cx.ellipse(px,py-r*.67,r*.82,r*.2,0,0,Math.PI*2);cx.fill();
      cx.fillStyle=hc;cx.beginPath();cx.moveTo(px-r*.4,py-r*.68);cx.lineTo(px,py-r*1.02);cx.lineTo(px+r*.4,py-r*.68);cx.fill();
    }else if(PA.hat.id==='military'){
      cx.fillRect(px-r*.42,py-r*.9,r*.84,r*.5);
      cx.beginPath();cx.ellipse(px,py-r*.92,r*.55,r*.15,0,0,Math.PI*2);cx.fill();
    }
  }else if(PA.hat.id==='bandana'){
    cx.fillStyle='#8a1010';cx.beginPath();cx.arc(px,py-r*.1,r*.62,Math.PI,0);cx.fill();
    cx.fillStyle='#6a0808';cx.fillRect(px-r*.5,py-r*.25,r,6);
  }
  // Name label
  cx.fillStyle='rgba(232,200,122,.7)';cx.font='bold 8px Georgia';cx.textAlign='center';cx.textBaseline='top';
  cx.fillText(P.name||'OUTLAW',cw/2,ch-18);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIS CODE + ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNcode(){
  ncodeOpen=true;
  document.getElementById('ncode').style.display='flex';
  document.getElementById('ncode-err').textContent='';
  const inp=document.getElementById('ncode-input');inp.value='';
  setTimeout(()=>inp.focus(),80);
}
function closeNcode(){ncodeOpen=false;document.getElementById('ncode').style.display='none';}
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('ncode-input').addEventListener('keydown',function(e){
    if(e.code==='Enter'){
      if(this.value==='11981'){
        closeNcode();P.isAdmin=true;
        sysChat('‚ö° NAVIS ACCESS GRANTED');
        showFB('‚ö° ADMIN UNLOCKED','#cc66ff');
        document.getElementById('adm-hud-btn').style.display='flex';
        openAdmin();
      }else{
        const err=document.getElementById('ncode-err');
        err.textContent='‚úó INVALID CODE ‚Äî ACCESS DENIED';
        err.style.animation='none';err.offsetHeight;err.style.animation='nShake .3s';
        this.value='';
      }
    }
    if(e.code==='Escape'){closeNcode();}
  });
});
function openAdmin(){
  if(!P.isAdmin||!gameOn)return;
  adminOpen=true;
  document.getElementById('adm-money').textContent='$'+P.money.toLocaleString();
  document.getElementById('adm-level').textContent=P.lv;
  document.getElementById('adm-hp').textContent=Math.ceil(P.hp)+'/'+P.maxHp;
  document.getElementById('adm-wanted').textContent=wanted?'‚òÖ'.repeat(wanted)+'‚òÜ'.repeat(5-wanted):'NONE';
  document.getElementById('adm').style.display='flex';
  document.getElementById('adm-hud-btn').style.display='flex';
}
function closeAdmin(){adminOpen=false;document.getElementById('adm').style.display='none';}
function admAddMoney(n){addMoney(n);openAdmin();showFB('+$'+n.toLocaleString(),'#cc66ff');}
function admFullHeal(){P.hp=P.maxHp;uiHp();openAdmin();showFB('FULL HEAL','#44ff88');}
function admClearWanted(){wanted=0;wDecay=0;uiWanted();openAdmin();showFK('WANTED CLEARED');}
function admAddXP(n){addXP(n);openAdmin();showFP('+'+n+' XP!');}
function admUnlockAll(){ALLG.forEach(g=>g.owned=true);renderShop();openAdmin();showFK('ALL GUNS UNLOCKED');}
function admAddMedkits(){P.medkits+=10;uiKits();openAdmin();showFB('+10 MEDKITS','#44aaff');}
let godMode=false;
function admGodMode(){
  godMode=!godMode;
  if(godMode){const orig=damageP;window._origDmg=orig;window.damageP=()=>{};showFB('GOD MODE ON','#ff44ff');}
  else{if(window._origDmg)window.damageP=window._origDmg;showFB('GOD MODE OFF','#888888');}
  openAdmin();
}
function admGiveRainbowGun(){
  RAINBOW_GUN.owned=true;
  equipGun('rainbow');
  P.ammo=999;P.res=9999;
  openAdmin();
  showFB('‚ö° RAINBOW GUN EQUIPPED!','#ff88ff');
}
function admKillAll(){
  npcs.forEach(n=>{if(n.alive&&n.isBounty)killNPC(n);});
  police.forEach(p=>{if(p.alive)p.alive=false;});
  riders.forEach(r=>{if(r.alive)r.alive=false;});
  openAdmin();showFK('ALL ENEMIES CLEARED');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CASINO ‚Äî BLACKJACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUITS=['‚ô†','‚ô•','‚ô¶','‚ô£'];
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
let bjDeck=[],bjPlayerHand=[],bjDealerHand=[],bjBetAmt=0,bjGamePhase='bet'; // bet | play | over
function bjNewDeck(){
  bjDeck=[];
  for(const s of SUITS)for(const r of RANKS)bjDeck.push({s,r});
  // shuffle
  for(let i=bjDeck.length-1;i>0;i--){const j=~~(Math.random()*(i+1));[bjDeck[i],bjDeck[j]]=[bjDeck[j],bjDeck[i]];}
}
function bjCardVal(r){if(['J','Q','K'].includes(r))return 10;if(r==='A')return 11;return parseInt(r);}
function bjHandVal(hand){let v=hand.reduce((s,c)=>s+bjCardVal(c.r),0),a=hand.filter(c=>c.r==='A').length;while(v>21&&a>0){v-=10;a--;}return v;}
function bjDraw(){return bjDeck.pop();}
function bjRenderCards(hand,elId,hideSecond){
  const el=document.getElementById(elId);el.innerHTML='';
  hand.forEach((c,i)=>{
    const d=document.createElement('div');
    if(hideSecond&&i===1){d.className='bj-card back';}
    else{
      const red=['‚ô•','‚ô¶'].includes(c.s);
      d.className='bj-card '+(red?'red':'blk');
      d.style.animationDelay=(i*.08)+'s';
      d.innerHTML=`<span class="bj-corner tl">${c.r}<br>${c.s}</span><span class="bj-center">${c.s}</span><span class="bj-corner br">${c.r}<br>${c.s}</span>`;
    }
    el.appendChild(d);
  });
}
function bjUpdateUI(hideDealer){
  const pv=bjHandVal(bjPlayerHand);
  const psEl=document.getElementById('player-score');
  psEl.textContent='VALUE: '+pv+(pv>21?' ‚Äî BUST!':'');
  psEl.className='bj-score '+(pv>21?'bust':pv>=18?'warn':'ok');
  if(hideDealer){document.getElementById('dealer-score').textContent='VALUE: ?';document.getElementById('dealer-score').className='bj-score';}
  else{const dv=bjHandVal(bjDealerHand);const dsEl=document.getElementById('dealer-score');dsEl.textContent='VALUE: '+dv+(dv>21?' ‚Äî BUST!':'');dsEl.className='bj-score '+(dv>21?'bust':dv>=18?'warn':'ok');}
  bjRenderCards(bjPlayerHand,'player-cards',false);
  bjRenderCards(bjDealerHand,'dealer-cards',hideDealer);
  document.getElementById('cas-money').textContent='$'+P.money.toLocaleString();
  document.getElementById('bj-curbetv').textContent='$'+bjBetAmt;
}
function openCasino(){
  casinoOpen=true;bjGamePhase='bet';bjBetAmt=0;bjPlayerHand=[];bjDealerHand=[];
  ['cas-lights-top','cas-lights-bot'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;el.innerHTML='';
    for(let i=0;i<18;i++){const l=document.createElement('div');l.className='bj-light';l.style.animationDelay=(i*.11)+'s';el.appendChild(l);}
  });
  document.getElementById('casino').style.display='flex';
  document.getElementById('bj-status').textContent='PLACE YOUR BET TO BEGIN';
  document.getElementById('bj-result').textContent='';document.getElementById('bj-result').style.color='';
  document.getElementById('player-cards').innerHTML='';
  document.getElementById('dealer-cards').innerHTML='';
  document.getElementById('player-score').textContent='';document.getElementById('player-score').className='bj-score';
  document.getElementById('dealer-score').textContent='';document.getElementById('dealer-score').className='bj-score';
  document.getElementById('bj-curbetv').textContent='$0';
  document.getElementById('cas-money').textContent='$'+P.money.toLocaleString();
  bjSetBtns(false,false,false,false,true);
}
function closeCasino(){casinoOpen=false;document.getElementById('casino').style.display='none';}
function bjSetBtns(deal,hit,stand,dbl,bet){
  document.getElementById('btn-deal').disabled=!deal;
  document.getElementById('btn-hit').disabled=!hit;
  document.getElementById('btn-stand').disabled=!stand;
  document.getElementById('btn-double').disabled=!dbl;
  document.getElementById('btn-clearbet').disabled=!bet;
}
function bjBet(n){
  if(bjGamePhase!=='bet')return;
  if(P.money<bjBetAmt+n){showFK('NOT ENOUGH MONEY');return;}
  bjBetAmt+=n;
  document.getElementById('bj-curbetv').textContent='$'+bjBetAmt;
  document.getElementById('btn-deal').disabled=(bjBetAmt===0);
}
function bjClearBet(){if(bjGamePhase!=='bet')return;bjBetAmt=0;document.getElementById('bj-curbetv').textContent='$0';document.getElementById('btn-deal').disabled=true;}
function bjDeal(){
  if(bjBetAmt===0||bjGamePhase!=='bet')return;
  if(P.money<bjBetAmt){showFK('NOT ENOUGH MONEY');return;}
  P.money-=bjBetAmt;document.getElementById('hmv').textContent='$'+P.money.toLocaleString();
  bjNewDeck();
  bjPlayerHand=[bjDraw(),bjDraw()];
  bjDealerHand=[bjDraw(),bjDraw()];
  bjGamePhase='play';
  document.getElementById('bj-status').textContent='HIT OR STAND?';
  document.getElementById('bj-result').textContent='';
  bjUpdateUI(true);
  const pv=bjHandVal(bjPlayerHand);
  if(pv===21){document.getElementById('bj-status').textContent='BLACKJACK!';bjStand();return;}
  bjSetBtns(false,true,true,P.money>=bjBetAmt,false);
}
function bjHit(){
  if(bjGamePhase!=='play')return;
  bjPlayerHand.push(bjDraw());
  bjUpdateUI(true);
  const v=bjHandVal(bjPlayerHand);
  if(v>21){bjSetBtns(false,false,false,false,false);bjEndRound();}
  else if(v===21){bjStand();}
}
function bjDouble(){
  if(bjGamePhase!=='play'||P.money<bjBetAmt)return;
  P.money-=bjBetAmt;document.getElementById('hmv').textContent='$'+P.money.toLocaleString();
  bjBetAmt*=2;bjPlayerHand.push(bjDraw());bjUpdateUI(true);
  if(bjHandVal(bjPlayerHand)>21){bjEndRound();}else{bjStand();}
}
function bjStand(){
  if(bjGamePhase!=='play')return;
  bjSetBtns(false,false,false,false,false);
  // dealer draws to 17
  while(bjHandVal(bjDealerHand)<17)bjDealerHand.push(bjDraw());
  bjUpdateUI(false);
  bjEndRound();
}
function bjEndRound(){
  bjGamePhase='over';
  bjUpdateUI(false);
  const pv=bjHandVal(bjPlayerHand),dv=bjHandVal(bjDealerHand);
  const res=document.getElementById('bj-result');
  let msg='',col='#e8c87a';
  const bjBlack=(pv===21&&bjPlayerHand.length===2);
  if(pv>21){msg='BUST ‚Äî YOU LOSE';col='#cc3333';res.style.color=col;res.textContent=msg;document.getElementById('bj-status').textContent='BETTER LUCK NEXT TIME';}
  else if(dv>21||(bjBlack&&bjHandVal(bjDealerHand)!==21)||(pv>dv)){
    const win=bjBlack?Math.floor(bjBetAmt*2.5):bjBetAmt*2;
    addMoney(win);
    msg=bjBlack?'‚ô† BLACKJACK! +$'+win:'YOU WIN! +$'+win;
    col=bjBlack?'#ffdd00':'#44cc44';
    res.style.color=col;res.textContent=msg;
    document.getElementById('bj-status').textContent=bjBlack?'DEALER PAYS 3:2':'';
  }else if(pv===dv){addMoney(bjBetAmt);msg='PUSH ‚Äî BET RETURNED';col='#e8c87a';res.style.color=col;res.textContent=msg;}
  else{msg='DEALER WINS';col='#cc3333';res.style.color=col;res.textContent=msg;document.getElementById('bj-status').textContent='THE HOUSE ALWAYS WINS...';}
  document.getElementById('cas-money').textContent='$'+P.money.toLocaleString();
  // reset for new round
  setTimeout(()=>{bjBetAmt=0;bjGamePhase='bet';bjPlayerHand=[];bjDealerHand=[];document.getElementById('bj-curbetv').textContent='$0';document.getElementById('player-cards').innerHTML='';document.getElementById('dealer-cards').innerHTML='';document.getElementById('player-score').textContent='';document.getElementById('dealer-score').textContent='';document.getElementById('bj-status').textContent='PLACE YOUR BET TO BEGIN';bjSetBtns(false,false,false,false,true);},2800);
}

// ‚îÄ‚îÄ GAME LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastT=performance.now();
function loop(){requestAnimationFrame(loop);const now=performance.now(),dt=Math.min((now-lastT)/1000,.05);lastT=now;update(dt);render();}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame(){
  document.getElementById('menu').style.display='none';document.getElementById('dead').style.display='none';
  document.getElementById('adm-hud-btn').style.display='none';
  document.getElementById('clth').style.display='none';
  clothOpen=false;
  buildCols();buildNPCs();
  P.x=0;P.y=80;P.angle=0;P.hp=100;P.maxHp=100;P.alive=true;P.money=0;P.lv=1;P.xp=0;P.medkits=0;P.mkLv=5;
  P.reloading=false;P.shootCD=0;P.dashCD=0;P.dashT=0;P.inv=0;
  ALLG.forEach(g=>{g.owned=g.id==='peacemaker';});wanted=0;wDecay=0;
  bullets.length=0;eBullets.length=0;PARTS.length=0;police.length=0;riders.length=0;respawnQ.length=0;Object.keys(REMOTES).forEach(k=>delete REMOTES[k]);
  cam.x=0;cam.y=0;TRAIN.t=0;TRAIN.cd=0;TRAIN.ntf=false;
  document.getElementById('bs').style.opacity='0';gameOn=true;
  equipGun('peacemaker');uiAmmo();uiLv();uiWanted();uiKits();document.getElementById('hmv').textContent='$0';document.getElementById('hbf').style.width='100%';
  setTimeout(()=>showFB('üíÄ DEAD WEST ROAMS SAINT CREOLE...','#cc0000'),2000);
  startMPBroadcast();
}
function soloStart(){
  const raw=document.getElementById('mpname').value;
  const trimmed=raw.trim().toUpperCase();
  P.name=trimmed||'OUTLAW';
  P.isAdmin=false;
  document.getElementById('mst').textContent='‚óè SOLO';startGame();
}
function restartGame(){stopMP();startGame();}

loop();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MULTIPLAYER  ‚Äî relay-based mesh via PeerJS
//  Architecture:
//   ‚Ä¢ First player to use a room code becomes HOST
//     (peer ID = "dw-ROOM")
//   ‚Ä¢ Later joiners get random IDs, connect to host
//   ‚Ä¢ Host acts as relay: forwards every message to
//     all other connections so all peers see all peers
//   ‚Ä¢ Each peer also calls setupHost so late joiners
//     can connect to anyone already in the room
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer=null,conns={};
let bcastInt=null;
let mpRoom='',mpIsHost=false;

function mpLog(m,c){const e=document.getElementById('mpstat');if(e){e.textContent=m;e.style.color=c||'#2e3e1c';}}
function mpHUD(m){document.getElementById('mst').textContent=m;}
function mpNick(id){return(id||'').split('-').pop().slice(0,8).toUpperCase();}

// ‚îÄ‚îÄ Connect or host ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function joinMP(){
  const name=document.getElementById('mpname').value.trim().toUpperCase()||'OUTLAW';
  const room=document.getElementById('mproom').value.trim().toUpperCase();
  if(!room){mpLog('ENTER A ROOM CODE','#c02014');return;}
  P.name=name;
  mpRoom=room;
  mpLog('CONNECTING‚Ä¶','#c8a018');
  if(peer){try{peer.destroy();}catch(e){}}
  peer=null;conns={};

  // Try to become host first
  _tryHost(room,name);
}

function _tryHost(room,name){
  const p=new Peer('dw-'+room,{debug:0});
  p.on('open',id=>{
    peer=p;mpIsHost=true;
    mpLog('HOSTING: '+room,'#38a038');
    mpHUD('‚óè HOST ¬∑ '+room+' ¬∑ '+name);
    startGame();
    _setupIncoming();
  });
  p.on('error',err=>{
    p.destroy();
    if(err.type==='unavailable-id'){
      // Room exists ‚Äî join as client
      _joinAsClient(room,name);
    } else {
      mpLog('ERROR: '+err.type,'#c02014');
    }
  });
}

function _joinAsClient(room,name){
  const suffix=Math.random().toString(36).slice(2,6);
  const p=new Peer('dw-'+room+'-'+suffix,{debug:0});
  p.on('open',id=>{
    peer=p;mpIsHost=false;
    mpLog('JOINING: '+room,'#c8a018');
    // Connect to host
    _dial('dw-'+room,true,()=>{
      mpLog('IN ROOM: '+room,'#38a038');
      mpHUD('‚óè MP ¬∑ '+room+' ¬∑ '+name);
      startGame();
      _setupIncoming();
    });
  });
  p.on('error',err=>mpLog('ERROR: '+err.type,'#c02014'));
}

// Dial a specific peer ID, optional onOpen callback
function _dial(targetId,sendHello,onOpen){
  if(conns[targetId])return;
  const c=peer.connect(targetId,{reliable:true,serialization:'json'});
  c.on('open',()=>{
    _regConn(c);
    if(sendHello){
      // Send our hello so the host knows who we are immediately
      c.send({t:'hello',id:peer.id,name:P.name});
    }
    if(onOpen)onOpen();
  });
  c.on('error',e=>mpLog('DIAL ERR: '+e.type,'#c02014'));
}

// Accept incoming connections
function _setupIncoming(){
  if(!peer)return;
  peer.on('connection',c=>{
    c.on('open',()=>{
      _regConn(c);
      // Send them the peer list so they can mesh with everyone
      const peerList=Object.keys(conns).filter(k=>k!==c.peer);
      c.send({t:'welcome',peers:peerList,hostName:P.name,hostId:peer.id});
    });
  });
}

function _regConn(c){
  if(conns[c.peer])return; // already registered
  conns[c.peer]=c;
  c.on('data',d=>_onData(d,c.peer));
  c.on('close',()=>{
    const nick=mpNick(c.peer);
    delete conns[c.peer];
    delete REMOTES[c.peer];
    sysChat(nick+' LEFT');
    mpLog(Object.keys(conns).length+' PLAYERS','#38a038');
  });
  c.on('error',()=>{delete conns[c.peer];});
}

// ‚îÄ‚îÄ Relay helper ‚Äî send to everyone except source ‚îÄ
function _relay(msg,exceptId){
  Object.entries(conns).forEach(([id,c])=>{
    if(id===exceptId)return;
    try{c.send(msg);}catch(e){}
  });
}

// ‚îÄ‚îÄ Broadcast to all ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bcast(msg){
  Object.values(conns).forEach(c=>{try{c.send(msg);}catch(e){}});
}

// ‚îÄ‚îÄ Handle incoming messages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _onData(d,from){
  if(!d||!d.t)return;
  switch(d.t){

    case 'state':
      REMOTES[from]={...d,lastSeen:Date.now()};
      // Host relays state to everyone else so full mesh visibility
      if(mpIsHost)_relay(d,from);
      break;

    case 'shoot':{
      // Spawn visual-only bullets locally
      const sd=d.d;
      if(sd){
        if(sd.sg){
          for(let i=0;i<(sd.pc||6);i++){
            const sp=(Math.random()-.5)*(sd.spr||0.2);
            bullets.push({x:sd.x,y:sd.y,vx:Math.cos(sd.a+sp)*sd.spd,vy:Math.sin(sd.a+sp)*sd.spd,life:.75,tr:[],dmg:0,sg:true});
          }
        } else {
          bullets.push({x:sd.x,y:sd.y,vx:sd.vx,vy:sd.vy,life:sd.life||1.4,tr:[],dmg:0});
        }
      }
      if(mpIsHost)_relay(d,from);
      break;
    }

    case 'kill':
      pBlood(d.x,d.y,14);pPool(d.x,d.y);cam.shake=Math.max(cam.shake,4);
      if(mpIsHost)_relay(d,from);
      break;

    case 'chat':
      addChat(d.name,d.msg);
      if(mpIsHost)_relay(d,from);
      break;

    case 'hello':
      // A new peer introduced themselves ‚Äî update their REMOTE entry with name
      if(!REMOTES[from])REMOTES[from]={};
      REMOTES[from].name=d.name;
      REMOTES[from].lastSeen=Date.now();
      sysChat(d.name+' JOINED');
      mpLog(Object.keys(conns).length+' PLAYERS','#38a038');
      break;

    case 'welcome':
      // We just joined ‚Äî connect to all peers the host told us about
      sysChat('JOINED ROOM ¬∑ '+(Object.keys(conns).length+1)+' PLAYERS');
      (d.peers||[]).forEach(pid=>{
        if(pid&&pid!==peer.id&&!conns[pid]){
          _dial(pid,true,null);
        }
      });
      mpLog(Object.keys(conns).length+' PLAYERS','#38a038');
      break;
  }
}

// ‚îÄ‚îÄ State broadcast loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startMPBroadcast(){
  if(bcastInt)clearInterval(bcastInt);
  bcastInt=setInterval(()=>{
    if(!peer||Object.keys(conns).length===0)return;
    const msg={t:'state',id:peer.id,name:P.name,
      x:~~P.x,y:~~P.y,angle:+P.angle.toFixed(2),
      hp:~~P.hp,alive:P.alive,lv:P.lv,
      coat:PA.coat.color,skin:PA.skin.color,
      hat:PA.hat.color,hatId:PA.hat.id};
    bcast(msg);
  },66);
}

// Stale remote cleanup (called from update loop)
function mpCleanStale(){
  const now=Date.now();
  Object.keys(REMOTES).forEach(k=>{
    if(now-REMOTES[k].lastSeen>8000)delete REMOTES[k];
  });
}

function mpShoot(data){if(peer&&Object.keys(conns).length)bcast({t:'shoot',d:data});}
function mpKill(x,y){if(peer&&Object.keys(conns).length)bcast({t:'kill',x:~~x,y:~~y});}
function mpSendChat(msg){addChat(P.name,msg);if(peer&&Object.keys(conns).length)bcast({t:'chat',name:P.name,msg});}
function stopMP(){
  if(bcastInt)clearInterval(bcastInt);
  bcastInt=null;
  if(peer){try{peer.destroy();}catch(e){}}
  peer=null;conns={};mpIsHost=false;mpRoom='';
  mpHUD('‚óè SOLO');
}

// ‚îÄ‚îÄ CHAT UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addChat(name,msg,sys){
  const box=document.getElementById('cmsg'),el=document.createElement('div');
  el.className='cm'+(sys?' sys':'');
  el.innerHTML=sys?msg:`<span class="cn">${name}:</span>${msg}`;
  box.appendChild(el);while(box.children.length>12)box.removeChild(box.firstChild);
  setTimeout(()=>{try{box.removeChild(el);}catch(e){}},9000);
}
function sysChat(m){addChat('',m,true);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTRO ‚Äî plays once per page load
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const intro=document.getElementById('intro');
  function dismiss(){
    if(intro._dismissed)return;intro._dismissed=true;
    intro.style.pointerEvents='none';
    intro.style.transition='opacity 0.6s';intro.style.opacity='0';
    document.getElementById('menu').style.display='flex';
    setTimeout(()=>{intro.style.display='none';},650);
  }
  setTimeout(dismiss,4500);
  intro.addEventListener('click',dismiss);
})();
</script>
</body>
</html>
